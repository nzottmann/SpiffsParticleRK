<?xml version='1.0' encoding='UTF-8' standalone='no'?>
<doxygen xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="compound.xsd" version="1.8.14">
  <compounddef id="spiffs__hydrogen_8c" kind="file" language="C++">
    <compoundname>spiffs_hydrogen.c</compoundname>
    <includes refid="spiffs_8h" local="yes">spiffs.h</includes>
    <includes refid="spiffs__nucleus_8h" local="yes">spiffs_nucleus.h</includes>
    <incdepgraph>
      <node id="70">
        <label>spiffs.h</label>
        <link refid="spiffs_8h_source"/>
        <childnode refid="71" relation="include">
        </childnode>
      </node>
      <node id="77">
        <label>spiffs_nucleus.h</label>
        <link refid="spiffs__nucleus_8h_source"/>
      </node>
      <node id="71">
        <label>spiffs_config.h</label>
        <link refid="spiffs__config_8h_source"/>
        <childnode refid="72" relation="include">
        </childnode>
        <childnode refid="73" relation="include">
        </childnode>
        <childnode refid="74" relation="include">
        </childnode>
        <childnode refid="75" relation="include">
        </childnode>
        <childnode refid="76" relation="include">
        </childnode>
      </node>
      <node id="73">
        <label>stdlib.h</label>
      </node>
      <node id="75">
        <label>stddef.h</label>
      </node>
      <node id="74">
        <label>string.h</label>
      </node>
      <node id="76">
        <label>unistd.h</label>
      </node>
      <node id="69">
        <label>src/spiffs_hydrogen.c</label>
        <link refid="spiffs__hydrogen_8c"/>
        <childnode refid="70" relation="include">
        </childnode>
        <childnode refid="77" relation="include">
        </childnode>
      </node>
      <node id="72">
        <label>stdio.h</label>
      </node>
    </incdepgraph>
      <sectiondef kind="func">
      <memberdef kind="function" id="spiffs__hydrogen_8c_1a080e2030fb14616b8712bb8b436db617" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>s32_t</type>
        <definition>static s32_t spiffs_fflush_cache</definition>
        <argsstring>(spiffs *fs, spiffs_file fh)</argsstring>
        <name>spiffs_fflush_cache</name>
        <param>
          <type><ref refid="structspiffs__t" kindref="compound">spiffs</ref> *</type>
          <declname>fs</declname>
        </param>
        <param>
          <type>spiffs_file</type>
          <declname>fh</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/spiffs_hydrogen.c" line="12" column="1" bodyfile="src/spiffs_hydrogen.c" bodystart="881" bodyend="911"/>
      </memberdef>
      <memberdef kind="function" id="spiffs__hydrogen_8c_1a6796d3c00ddb94ec1e2fe2fde2bb292a" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>u8_t</type>
        <definition>u8_t SPIFFS_mounted</definition>
        <argsstring>(spiffs *fs)</argsstring>
        <name>SPIFFS_mounted</name>
        <param>
          <type><ref refid="structspiffs__t" kindref="compound">spiffs</ref> *</type>
          <declname>fs</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Returns nonzero if spiffs is mounted, or zero if unmounted. <parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername>fs</parametername>
</parameternamelist>
<parameterdescription>
<para>the file system struct </para></parameterdescription>
</parameteritem>
</parameterlist>
</para>        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/spiffs_hydrogen.c" line="26" column="1" bodyfile="src/spiffs_hydrogen.c" bodystart="26" bodyend="28"/>
      </memberdef>
      <memberdef kind="function" id="spiffs__hydrogen_8c_1a85de96c305e5b362975ef8dceebfd9e4" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>s32_t</type>
        <definition>s32_t SPIFFS_format</definition>
        <argsstring>(spiffs *fs)</argsstring>
        <name>SPIFFS_format</name>
        <param>
          <type><ref refid="structspiffs__t" kindref="compound">spiffs</ref> *</type>
          <declname>fs</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Formats the entire file system. All data will be lost. The filesystem must not be mounted when calling this.</para><para>NB: formatting is awkward. Due to backwards compatibility, SPIFFS_mount MUST be called prior to formatting in order to configure the filesystem. If SPIFFS_mount succeeds, SPIFFS_unmount must be called before calling SPIFFS_format. If SPIFFS_mount fails, SPIFFS_format can be called directly without calling SPIFFS_unmount first.</para><para><parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername>fs</parametername>
</parameternamelist>
<parameterdescription>
<para>the file system struct </para></parameterdescription>
</parameteritem>
</parameterlist>
</para>        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/spiffs_hydrogen.c" line="30" column="1" bodyfile="src/spiffs_hydrogen.c" bodystart="30" bodyend="59"/>
      </memberdef>
      <memberdef kind="function" id="spiffs__hydrogen_8c_1a3d6371d7d19c91d06ee179a919f70da7" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>s32_t</type>
        <definition>s32_t SPIFFS_probe_fs</definition>
        <argsstring>(spiffs_config *config)</argsstring>
        <name>SPIFFS_probe_fs</name>
        <param>
          <type><ref refid="structspiffs__config" kindref="compound">spiffs_config</ref> *</type>
          <declname>config</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Special function. This takes a spiffs config struct and returns the number of blocks this file system was formatted with. This function relies on that following info is set correctly in given config struct:</para><para>phys_addr, log_page_size, and log_block_size.</para><para>Also, hal_read_f must be set in the config struct.</para><para>One must be sure of the correct page size and that the physical address is correct in the probed file system when calling this function. It is not checked if the phys_addr actually points to the start of the file system, so one might get a false positive if entering a phys_addr somewhere in the middle of the file system at block boundary. In addition, it is not checked if the page size is actually correct. If it is not, weird file system sizes will be returned.</para><para>If this function detects a file system it returns the assumed file system size, which can be used to set the phys_size.</para><para>Otherwise, it returns an error indicating why it is not regarded as a file system.</para><para>Note: this function is not protected with SPIFFS_LOCK and SPIFFS_UNLOCK macros. It returns the error code directly, instead of as read by SPIFFS_errno.</para><para><parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername>config</parametername>
</parameternamelist>
<parameterdescription>
<para>essential parts of the physical and logical configuration of the file system. </para></parameterdescription>
</parameteritem>
</parameterlist>
</para>        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/spiffs_hydrogen.c" line="63" column="1" bodyfile="src/spiffs_hydrogen.c" bodystart="63" bodyend="67"/>
      </memberdef>
      <memberdef kind="function" id="spiffs__hydrogen_8c_1a16d6f29a836803993d12b0f51e81a1e0" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>s32_t</type>
        <definition>s32_t SPIFFS_mount</definition>
        <argsstring>(spiffs *fs, spiffs_config *config, u8_t *work, u8_t *fd_space, u32_t fd_space_size, void *cache, u32_t cache_size, spiffs_check_callback check_cb_f)</argsstring>
        <name>SPIFFS_mount</name>
        <param>
          <type><ref refid="structspiffs__t" kindref="compound">spiffs</ref> *</type>
          <declname>fs</declname>
        </param>
        <param>
          <type><ref refid="structspiffs__config" kindref="compound">spiffs_config</ref> *</type>
          <declname>config</declname>
        </param>
        <param>
          <type>u8_t *</type>
          <declname>work</declname>
        </param>
        <param>
          <type>u8_t *</type>
          <declname>fd_space</declname>
        </param>
        <param>
          <type>u32_t</type>
          <declname>fd_space_size</declname>
        </param>
        <param>
          <type>void *</type>
          <declname>cache</declname>
        </param>
        <param>
          <type>u32_t</type>
          <declname>cache_size</declname>
        </param>
        <param>
          <type>spiffs_check_callback</type>
          <declname>check_cb_f</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Initializes the file system dynamic parameters and mounts the filesystem. If SPIFFS_USE_MAGIC is enabled the mounting may fail with SPIFFS_ERR_NOT_A_FS if the flash does not contain a recognizable file system. In this case, SPIFFS_format must be called prior to remounting. <parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername>fs</parametername>
</parameternamelist>
<parameterdescription>
<para>the file system struct </para></parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>config</parametername>
</parameternamelist>
<parameterdescription>
<para>the physical and logical configuration of the file system </para></parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>work</parametername>
</parameternamelist>
<parameterdescription>
<para>a memory work buffer comprising 2*config-&gt;log_page_size bytes used throughout all file system operations </para></parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>fd_space</parametername>
</parameternamelist>
<parameterdescription>
<para>memory for file descriptors </para></parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>fd_space_size</parametername>
</parameternamelist>
<parameterdescription>
<para>memory size of file descriptors </para></parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>cache</parametername>
</parameternamelist>
<parameterdescription>
<para>memory for cache, may be null </para></parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>cache_size</parametername>
</parameternamelist>
<parameterdescription>
<para>memory size of cache </para></parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>check_cb_f</parametername>
</parameternamelist>
<parameterdescription>
<para>callback function for reporting during consistency checks </para></parameterdescription>
</parameteritem>
</parameterlist>
</para>        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/spiffs_hydrogen.c" line="71" column="1" bodyfile="src/spiffs_hydrogen.c" bodystart="71" bodyend="153"/>
      </memberdef>
      <memberdef kind="function" id="spiffs__hydrogen_8c_1a98b86b521e4e51790dac322618558441" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>void</type>
        <definition>void SPIFFS_unmount</definition>
        <argsstring>(spiffs *fs)</argsstring>
        <name>SPIFFS_unmount</name>
        <param>
          <type><ref refid="structspiffs__t" kindref="compound">spiffs</ref> *</type>
          <declname>fs</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Unmounts the file system. All file handles will be flushed of any cached writes and closed. <parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername>fs</parametername>
</parameternamelist>
<parameterdescription>
<para>the file system struct </para></parameterdescription>
</parameteritem>
</parameterlist>
</para>        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/spiffs_hydrogen.c" line="155" column="1" bodyfile="src/spiffs_hydrogen.c" bodystart="155" bodyend="173"/>
      </memberdef>
      <memberdef kind="function" id="spiffs__hydrogen_8c_1a7c7c930dcabe1403be5bf5ecd57986ec" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>s32_t</type>
        <definition>s32_t SPIFFS_errno</definition>
        <argsstring>(spiffs *fs)</argsstring>
        <name>SPIFFS_errno</name>
        <param>
          <type><ref refid="structspiffs__t" kindref="compound">spiffs</ref> *</type>
          <declname>fs</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Returns last error of last file operation. <parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername>fs</parametername>
</parameternamelist>
<parameterdescription>
<para>the file system struct </para></parameterdescription>
</parameteritem>
</parameterlist>
</para>        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/spiffs_hydrogen.c" line="175" column="1" bodyfile="src/spiffs_hydrogen.c" bodystart="175" bodyend="177"/>
      </memberdef>
      <memberdef kind="function" id="spiffs__hydrogen_8c_1a5b45ea9230e7d9a73bc63f871b33b709" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>void</type>
        <definition>void SPIFFS_clearerr</definition>
        <argsstring>(spiffs *fs)</argsstring>
        <name>SPIFFS_clearerr</name>
        <param>
          <type><ref refid="structspiffs__t" kindref="compound">spiffs</ref> *</type>
          <declname>fs</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Clears last error. <parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername>fs</parametername>
</parameternamelist>
<parameterdescription>
<para>the file system struct </para></parameterdescription>
</parameteritem>
</parameterlist>
</para>        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/spiffs_hydrogen.c" line="179" column="1" bodyfile="src/spiffs_hydrogen.c" bodystart="179" bodyend="182"/>
      </memberdef>
      <memberdef kind="function" id="spiffs__hydrogen_8c_1ad653345a098d4933f63a95a1a64cb5fe" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>s32_t</type>
        <definition>s32_t SPIFFS_creat</definition>
        <argsstring>(spiffs *fs, const char *path, spiffs_mode mode)</argsstring>
        <name>SPIFFS_creat</name>
        <param>
          <type><ref refid="structspiffs__t" kindref="compound">spiffs</ref> *</type>
          <declname>fs</declname>
        </param>
        <param>
          <type>const char *</type>
          <declname>path</declname>
        </param>
        <param>
          <type>spiffs_mode</type>
          <declname>mode</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Creates a new file. <parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername>fs</parametername>
</parameternamelist>
<parameterdescription>
<para>the file system struct </para></parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>path</parametername>
</parameternamelist>
<parameterdescription>
<para>the path of the new file </para></parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>mode</parametername>
</parameternamelist>
<parameterdescription>
<para>ignored, for posix compliance </para></parameterdescription>
</parameteritem>
</parameterlist>
</para>        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/spiffs_hydrogen.c" line="184" column="1" bodyfile="src/spiffs_hydrogen.c" bodystart="184" bodyend="207"/>
      </memberdef>
      <memberdef kind="function" id="spiffs__hydrogen_8c_1ad6449ab3ad1c07b9a8ca743af4b836fa" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>spiffs_file</type>
        <definition>spiffs_file SPIFFS_open</definition>
        <argsstring>(spiffs *fs, const char *path, spiffs_flags flags, spiffs_mode mode)</argsstring>
        <name>SPIFFS_open</name>
        <param>
          <type><ref refid="structspiffs__t" kindref="compound">spiffs</ref> *</type>
          <declname>fs</declname>
        </param>
        <param>
          <type>const char *</type>
          <declname>path</declname>
        </param>
        <param>
          <type>spiffs_flags</type>
          <declname>flags</declname>
        </param>
        <param>
          <type>spiffs_mode</type>
          <declname>mode</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Opens/creates a file. <parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername>fs</parametername>
</parameternamelist>
<parameterdescription>
<para>the file system struct </para></parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>path</parametername>
</parameternamelist>
<parameterdescription>
<para>the path of the new file </para></parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>flags</parametername>
</parameternamelist>
<parameterdescription>
<para>the flags for the open command, can be combinations of SPIFFS_O_APPEND, SPIFFS_O_TRUNC, SPIFFS_O_CREAT, SPIFFS_O_RDONLY, SPIFFS_O_WRONLY, SPIFFS_O_RDWR, SPIFFS_O_DIRECT, SPIFFS_O_EXCL </para></parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>mode</parametername>
</parameternamelist>
<parameterdescription>
<para>ignored, for posix compliance </para></parameterdescription>
</parameteritem>
</parameterlist>
</para>        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/spiffs_hydrogen.c" line="209" column="1" bodyfile="src/spiffs_hydrogen.c" bodystart="209" bodyend="288"/>
      </memberdef>
      <memberdef kind="function" id="spiffs__hydrogen_8c_1a5442ec7cf9973ef1bae26753f8715b8d" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>spiffs_file</type>
        <definition>spiffs_file SPIFFS_open_by_dirent</definition>
        <argsstring>(spiffs *fs, struct spiffs_dirent *e, spiffs_flags flags, spiffs_mode mode)</argsstring>
        <name>SPIFFS_open_by_dirent</name>
        <param>
          <type><ref refid="structspiffs__t" kindref="compound">spiffs</ref> *</type>
          <declname>fs</declname>
        </param>
        <param>
          <type>struct <ref refid="structspiffs__dirent" kindref="compound">spiffs_dirent</ref> *</type>
          <declname>e</declname>
        </param>
        <param>
          <type>spiffs_flags</type>
          <declname>flags</declname>
        </param>
        <param>
          <type>spiffs_mode</type>
          <declname>mode</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Opens a file by given dir entry. Optimization purposes, when traversing a file system with SPIFFS_readdir a normal SPIFFS_open would need to traverse the filesystem again to find the file, whilst SPIFFS_open_by_dirent already knows where the file resides. <parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername>fs</parametername>
</parameternamelist>
<parameterdescription>
<para>the file system struct </para></parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>e</parametername>
</parameternamelist>
<parameterdescription>
<para>the dir entry to the file </para></parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>flags</parametername>
</parameternamelist>
<parameterdescription>
<para>the flags for the open command, can be combinations of SPIFFS_APPEND, SPIFFS_TRUNC, SPIFFS_CREAT, SPIFFS_RD_ONLY, SPIFFS_WR_ONLY, SPIFFS_RDWR, SPIFFS_DIRECT. SPIFFS_CREAT will have no effect in this case. </para></parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>mode</parametername>
</parameternamelist>
<parameterdescription>
<para>ignored, for posix compliance </para></parameterdescription>
</parameteritem>
</parameterlist>
</para>        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/spiffs_hydrogen.c" line="290" column="1" bodyfile="src/spiffs_hydrogen.c" bodystart="290" bodyend="321"/>
      </memberdef>
      <memberdef kind="function" id="spiffs__hydrogen_8c_1adc5848eb9323ebfbad6f1a94f34154f4" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>spiffs_file</type>
        <definition>spiffs_file SPIFFS_open_by_page</definition>
        <argsstring>(spiffs *fs, spiffs_page_ix page_ix, spiffs_flags flags, spiffs_mode mode)</argsstring>
        <name>SPIFFS_open_by_page</name>
        <param>
          <type><ref refid="structspiffs__t" kindref="compound">spiffs</ref> *</type>
          <declname>fs</declname>
        </param>
        <param>
          <type>spiffs_page_ix</type>
          <declname>page_ix</declname>
        </param>
        <param>
          <type>spiffs_flags</type>
          <declname>flags</declname>
        </param>
        <param>
          <type>spiffs_mode</type>
          <declname>mode</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Opens a file by given page index. Optimization purposes, opens a file by directly pointing to the page index in the spi flash. If the page index does not point to a file header SPIFFS_ERR_NOT_A_FILE is returned. <parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername>fs</parametername>
</parameternamelist>
<parameterdescription>
<para>the file system struct </para></parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>page_ix</parametername>
</parameternamelist>
<parameterdescription>
<para>the page index </para></parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>flags</parametername>
</parameternamelist>
<parameterdescription>
<para>the flags for the open command, can be combinations of SPIFFS_APPEND, SPIFFS_TRUNC, SPIFFS_CREAT, SPIFFS_RD_ONLY, SPIFFS_WR_ONLY, SPIFFS_RDWR, SPIFFS_DIRECT. SPIFFS_CREAT will have no effect in this case. </para></parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>mode</parametername>
</parameternamelist>
<parameterdescription>
<para>ignored, for posix compliance </para></parameterdescription>
</parameteritem>
</parameterlist>
</para>        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/spiffs_hydrogen.c" line="323" column="1" bodyfile="src/spiffs_hydrogen.c" bodystart="323" bodyend="368"/>
      </memberdef>
      <memberdef kind="function" id="spiffs__hydrogen_8c_1a611ab2fd0e45fc8b91c6821751fa9205" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>s32_t</type>
        <definition>static s32_t spiffs_hydro_read</definition>
        <argsstring>(spiffs *fs, spiffs_file fh, void *buf, s32_t len)</argsstring>
        <name>spiffs_hydro_read</name>
        <param>
          <type><ref refid="structspiffs__t" kindref="compound">spiffs</ref> *</type>
          <declname>fs</declname>
        </param>
        <param>
          <type>spiffs_file</type>
          <declname>fh</declname>
        </param>
        <param>
          <type>void *</type>
          <declname>buf</declname>
        </param>
        <param>
          <type>s32_t</type>
          <declname>len</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/spiffs_hydrogen.c" line="370" column="1" bodyfile="src/spiffs_hydrogen.c" bodystart="370" bodyend="422"/>
      </memberdef>
      <memberdef kind="function" id="spiffs__hydrogen_8c_1abe8899197a8c5032f7dd85f3a9f9eec6" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>s32_t</type>
        <definition>s32_t SPIFFS_read</definition>
        <argsstring>(spiffs *fs, spiffs_file fh, void *buf, s32_t len)</argsstring>
        <name>SPIFFS_read</name>
        <param>
          <type><ref refid="structspiffs__t" kindref="compound">spiffs</ref> *</type>
          <declname>fs</declname>
        </param>
        <param>
          <type>spiffs_file</type>
          <declname>fh</declname>
        </param>
        <param>
          <type>void *</type>
          <declname>buf</declname>
        </param>
        <param>
          <type>s32_t</type>
          <declname>len</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Reads from given filehandle. <parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername>fs</parametername>
</parameternamelist>
<parameterdescription>
<para>the file system struct </para></parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>fh</parametername>
</parameternamelist>
<parameterdescription>
<para>the filehandle </para></parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>buf</parametername>
</parameternamelist>
<parameterdescription>
<para>where to put read data </para></parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>len</parametername>
</parameternamelist>
<parameterdescription>
<para>how much to read </para></parameterdescription>
</parameteritem>
</parameterlist>
<simplesect kind="return"><para>number of bytes read, or -1 if error </para></simplesect>
</para>        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/spiffs_hydrogen.c" line="424" column="1" bodyfile="src/spiffs_hydrogen.c" bodystart="424" bodyend="431"/>
      </memberdef>
      <memberdef kind="function" id="spiffs__hydrogen_8c_1a35dfc35a5f766c670003c6134eefb819" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>s32_t</type>
        <definition>static s32_t spiffs_hydro_write</definition>
        <argsstring>(spiffs *fs, spiffs_fd *fd, void *buf, u32_t offset, s32_t len)</argsstring>
        <name>spiffs_hydro_write</name>
        <param>
          <type><ref refid="structspiffs__t" kindref="compound">spiffs</ref> *</type>
          <declname>fs</declname>
        </param>
        <param>
          <type><ref refid="structspiffs__fd" kindref="compound">spiffs_fd</ref> *</type>
          <declname>fd</declname>
        </param>
        <param>
          <type>void *</type>
          <declname>buf</declname>
        </param>
        <param>
          <type>u32_t</type>
          <declname>offset</declname>
        </param>
        <param>
          <type>s32_t</type>
          <declname>len</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/spiffs_hydrogen.c" line="435" column="1" bodyfile="src/spiffs_hydrogen.c" bodystart="435" bodyend="455"/>
      </memberdef>
      <memberdef kind="function" id="spiffs__hydrogen_8c_1af34f802723bd3a2e033b44c644483d39" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>s32_t</type>
        <definition>s32_t SPIFFS_write</definition>
        <argsstring>(spiffs *fs, spiffs_file fh, void *buf, s32_t len)</argsstring>
        <name>SPIFFS_write</name>
        <param>
          <type><ref refid="structspiffs__t" kindref="compound">spiffs</ref> *</type>
          <declname>fs</declname>
        </param>
        <param>
          <type>spiffs_file</type>
          <declname>fh</declname>
        </param>
        <param>
          <type>void *</type>
          <declname>buf</declname>
        </param>
        <param>
          <type>s32_t</type>
          <declname>len</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Writes to given filehandle. <parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername>fs</parametername>
</parameternamelist>
<parameterdescription>
<para>the file system struct </para></parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>fh</parametername>
</parameternamelist>
<parameterdescription>
<para>the filehandle </para></parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>buf</parametername>
</parameternamelist>
<parameterdescription>
<para>the data to write </para></parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>len</parametername>
</parameternamelist>
<parameterdescription>
<para>how much to write </para></parameterdescription>
</parameteritem>
</parameterlist>
<simplesect kind="return"><para>number of bytes written, or -1 if error </para></simplesect>
</para>        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/spiffs_hydrogen.c" line="458" column="1" bodyfile="src/spiffs_hydrogen.c" bodystart="458" bodyend="595"/>
      </memberdef>
      <memberdef kind="function" id="spiffs__hydrogen_8c_1ae396bc62e88e9846d371f16859b93e54" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>s32_t</type>
        <definition>s32_t SPIFFS_lseek</definition>
        <argsstring>(spiffs *fs, spiffs_file fh, s32_t offs, int whence)</argsstring>
        <name>SPIFFS_lseek</name>
        <param>
          <type><ref refid="structspiffs__t" kindref="compound">spiffs</ref> *</type>
          <declname>fs</declname>
        </param>
        <param>
          <type>spiffs_file</type>
          <declname>fh</declname>
        </param>
        <param>
          <type>s32_t</type>
          <declname>offs</declname>
        </param>
        <param>
          <type>int</type>
          <declname>whence</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Moves the read/write file offset. Resulting offset is returned or negative if error. lseek(fs, fd, 0, SPIFFS_SEEK_CUR) will thus return current offset. <parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername>fs</parametername>
</parameternamelist>
<parameterdescription>
<para>the file system struct </para></parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>fh</parametername>
</parameternamelist>
<parameterdescription>
<para>the filehandle </para></parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>offs</parametername>
</parameternamelist>
<parameterdescription>
<para>how much/where to move the offset </para></parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>whence</parametername>
</parameternamelist>
<parameterdescription>
<para>if SPIFFS_SEEK_SET, the file offset shall be set to offset bytes if SPIFFS_SEEK_CUR, the file offset shall be set to its current location plus offset if SPIFFS_SEEK_END, the file offset shall be set to the size of the file plus offse, which should be negative </para></parameterdescription>
</parameteritem>
</parameterlist>
</para>        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/spiffs_hydrogen.c" line="597" column="1" bodyfile="src/spiffs_hydrogen.c" bodystart="597" bodyend="647"/>
      </memberdef>
      <memberdef kind="function" id="spiffs__hydrogen_8c_1a962677491700668b80117a9e0f728b51" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>s32_t</type>
        <definition>s32_t SPIFFS_remove</definition>
        <argsstring>(spiffs *fs, const char *path)</argsstring>
        <name>SPIFFS_remove</name>
        <param>
          <type><ref refid="structspiffs__t" kindref="compound">spiffs</ref> *</type>
          <declname>fs</declname>
        </param>
        <param>
          <type>const char *</type>
          <declname>path</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Removes a file by path <parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername>fs</parametername>
</parameternamelist>
<parameterdescription>
<para>the file system struct </para></parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>path</parametername>
</parameternamelist>
<parameterdescription>
<para>the path of the file to remove </para></parameterdescription>
</parameteritem>
</parameterlist>
</para>        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/spiffs_hydrogen.c" line="649" column="1" bodyfile="src/spiffs_hydrogen.c" bodystart="649" bodyend="690"/>
      </memberdef>
      <memberdef kind="function" id="spiffs__hydrogen_8c_1a1e75f5d57aeb09fa936a1fa3d6ceb2d5" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>s32_t</type>
        <definition>s32_t SPIFFS_fremove</definition>
        <argsstring>(spiffs *fs, spiffs_file fh)</argsstring>
        <name>SPIFFS_fremove</name>
        <param>
          <type><ref refid="structspiffs__t" kindref="compound">spiffs</ref> *</type>
          <declname>fs</declname>
        </param>
        <param>
          <type>spiffs_file</type>
          <declname>fh</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Removes a file by filehandle <parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername>fs</parametername>
</parameternamelist>
<parameterdescription>
<para>the file system struct </para></parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>fh</parametername>
</parameternamelist>
<parameterdescription>
<para>the filehandle of the file to remove </para></parameterdescription>
</parameteritem>
</parameterlist>
</para>        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/spiffs_hydrogen.c" line="692" column="1" bodyfile="src/spiffs_hydrogen.c" bodystart="692" bodyend="725"/>
      </memberdef>
      <memberdef kind="function" id="spiffs__hydrogen_8c_1a85cd76066707673dd5cb1fe8d799c1b9" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>s32_t</type>
        <definition>s32_t SPIFFS_truncate</definition>
        <argsstring>(spiffs *fs, const char *path, s32_t len)</argsstring>
        <name>SPIFFS_truncate</name>
        <param>
          <type><ref refid="structspiffs__t" kindref="compound">spiffs</ref> *</type>
          <declname>fs</declname>
        </param>
        <param>
          <type>const char *</type>
          <declname>path</declname>
        </param>
        <param>
          <type>s32_t</type>
          <declname>len</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Truncate a file by path <parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername>fs</parametername>
</parameternamelist>
<parameterdescription>
<para>the file system struct </para></parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>path</parametername>
</parameternamelist>
<parameterdescription>
<para>the path of the file to remove </para></parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>len</parametername>
</parameternamelist>
<parameterdescription>
<para>the length to truncate to</para></parameterdescription>
</parameteritem>
</parameterlist>
Note: In POSIX, len can be larger than the file size to make the file larger, but this does not work in SPIFFS. len must be less than or equal to the file size. </para>        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/spiffs_hydrogen.c" line="728" column="1" bodyfile="src/spiffs_hydrogen.c" bodystart="728" bodyend="769"/>
      </memberdef>
      <memberdef kind="function" id="spiffs__hydrogen_8c_1a976ab5e379c7fa09c650f033cc2af76d" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>s32_t</type>
        <definition>s32_t SPIFFS_ftruncate</definition>
        <argsstring>(spiffs *fs, spiffs_file fh, s32_t len)</argsstring>
        <name>SPIFFS_ftruncate</name>
        <param>
          <type><ref refid="structspiffs__t" kindref="compound">spiffs</ref> *</type>
          <declname>fs</declname>
        </param>
        <param>
          <type>spiffs_file</type>
          <declname>fh</declname>
        </param>
        <param>
          <type>s32_t</type>
          <declname>len</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Truncate a file by filehandle <parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername>fs</parametername>
</parameternamelist>
<parameterdescription>
<para>the file system struct </para></parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>fh</parametername>
</parameternamelist>
<parameterdescription>
<para>the filehandle of the file to remove </para></parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>len</parametername>
</parameternamelist>
<parameterdescription>
<para>the length to truncate to</para></parameterdescription>
</parameteritem>
</parameterlist>
Note: In POSIX, len can be larger than the file size to make the file larger, but this does not work in SPIFFS. len must be less than or equal to the file size. <ulink url="https://github.com/pellepl/spiffs/issues/107">https://github.com/pellepl/spiffs/issues/107</ulink> </para>        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/spiffs_hydrogen.c" line="771" column="1" bodyfile="src/spiffs_hydrogen.c" bodystart="771" bodyend="804"/>
      </memberdef>
      <memberdef kind="function" id="spiffs__hydrogen_8c_1a28d660fc81da9385c7ca18f012e56e1e" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>s32_t</type>
        <definition>static s32_t spiffs_stat_pix</definition>
        <argsstring>(spiffs *fs, spiffs_page_ix pix, spiffs_file fh, spiffs_stat *s)</argsstring>
        <name>spiffs_stat_pix</name>
        <param>
          <type><ref refid="structspiffs__t" kindref="compound">spiffs</ref> *</type>
          <declname>fs</declname>
        </param>
        <param>
          <type>spiffs_page_ix</type>
          <declname>pix</declname>
        </param>
        <param>
          <type>spiffs_file</type>
          <declname>fh</declname>
        </param>
        <param>
          <type><ref refid="structspiffs__stat" kindref="compound">spiffs_stat</ref> *</type>
          <declname>s</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/spiffs_hydrogen.c" line="806" column="1" bodyfile="src/spiffs_hydrogen.c" bodystart="806" bodyend="830"/>
      </memberdef>
      <memberdef kind="function" id="spiffs__hydrogen_8c_1a3ac72ca8843be826ef5a77b1663ee4ac" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>s32_t</type>
        <definition>s32_t SPIFFS_stat</definition>
        <argsstring>(spiffs *fs, const char *path, spiffs_stat *s)</argsstring>
        <name>SPIFFS_stat</name>
        <param>
          <type><ref refid="structspiffs__t" kindref="compound">spiffs</ref> *</type>
          <declname>fs</declname>
        </param>
        <param>
          <type>const char *</type>
          <declname>path</declname>
        </param>
        <param>
          <type><ref refid="structspiffs__stat" kindref="compound">spiffs_stat</ref> *</type>
          <declname>s</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Gets file status by path <parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername>fs</parametername>
</parameternamelist>
<parameterdescription>
<para>the file system struct </para></parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>path</parametername>
</parameternamelist>
<parameterdescription>
<para>the path of the file to stat </para></parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>s</parametername>
</parameternamelist>
<parameterdescription>
<para>the stat struct to populate </para></parameterdescription>
</parameteritem>
</parameterlist>
</para>        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/spiffs_hydrogen.c" line="832" column="1" bodyfile="src/spiffs_hydrogen.c" bodystart="832" bodyend="852"/>
      </memberdef>
      <memberdef kind="function" id="spiffs__hydrogen_8c_1a0bfb43557c275cf88eae52dcd7b53524" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>s32_t</type>
        <definition>s32_t SPIFFS_fstat</definition>
        <argsstring>(spiffs *fs, spiffs_file fh, spiffs_stat *s)</argsstring>
        <name>SPIFFS_fstat</name>
        <param>
          <type><ref refid="structspiffs__t" kindref="compound">spiffs</ref> *</type>
          <declname>fs</declname>
        </param>
        <param>
          <type>spiffs_file</type>
          <declname>fh</declname>
        </param>
        <param>
          <type><ref refid="structspiffs__stat" kindref="compound">spiffs_stat</ref> *</type>
          <declname>s</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Gets file status by filehandle <parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername>fs</parametername>
</parameternamelist>
<parameterdescription>
<para>the file system struct </para></parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>fh</parametername>
</parameternamelist>
<parameterdescription>
<para>the filehandle of the file to stat </para></parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>s</parametername>
</parameternamelist>
<parameterdescription>
<para>the stat struct to populate </para></parameterdescription>
</parameteritem>
</parameterlist>
</para>        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/spiffs_hydrogen.c" line="854" column="1" bodyfile="src/spiffs_hydrogen.c" bodystart="854" bodyend="876"/>
      </memberdef>
      <memberdef kind="function" id="spiffs__hydrogen_8c_1ac335bf8ade9f4f8ac44123a6a608d78a" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>s32_t</type>
        <definition>s32_t SPIFFS_fflush</definition>
        <argsstring>(spiffs *fs, spiffs_file fh)</argsstring>
        <name>SPIFFS_fflush</name>
        <param>
          <type><ref refid="structspiffs__t" kindref="compound">spiffs</ref> *</type>
          <declname>fs</declname>
        </param>
        <param>
          <type>spiffs_file</type>
          <declname>fh</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Flushes all pending write operations from cache for given file <parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername>fs</parametername>
</parameternamelist>
<parameterdescription>
<para>the file system struct </para></parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>fh</parametername>
</parameternamelist>
<parameterdescription>
<para>the filehandle of the file to flush </para></parameterdescription>
</parameteritem>
</parameterlist>
</para>        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/spiffs_hydrogen.c" line="914" column="1" bodyfile="src/spiffs_hydrogen.c" bodystart="914" bodyend="929"/>
      </memberdef>
      <memberdef kind="function" id="spiffs__hydrogen_8c_1a9a9babd221dab492856c5da4fa74bf88" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>s32_t</type>
        <definition>s32_t SPIFFS_close</definition>
        <argsstring>(spiffs *fs, spiffs_file fh)</argsstring>
        <name>SPIFFS_close</name>
        <param>
          <type><ref refid="structspiffs__t" kindref="compound">spiffs</ref> *</type>
          <declname>fs</declname>
        </param>
        <param>
          <type>spiffs_file</type>
          <declname>fh</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Closes a filehandle. If there are pending write operations, these are finalized before closing. <parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername>fs</parametername>
</parameternamelist>
<parameterdescription>
<para>the file system struct </para></parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>fh</parametername>
</parameternamelist>
<parameterdescription>
<para>the filehandle of the file to close </para></parameterdescription>
</parameteritem>
</parameterlist>
</para>        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/spiffs_hydrogen.c" line="931" column="1" bodyfile="src/spiffs_hydrogen.c" bodystart="931" bodyend="950"/>
      </memberdef>
      <memberdef kind="function" id="spiffs__hydrogen_8c_1ad20d42055cb920ffca61e42f93b86611" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>s32_t</type>
        <definition>s32_t SPIFFS_rename</definition>
        <argsstring>(spiffs *fs, const char *old_path, const char *new_path)</argsstring>
        <name>SPIFFS_rename</name>
        <param>
          <type><ref refid="structspiffs__t" kindref="compound">spiffs</ref> *</type>
          <declname>fs</declname>
        </param>
        <param>
          <type>const char *</type>
          <declname>old</declname>
          <defname>old_path</defname>
        </param>
        <param>
          <type>const char *</type>
          <declname>newPath</declname>
          <defname>new_path</defname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Renames a file <parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername>fs</parametername>
</parameternamelist>
<parameterdescription>
<para>the file system struct </para></parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>old</parametername>
</parameternamelist>
<parameterdescription>
<para>path of file to rename </para></parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>newPath</parametername>
</parameternamelist>
<parameterdescription>
<para>new path of file </para></parameterdescription>
</parameteritem>
</parameterlist>
</para>        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/spiffs_hydrogen.c" line="952" column="1" bodyfile="src/spiffs_hydrogen.c" bodystart="952" bodyend="1005"/>
      </memberdef>
      <memberdef kind="function" id="spiffs__hydrogen_8c_1a116271bb88503c16c860b805368c88be" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type><ref refid="structspiffs___d_i_r" kindref="compound">spiffs_DIR</ref> *</type>
        <definition>spiffs_DIR* SPIFFS_opendir</definition>
        <argsstring>(spiffs *fs, const char *name, spiffs_DIR *d)</argsstring>
        <name>SPIFFS_opendir</name>
        <param>
          <type><ref refid="structspiffs__t" kindref="compound">spiffs</ref> *</type>
          <declname>fs</declname>
        </param>
        <param>
          <type>const char *</type>
          <declname>name</declname>
        </param>
        <param>
          <type><ref refid="structspiffs___d_i_r" kindref="compound">spiffs_DIR</ref> *</type>
          <declname>d</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Opens a directory stream corresponding to the given name. The stream is positioned at the first entry in the directory. On hydrogen builds the name argument is ignored as hydrogen builds always correspond to a flat file structure - no directories. <parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername>fs</parametername>
</parameternamelist>
<parameterdescription>
<para>the file system struct </para></parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>name</parametername>
</parameternamelist>
<parameterdescription>
<para>the name of the directory </para></parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>d</parametername>
</parameternamelist>
<parameterdescription>
<para>pointer the directory stream to be populated </para></parameterdescription>
</parameteritem>
</parameterlist>
</para>        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/spiffs_hydrogen.c" line="1079" column="1" bodyfile="src/spiffs_hydrogen.c" bodystart="1079" bodyend="1097"/>
      </memberdef>
      <memberdef kind="function" id="spiffs__hydrogen_8c_1ac6e8ac95c07509920495cb8a003fed27" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>s32_t</type>
        <definition>static s32_t spiffs_read_dir_v</definition>
        <argsstring>(spiffs *fs, spiffs_obj_id obj_id, spiffs_block_ix bix, int ix_entry, const void *user_const_p, void *user_var_p)</argsstring>
        <name>spiffs_read_dir_v</name>
        <param>
          <type><ref refid="structspiffs__t" kindref="compound">spiffs</ref> *</type>
          <declname>fs</declname>
        </param>
        <param>
          <type>spiffs_obj_id</type>
          <declname>obj_id</declname>
        </param>
        <param>
          <type>spiffs_block_ix</type>
          <declname>bix</declname>
        </param>
        <param>
          <type>int</type>
          <declname>ix_entry</declname>
        </param>
        <param>
          <type>const void *</type>
          <declname>user_const_p</declname>
        </param>
        <param>
          <type>void *</type>
          <declname>user_var_p</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/spiffs_hydrogen.c" line="1099" column="1" bodyfile="src/spiffs_hydrogen.c" bodystart="1099" bodyend="1134"/>
      </memberdef>
      <memberdef kind="function" id="spiffs__hydrogen_8c_1adb15aebc5a6add477b2f6dbf81756763" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>struct <ref refid="structspiffs__dirent" kindref="compound">spiffs_dirent</ref> *</type>
        <definition>struct spiffs_dirent* SPIFFS_readdir</definition>
        <argsstring>(spiffs_DIR *d, struct spiffs_dirent *e)</argsstring>
        <name>SPIFFS_readdir</name>
        <param>
          <type><ref refid="structspiffs___d_i_r" kindref="compound">spiffs_DIR</ref> *</type>
          <declname>d</declname>
        </param>
        <param>
          <type>struct <ref refid="structspiffs__dirent" kindref="compound">spiffs_dirent</ref> *</type>
          <declname>e</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Reads a directory into given spifs_dirent struct. <parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername>d</parametername>
</parameternamelist>
<parameterdescription>
<para>pointer to the directory stream </para></parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>e</parametername>
</parameternamelist>
<parameterdescription>
<para>the dirent struct to be populated </para></parameterdescription>
</parameteritem>
</parameterlist>
<simplesect kind="return"><para>null if error or end of stream, else given dirent is returned </para></simplesect>
</para>        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/spiffs_hydrogen.c" line="1136" column="1" bodyfile="src/spiffs_hydrogen.c" bodystart="1136" bodyend="1169"/>
      </memberdef>
      <memberdef kind="function" id="spiffs__hydrogen_8c_1a88a4782ebf1c1d37c5c2352a7700a4cf" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>s32_t</type>
        <definition>s32_t SPIFFS_closedir</definition>
        <argsstring>(spiffs_DIR *d)</argsstring>
        <name>SPIFFS_closedir</name>
        <param>
          <type><ref refid="structspiffs___d_i_r" kindref="compound">spiffs_DIR</ref> *</type>
          <declname>d</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Closes a directory stream <parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername>d</parametername>
</parameternamelist>
<parameterdescription>
<para>the directory stream to close </para></parameterdescription>
</parameteritem>
</parameterlist>
</para>        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/spiffs_hydrogen.c" line="1171" column="1" bodyfile="src/spiffs_hydrogen.c" bodystart="1171" bodyend="1176"/>
      </memberdef>
      <memberdef kind="function" id="spiffs__hydrogen_8c_1ab2a6e1f0464c8fa41535b43d597cdd26" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>s32_t</type>
        <definition>s32_t SPIFFS_check</definition>
        <argsstring>(spiffs *fs)</argsstring>
        <name>SPIFFS_check</name>
        <param>
          <type><ref refid="structspiffs__t" kindref="compound">spiffs</ref> *</type>
          <declname>fs</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Runs a consistency check on given filesystem. <parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername>fs</parametername>
</parameternamelist>
<parameterdescription>
<para>the file system struct </para></parameterdescription>
</parameteritem>
</parameterlist>
</para>        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/spiffs_hydrogen.c" line="1178" column="1" bodyfile="src/spiffs_hydrogen.c" bodystart="1178" bodyend="1200"/>
      </memberdef>
      <memberdef kind="function" id="spiffs__hydrogen_8c_1acfda216b52879b2e8b637258f319269a" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>s32_t</type>
        <definition>s32_t SPIFFS_info</definition>
        <argsstring>(spiffs *fs, u32_t *total, u32_t *used)</argsstring>
        <name>SPIFFS_info</name>
        <param>
          <type><ref refid="structspiffs__t" kindref="compound">spiffs</ref> *</type>
          <declname>fs</declname>
        </param>
        <param>
          <type>u32_t *</type>
          <declname>total</declname>
        </param>
        <param>
          <type>u32_t *</type>
          <declname>used</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Returns number of total bytes available and number of used bytes. This is an estimation, and depends on if there a many files with little data or few files with much data. NB: If used number of bytes exceeds total bytes, a SPIFFS_check should run. This indicates a power loss in midst of things. In worst case (repeated powerlosses in mending or gc) you might have to delete some files.</para><para><parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername>fs</parametername>
</parameternamelist>
<parameterdescription>
<para>the file system struct </para></parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>total</parametername>
</parameternamelist>
<parameterdescription>
<para>total number of bytes in filesystem </para></parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>used</parametername>
</parameternamelist>
<parameterdescription>
<para>used number of bytes in filesystem </para></parameterdescription>
</parameteritem>
</parameterlist>
</para>        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/spiffs_hydrogen.c" line="1202" column="1" bodyfile="src/spiffs_hydrogen.c" bodystart="1202" bodyend="1225"/>
      </memberdef>
      <memberdef kind="function" id="spiffs__hydrogen_8c_1aea9c999e519fc5ad90c1580d9835ac9f" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>s32_t</type>
        <definition>s32_t SPIFFS_gc_quick</definition>
        <argsstring>(spiffs *fs, u16_t max_free_pages)</argsstring>
        <name>SPIFFS_gc_quick</name>
        <param>
          <type><ref refid="structspiffs__t" kindref="compound">spiffs</ref> *</type>
          <declname>fs</declname>
        </param>
        <param>
          <type>u16_t</type>
          <declname>max_free_pages</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Tries to find a block where most or all pages are deleted, and erase that block if found. Does not care for wear levelling. Will not move pages around. If parameter max_free_pages are set to 0, only blocks with only deleted pages will be selected.</para><para>NB: the garbage collector is automatically called when spiffs needs free pages. The reason for this function is to give possibility to do background tidying when user knows the system is idle.</para><para>Use with care.</para><para>Setting max_free_pages to anything larger than zero will eventually wear flash more as a block containing free pages can be erased.</para><para>Will set err_no to SPIFFS_OK if a block was found and erased, SPIFFS_ERR_NO_DELETED_BLOCK if no matching block was found, or other error.</para><para><parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername>fs</parametername>
</parameternamelist>
<parameterdescription>
<para>the file system struct </para></parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>max_free_pages</parametername>
</parameternamelist>
<parameterdescription>
<para>maximum number allowed free pages in block </para></parameterdescription>
</parameteritem>
</parameterlist>
</para>        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/spiffs_hydrogen.c" line="1227" column="1" bodyfile="src/spiffs_hydrogen.c" bodystart="1227" bodyend="1244"/>
      </memberdef>
      <memberdef kind="function" id="spiffs__hydrogen_8c_1a996713c9c86267523b1fcf14e1f59ba1" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>s32_t</type>
        <definition>s32_t SPIFFS_gc</definition>
        <argsstring>(spiffs *fs, u32_t size)</argsstring>
        <name>SPIFFS_gc</name>
        <param>
          <type><ref refid="structspiffs__t" kindref="compound">spiffs</ref> *</type>
          <declname>fs</declname>
        </param>
        <param>
          <type>u32_t</type>
          <declname>size</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Will try to make room for given amount of bytes in the filesystem by moving pages and erasing blocks. If it is physically impossible, err_no will be set to SPIFFS_ERR_FULL. If there already is this amount (or more) of free space, SPIFFS_gc will silently return. It is recommended to call SPIFFS_info before invoking this method in order to determine what amount of bytes to give.</para><para>NB: the garbage collector is automatically called when spiffs needs free pages. The reason for this function is to give possibility to do background tidying when user knows the system is idle.</para><para>Use with care.</para><para><parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername>fs</parametername>
</parameternamelist>
<parameterdescription>
<para>the file system struct </para></parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>size</parametername>
</parameternamelist>
<parameterdescription>
<para>amount of bytes that should be freed </para></parameterdescription>
</parameteritem>
</parameterlist>
</para>        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/spiffs_hydrogen.c" line="1247" column="1" bodyfile="src/spiffs_hydrogen.c" bodystart="1247" bodyend="1264"/>
      </memberdef>
      <memberdef kind="function" id="spiffs__hydrogen_8c_1aa964e15f59ddd9053b78933d661282e8" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>s32_t</type>
        <definition>s32_t SPIFFS_eof</definition>
        <argsstring>(spiffs *fs, spiffs_file fh)</argsstring>
        <name>SPIFFS_eof</name>
        <param>
          <type><ref refid="structspiffs__t" kindref="compound">spiffs</ref> *</type>
          <declname>fs</declname>
        </param>
        <param>
          <type>spiffs_file</type>
          <declname>fh</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Check if EOF reached. <parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername>fs</parametername>
</parameternamelist>
<parameterdescription>
<para>the file system struct </para></parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>fh</parametername>
</parameternamelist>
<parameterdescription>
<para>the filehandle of the file to check </para></parameterdescription>
</parameteritem>
</parameterlist>
</para>        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/spiffs_hydrogen.c" line="1266" column="1" bodyfile="src/spiffs_hydrogen.c" bodystart="1266" bodyend="1288"/>
      </memberdef>
      <memberdef kind="function" id="spiffs__hydrogen_8c_1aae0d52538b75019bb6f745de8d143765" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>s32_t</type>
        <definition>s32_t SPIFFS_tell</definition>
        <argsstring>(spiffs *fs, spiffs_file fh)</argsstring>
        <name>SPIFFS_tell</name>
        <param>
          <type><ref refid="structspiffs__t" kindref="compound">spiffs</ref> *</type>
          <declname>fs</declname>
        </param>
        <param>
          <type>spiffs_file</type>
          <declname>fh</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Get position in file. <parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername>fs</parametername>
</parameternamelist>
<parameterdescription>
<para>the file system struct </para></parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>fh</parametername>
</parameternamelist>
<parameterdescription>
<para>the filehandle of the file to check </para></parameterdescription>
</parameteritem>
</parameterlist>
</para>        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/spiffs_hydrogen.c" line="1290" column="1" bodyfile="src/spiffs_hydrogen.c" bodystart="1290" bodyend="1312"/>
      </memberdef>
      <memberdef kind="function" id="spiffs__hydrogen_8c_1a10506068cc612f18ca683cdd1ea1e4fd" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>s32_t</type>
        <definition>s32_t SPIFFS_set_file_callback_func</definition>
        <argsstring>(spiffs *fs, spiffs_file_callback cb_func)</argsstring>
        <name>SPIFFS_set_file_callback_func</name>
        <param>
          <type><ref refid="structspiffs__t" kindref="compound">spiffs</ref> *</type>
          <declname>fs</declname>
        </param>
        <param>
          <type>spiffs_file_callback</type>
          <declname>cb_func</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Registers a callback function that keeps track on operations on file headers. Do note, that this callback is called from within internal spiffs mechanisms. Any operations on the actual file system being callbacked from in this callback will mess things up for sure - do not do this. This can be used to track where files are and move around during garbage collection, which in turn can be used to build location tables in ram. Used in conjuction with SPIFFS_open_by_page this may improve performance when opening a lot of files. Must be invoked after mount.</para><para><parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername>fs</parametername>
</parameternamelist>
<parameterdescription>
<para>the file system struct </para></parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>cb_func</parametername>
</parameternamelist>
<parameterdescription>
<para>the callback on file operations </para></parameterdescription>
</parameteritem>
</parameterlist>
</para>        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/spiffs_hydrogen.c" line="1314" column="1" bodyfile="src/spiffs_hydrogen.c" bodystart="1314" bodyend="1320"/>
      </memberdef>
      <memberdef kind="function" id="spiffs__hydrogen_8c_1a499bb9dcaca7b521c8c2570e05398819" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>s32_t</type>
        <definition>s32_t SPIFFS_ix_map</definition>
        <argsstring>(spiffs *fs, spiffs_file fh, spiffs_ix_map *map, u32_t offset, u32_t len, spiffs_page_ix *map_buf)</argsstring>
        <name>SPIFFS_ix_map</name>
        <param>
          <type><ref refid="structspiffs__t" kindref="compound">spiffs</ref> *</type>
          <declname>fs</declname>
        </param>
        <param>
          <type>spiffs_file</type>
          <declname>fh</declname>
        </param>
        <param>
          <type><ref refid="structspiffs__ix__map" kindref="compound">spiffs_ix_map</ref> *</type>
          <declname>map</declname>
        </param>
        <param>
          <type>u32_t</type>
          <declname>offset</declname>
        </param>
        <param>
          <type>u32_t</type>
          <declname>len</declname>
        </param>
        <param>
          <type>spiffs_page_ix *</type>
          <declname>map_buf</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Maps the first level index lookup to a given memory map. This will make reading big files faster, as the memory map will be used for looking up data pages instead of searching for the indices on the physical medium. When mapping, all affected indicies are found and the information is copied to the array. Whole file or only parts of it may be mapped. The index map will cover file contents from argument offset until and including arguments (offset+len). It is valid to map a longer range than the current file size. The map will then be populated when the file grows. On garbage collections and file data page movements, the map array will be automatically updated. Do not tamper with the map array, as this contains the references to the data pages. Modifying it from outside will corrupt any future readings using this file descriptor. The map will no longer be used when the file descriptor closed or the file is unmapped. This can be useful to get faster and more deterministic timing when reading large files, or when seeking and reading a lot within a file. <parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername>fs</parametername>
</parameternamelist>
<parameterdescription>
<para>the file system struct </para></parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>fh</parametername>
</parameternamelist>
<parameterdescription>
<para>the file handle of the file to map </para></parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>map</parametername>
</parameternamelist>
<parameterdescription>
<para>a <ref refid="structspiffs__ix__map" kindref="compound">spiffs_ix_map</ref> struct, describing the index map </para></parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>offset</parametername>
</parameternamelist>
<parameterdescription>
<para>absolute file offset where to start the index map </para></parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>len</parametername>
</parameternamelist>
<parameterdescription>
<para>length of the mapping in actual file bytes </para></parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>map_buf</parametername>
</parameternamelist>
<parameterdescription>
<para>the array buffer for the look up data - number of required elements in the array can be derived from function SPIFFS_bytes_to_ix_map_entries given the length </para></parameterdescription>
</parameteritem>
</parameterlist>
</para>        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/spiffs_hydrogen.c" line="1324" column="1" bodyfile="src/spiffs_hydrogen.c" bodystart="1324" bodyend="1356"/>
      </memberdef>
      <memberdef kind="function" id="spiffs__hydrogen_8c_1a4baa2232bff9f57cf6e4c22dd1be39ed" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>s32_t</type>
        <definition>s32_t SPIFFS_ix_unmap</definition>
        <argsstring>(spiffs *fs, spiffs_file fh)</argsstring>
        <name>SPIFFS_ix_unmap</name>
        <param>
          <type><ref refid="structspiffs__t" kindref="compound">spiffs</ref> *</type>
          <declname>fs</declname>
        </param>
        <param>
          <type>spiffs_file</type>
          <declname>fh</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Unmaps the index lookup from this filehandle. All future readings will proceed as normal, requiring reading of the first level indices from physical media. The map and map buffer given in function SPIFFS_ix_map will no longer be referenced by spiffs. It is not strictly necessary to unmap a file before closing it, as closing a file will automatically unmap it. <parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername>fs</parametername>
</parameternamelist>
<parameterdescription>
<para>the file system struct </para></parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>fh</parametername>
</parameternamelist>
<parameterdescription>
<para>the file handle of the file to unmap </para></parameterdescription>
</parameteritem>
</parameterlist>
</para>        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/spiffs_hydrogen.c" line="1358" column="1" bodyfile="src/spiffs_hydrogen.c" bodystart="1358" bodyend="1379"/>
      </memberdef>
      <memberdef kind="function" id="spiffs__hydrogen_8c_1a95b0aa10125cfc09d630598093b6f635" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>s32_t</type>
        <definition>s32_t SPIFFS_ix_remap</definition>
        <argsstring>(spiffs *fs, spiffs_file fh, u32_t offset)</argsstring>
        <name>SPIFFS_ix_remap</name>
        <param>
          <type><ref refid="structspiffs__t" kindref="compound">spiffs</ref> *</type>
          <declname>fs</declname>
        </param>
        <param>
          <type>spiffs_file</type>
          <declname>fh</declname>
        </param>
        <param>
          <type>u32_t</type>
          <declname>offs</declname>
          <defname>offset</defname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Moves the offset for the index map given in function SPIFFS_ix_map. Parts or all of the map buffer will repopulated. <parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername>fs</parametername>
</parameternamelist>
<parameterdescription>
<para>the file system struct </para></parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>fh</parametername>
</parameternamelist>
<parameterdescription>
<para>the mapped file handle of the file to remap </para></parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>offset</parametername>
</parameternamelist>
<parameterdescription>
<para>new absolute file offset where to start the index map </para></parameterdescription>
</parameteritem>
</parameterlist>
</para>        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/spiffs_hydrogen.c" line="1381" column="1" bodyfile="src/spiffs_hydrogen.c" bodystart="1381" bodyend="1442"/>
      </memberdef>
      <memberdef kind="function" id="spiffs__hydrogen_8c_1ad25309d97902ea6af6bebca7adcbf305" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>s32_t</type>
        <definition>s32_t SPIFFS_bytes_to_ix_map_entries</definition>
        <argsstring>(spiffs *fs, u32_t bytes)</argsstring>
        <name>SPIFFS_bytes_to_ix_map_entries</name>
        <param>
          <type><ref refid="structspiffs__t" kindref="compound">spiffs</ref> *</type>
          <declname>fs</declname>
        </param>
        <param>
          <type>u32_t</type>
          <declname>bytes</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Utility function to get number of spiffs_page_ix entries a map buffer must contain on order to map given amount of file data in bytes. See function SPIFFS_ix_map and SPIFFS_ix_map_entries_to_bytes. <parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername>fs</parametername>
</parameternamelist>
<parameterdescription>
<para>the file system struct </para></parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>bytes</parametername>
</parameternamelist>
<parameterdescription>
<para>number of file data bytes to map </para></parameterdescription>
</parameteritem>
</parameterlist>
<simplesect kind="return"><para>needed number of elements in a spiffs_page_ix array needed to map given amount of bytes in a file </para></simplesect>
</para>        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/spiffs_hydrogen.c" line="1444" column="1" bodyfile="src/spiffs_hydrogen.c" bodystart="1444" bodyend="1448"/>
      </memberdef>
      <memberdef kind="function" id="spiffs__hydrogen_8c_1a5191607b9e23975e9016a44ec58b3c00" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>s32_t</type>
        <definition>s32_t SPIFFS_ix_map_entries_to_bytes</definition>
        <argsstring>(spiffs *fs, u32_t map_page_ix_entries)</argsstring>
        <name>SPIFFS_ix_map_entries_to_bytes</name>
        <param>
          <type><ref refid="structspiffs__t" kindref="compound">spiffs</ref> *</type>
          <declname>fs</declname>
        </param>
        <param>
          <type>u32_t</type>
          <declname>map_page_ix_entries</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Utility function to amount of file data bytes that can be mapped when mapping a file with buffer having given number of spiffs_page_ix entries. See function SPIFFS_ix_map and SPIFFS_bytes_to_ix_map_entries. <parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername>fs</parametername>
</parameternamelist>
<parameterdescription>
<para>the file system struct </para></parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>map_page_ix_entries</parametername>
</parameternamelist>
<parameterdescription>
<para>number of entries in a spiffs_page_ix array </para></parameterdescription>
</parameteritem>
</parameterlist>
<simplesect kind="return"><para>amount of file data in bytes that can be mapped given a map buffer having given amount of spiffs_page_ix entries </para></simplesect>
</para>        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/spiffs_hydrogen.c" line="1450" column="1" bodyfile="src/spiffs_hydrogen.c" bodystart="1450" bodyend="1453"/>
      </memberdef>
      </sectiondef>
    <briefdescription>
    </briefdescription>
    <detaileddescription>
    </detaileddescription>
    <programlisting>
<codeline lineno="1"><highlight class="comment">/*</highlight></codeline>
<codeline lineno="2"><highlight class="comment"><sp/>*<sp/>spiffs_hydrogen.c</highlight></codeline>
<codeline lineno="3"><highlight class="comment"><sp/>*</highlight></codeline>
<codeline lineno="4"><highlight class="comment"><sp/>*<sp/><sp/>Created<sp/>on:<sp/>Jun<sp/>16,<sp/>2013</highlight></codeline>
<codeline lineno="5"><highlight class="comment"><sp/>*<sp/><sp/><sp/><sp/><sp/><sp/>Author:<sp/>petera</highlight></codeline>
<codeline lineno="6"><highlight class="comment"><sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="7"><highlight class="normal"></highlight></codeline>
<codeline lineno="8"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&quot;spiffs.h&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="9"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&quot;spiffs_nucleus.h&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="10"><highlight class="normal"></highlight></codeline>
<codeline lineno="11"><highlight class="normal"></highlight><highlight class="preprocessor">#if<sp/>SPIFFS_CACHE<sp/>==<sp/>1</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="12"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/>s32_t<sp/>spiffs_fflush_cache(<ref refid="structspiffs__t" kindref="compound">spiffs</ref><sp/>*fs,<sp/>spiffs_file<sp/>fh);</highlight></codeline>
<codeline lineno="13"><highlight class="normal"></highlight><highlight class="preprocessor">#endif</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="14"><highlight class="normal"></highlight></codeline>
<codeline lineno="15"><highlight class="normal"></highlight><highlight class="preprocessor">#if<sp/>SPIFFS_BUFFER_HELP</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="16"><highlight class="normal">u32_t<sp/>SPIFFS_buffer_bytes_for_filedescs(<ref refid="structspiffs__t" kindref="compound">spiffs</ref><sp/>*fs,<sp/>u32_t<sp/>num_descs)<sp/>{</highlight></codeline>
<codeline lineno="17"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>num_descs<sp/>*<sp/></highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(<ref refid="structspiffs__fd" kindref="compound">spiffs_fd</ref>);</highlight></codeline>
<codeline lineno="18"><highlight class="normal">}</highlight></codeline>
<codeline lineno="19"><highlight class="normal"></highlight><highlight class="preprocessor">#if<sp/>SPIFFS_CACHE</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="20"><highlight class="normal">u32_t<sp/>SPIFFS_buffer_bytes_for_cache(<ref refid="structspiffs__t" kindref="compound">spiffs</ref><sp/>*fs,<sp/>u32_t<sp/>num_pages)<sp/>{</highlight></codeline>
<codeline lineno="21"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(spiffs_cache)<sp/>+<sp/>num_pages<sp/>*<sp/>(</highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(spiffs_cache_page)<sp/>+<sp/>SPIFFS_CFG_LOG_PAGE_SZ(fs));</highlight></codeline>
<codeline lineno="22"><highlight class="normal">}</highlight></codeline>
<codeline lineno="23"><highlight class="normal"></highlight><highlight class="preprocessor">#endif</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="24"><highlight class="normal"></highlight><highlight class="preprocessor">#endif</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="25"><highlight class="normal"></highlight></codeline>
<codeline lineno="26"><highlight class="normal">u8_t<sp/>SPIFFS_mounted(<ref refid="structspiffs__t" kindref="compound">spiffs</ref><sp/>*fs)<sp/>{</highlight></codeline>
<codeline lineno="27"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>SPIFFS_CHECK_MOUNT(fs);</highlight></codeline>
<codeline lineno="28"><highlight class="normal">}</highlight></codeline>
<codeline lineno="29"><highlight class="normal"></highlight></codeline>
<codeline lineno="30"><highlight class="normal">s32_t<sp/>SPIFFS_format(<ref refid="structspiffs__t" kindref="compound">spiffs</ref><sp/>*fs)<sp/>{</highlight></codeline>
<codeline lineno="31"><highlight class="normal"></highlight><highlight class="preprocessor">#if<sp/>SPIFFS_READ_ONLY</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="32"><highlight class="normal"><sp/><sp/>(void)fs;</highlight></codeline>
<codeline lineno="33"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>SPIFFS_ERR_RO_NOT_IMPL;</highlight></codeline>
<codeline lineno="34"><highlight class="normal"></highlight><highlight class="preprocessor">#else</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="35"><highlight class="normal"><sp/><sp/>SPIFFS_API_CHECK_CFG(fs);</highlight></codeline>
<codeline lineno="36"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(SPIFFS_CHECK_MOUNT(fs))<sp/>{</highlight></codeline>
<codeline lineno="37"><highlight class="normal"><sp/><sp/><sp/><sp/>fs-&gt;err_code<sp/>=<sp/>SPIFFS_ERR_MOUNTED;</highlight></codeline>
<codeline lineno="38"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;</highlight></codeline>
<codeline lineno="39"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="40"><highlight class="normal"></highlight></codeline>
<codeline lineno="41"><highlight class="normal"><sp/><sp/>s32_t<sp/>res;</highlight></codeline>
<codeline lineno="42"><highlight class="normal"><sp/><sp/>SPIFFS_LOCK(fs);</highlight></codeline>
<codeline lineno="43"><highlight class="normal"></highlight></codeline>
<codeline lineno="44"><highlight class="normal"><sp/><sp/>spiffs_block_ix<sp/>bix<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="45"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">while</highlight><highlight class="normal"><sp/>(bix<sp/>&lt;<sp/>fs-&gt;block_count)<sp/>{</highlight></codeline>
<codeline lineno="46"><highlight class="normal"><sp/><sp/><sp/><sp/>fs-&gt;max_erase_count<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="47"><highlight class="normal"><sp/><sp/><sp/><sp/>res<sp/>=<sp/>spiffs_erase_block(fs,<sp/>bix);</highlight></codeline>
<codeline lineno="48"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(res<sp/>!=<sp/>SPIFFS_OK)<sp/>{</highlight></codeline>
<codeline lineno="49"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>res<sp/>=<sp/>SPIFFS_ERR_ERASE_FAIL;</highlight></codeline>
<codeline lineno="50"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="51"><highlight class="normal"><sp/><sp/><sp/><sp/>SPIFFS_API_CHECK_RES_UNLOCK(fs,<sp/>res);</highlight></codeline>
<codeline lineno="52"><highlight class="normal"><sp/><sp/><sp/><sp/>bix++;</highlight></codeline>
<codeline lineno="53"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="54"><highlight class="normal"></highlight></codeline>
<codeline lineno="55"><highlight class="normal"><sp/><sp/>SPIFFS_UNLOCK(fs);</highlight></codeline>
<codeline lineno="56"><highlight class="normal"></highlight></codeline>
<codeline lineno="57"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0;</highlight></codeline>
<codeline lineno="58"><highlight class="normal"></highlight><highlight class="preprocessor">#endif<sp/>//<sp/>SPIFFS_READ_ONLY</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="59"><highlight class="normal">}</highlight></codeline>
<codeline lineno="60"><highlight class="normal"></highlight></codeline>
<codeline lineno="61"><highlight class="normal"></highlight><highlight class="preprocessor">#if<sp/>SPIFFS_USE_MAGIC<sp/>&amp;&amp;<sp/>SPIFFS_USE_MAGIC_LENGTH<sp/>&amp;&amp;<sp/>SPIFFS_SINGLETON==0</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="62"><highlight class="normal"></highlight></codeline>
<codeline lineno="63"><highlight class="normal">s32_t<sp/>SPIFFS_probe_fs(<ref refid="structspiffs__config" kindref="compound">spiffs_config</ref><sp/>*config)<sp/>{</highlight></codeline>
<codeline lineno="64"><highlight class="normal"><sp/><sp/>SPIFFS_API_DBG(</highlight><highlight class="stringliteral">&quot;%s\n&quot;</highlight><highlight class="normal">,<sp/>__func__);</highlight></codeline>
<codeline lineno="65"><highlight class="normal"><sp/><sp/>s32_t<sp/>res<sp/>=<sp/>spiffs_probe(config);</highlight></codeline>
<codeline lineno="66"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>res;</highlight></codeline>
<codeline lineno="67"><highlight class="normal">}</highlight></codeline>
<codeline lineno="68"><highlight class="normal"></highlight></codeline>
<codeline lineno="69"><highlight class="normal"></highlight><highlight class="preprocessor">#endif<sp/>//<sp/>SPIFFS_USE_MAGIC<sp/>&amp;&amp;<sp/>SPIFFS_USE_MAGIC_LENGTH<sp/>&amp;&amp;<sp/>SPIFFS_SINGLETON==0</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="70"><highlight class="normal"></highlight></codeline>
<codeline lineno="71"><highlight class="normal">s32_t<sp/>SPIFFS_mount(<ref refid="structspiffs__t" kindref="compound">spiffs</ref><sp/>*fs,<sp/><ref refid="structspiffs__config" kindref="compound">spiffs_config</ref><sp/>*config,<sp/>u8_t<sp/>*work,</highlight></codeline>
<codeline lineno="72"><highlight class="normal"><sp/><sp/><sp/><sp/>u8_t<sp/>*fd_space,<sp/>u32_t<sp/>fd_space_size,</highlight></codeline>
<codeline lineno="73"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>*cache,<sp/>u32_t<sp/>cache_size,</highlight></codeline>
<codeline lineno="74"><highlight class="normal"><sp/><sp/><sp/><sp/>spiffs_check_callback<sp/>check_cb_f)<sp/>{</highlight></codeline>
<codeline lineno="75"><highlight class="normal"><sp/><sp/>SPIFFS_API_DBG(</highlight><highlight class="stringliteral">&quot;%s<sp/>&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="76"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;<sp/>sz:&quot;</highlight><highlight class="normal">_SPIPRIi<sp/></highlight><highlight class="stringliteral">&quot;<sp/>logpgsz:&quot;</highlight><highlight class="normal">_SPIPRIi<sp/></highlight><highlight class="stringliteral">&quot;<sp/>logblksz:&quot;</highlight><highlight class="normal">_SPIPRIi<sp/></highlight><highlight class="stringliteral">&quot;<sp/>perasz:&quot;</highlight><highlight class="normal">_SPIPRIi</highlight></codeline>
<codeline lineno="77"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;<sp/>addr:&quot;</highlight><highlight class="normal">_SPIPRIad</highlight></codeline>
<codeline lineno="78"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;<sp/>fdsz:&quot;</highlight><highlight class="normal">_SPIPRIi<sp/></highlight><highlight class="stringliteral">&quot;<sp/>cachesz:&quot;</highlight><highlight class="normal">_SPIPRIi</highlight></codeline>
<codeline lineno="79"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;\n&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="80"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>__func__,</highlight></codeline>
<codeline lineno="81"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>SPIFFS_CFG_PHYS_SZ(fs),</highlight></codeline>
<codeline lineno="82"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>SPIFFS_CFG_LOG_PAGE_SZ(fs),</highlight></codeline>
<codeline lineno="83"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>SPIFFS_CFG_LOG_BLOCK_SZ(fs),</highlight></codeline>
<codeline lineno="84"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>SPIFFS_CFG_PHYS_ERASE_SZ(fs),</highlight></codeline>
<codeline lineno="85"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>SPIFFS_CFG_PHYS_ADDR(fs),</highlight></codeline>
<codeline lineno="86"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>fd_space_size,<sp/>cache_size);</highlight></codeline>
<codeline lineno="87"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>*user_data;</highlight></codeline>
<codeline lineno="88"><highlight class="normal"><sp/><sp/>SPIFFS_LOCK(fs);</highlight></codeline>
<codeline lineno="89"><highlight class="normal"><sp/><sp/>user_data<sp/>=<sp/>fs-&gt;user_data;</highlight></codeline>
<codeline lineno="90"><highlight class="normal"><sp/><sp/>memset(fs,<sp/>0,<sp/></highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(<ref refid="structspiffs__t" kindref="compound">spiffs</ref>));</highlight></codeline>
<codeline lineno="91"><highlight class="normal"><sp/><sp/>_SPIFFS_MEMCPY(&amp;fs-&gt;cfg,<sp/>config,<sp/></highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(<ref refid="structspiffs__config" kindref="compound">spiffs_config</ref>));</highlight></codeline>
<codeline lineno="92"><highlight class="normal"><sp/><sp/>fs-&gt;user_data<sp/>=<sp/>user_data;</highlight></codeline>
<codeline lineno="93"><highlight class="normal"><sp/><sp/>fs-&gt;block_count<sp/>=<sp/>SPIFFS_CFG_PHYS_SZ(fs)<sp/>/<sp/>SPIFFS_CFG_LOG_BLOCK_SZ(fs);</highlight></codeline>
<codeline lineno="94"><highlight class="normal"><sp/><sp/>fs-&gt;work<sp/>=<sp/>&amp;work[0];</highlight></codeline>
<codeline lineno="95"><highlight class="normal"><sp/><sp/>fs-&gt;lu_work<sp/>=<sp/>&amp;work[SPIFFS_CFG_LOG_PAGE_SZ(fs)];</highlight></codeline>
<codeline lineno="96"><highlight class="normal"><sp/><sp/>memset(fd_space,<sp/>0,<sp/>fd_space_size);</highlight></codeline>
<codeline lineno="97"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>align<sp/>fd_space<sp/>pointer<sp/>to<sp/>pointer<sp/>size<sp/>byte<sp/>boundary</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="98"><highlight class="normal"><sp/><sp/>u8_t<sp/>ptr_size<sp/>=<sp/></highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(</highlight><highlight class="keywordtype">void</highlight><highlight class="normal">*);</highlight></codeline>
<codeline lineno="99"><highlight class="normal"><sp/><sp/>u8_t<sp/>addr_lsb<sp/>=<sp/>((u8_t)(intptr_t)fd_space)<sp/>&amp;<sp/>(ptr_size-1);</highlight></codeline>
<codeline lineno="100"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(addr_lsb)<sp/>{</highlight></codeline>
<codeline lineno="101"><highlight class="normal"><sp/><sp/><sp/><sp/>fd_space<sp/>+=<sp/>(ptr_size-addr_lsb);</highlight></codeline>
<codeline lineno="102"><highlight class="normal"><sp/><sp/><sp/><sp/>fd_space_size<sp/>-=<sp/>(ptr_size-addr_lsb);</highlight></codeline>
<codeline lineno="103"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="104"><highlight class="normal"><sp/><sp/>fs-&gt;fd_space<sp/>=<sp/>fd_space;</highlight></codeline>
<codeline lineno="105"><highlight class="normal"><sp/><sp/>fs-&gt;fd_count<sp/>=<sp/>(fd_space_size/</highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(<ref refid="structspiffs__fd" kindref="compound">spiffs_fd</ref>));</highlight></codeline>
<codeline lineno="106"><highlight class="normal"></highlight></codeline>
<codeline lineno="107"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>align<sp/>cache<sp/>pointer<sp/>to<sp/>4<sp/>byte<sp/>boundary</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="108"><highlight class="normal"><sp/><sp/>addr_lsb<sp/>=<sp/>((u8_t)(intptr_t)cache)<sp/>&amp;<sp/>(ptr_size-1);</highlight></codeline>
<codeline lineno="109"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(addr_lsb)<sp/>{</highlight></codeline>
<codeline lineno="110"><highlight class="normal"><sp/><sp/><sp/><sp/>u8_t<sp/>*cache_8<sp/>=<sp/>(u8_t<sp/>*)cache;</highlight></codeline>
<codeline lineno="111"><highlight class="normal"><sp/><sp/><sp/><sp/>cache_8<sp/>+=<sp/>(ptr_size-addr_lsb);</highlight></codeline>
<codeline lineno="112"><highlight class="normal"><sp/><sp/><sp/><sp/>cache<sp/>=<sp/>cache_8;</highlight></codeline>
<codeline lineno="113"><highlight class="normal"><sp/><sp/><sp/><sp/>cache_size<sp/>-=<sp/>(ptr_size-addr_lsb);</highlight></codeline>
<codeline lineno="114"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="115"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(cache_size<sp/>&amp;<sp/>(ptr_size-1))<sp/>{</highlight></codeline>
<codeline lineno="116"><highlight class="normal"><sp/><sp/><sp/><sp/>cache_size<sp/>-=<sp/>(cache_size<sp/>&amp;<sp/>(ptr_size-1));</highlight></codeline>
<codeline lineno="117"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="118"><highlight class="normal"></highlight></codeline>
<codeline lineno="119"><highlight class="normal"></highlight><highlight class="preprocessor">#if<sp/>SPIFFS_CACHE</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="120"><highlight class="normal"><sp/><sp/>fs-&gt;cache<sp/>=<sp/>cache;</highlight></codeline>
<codeline lineno="121"><highlight class="normal"><sp/><sp/>fs-&gt;cache_size<sp/>=<sp/>(cache_size<sp/>&gt;<sp/>(SPIFFS_CFG_LOG_PAGE_SZ(fs)*32))<sp/>?<sp/>SPIFFS_CFG_LOG_PAGE_SZ(fs)*32<sp/>:<sp/>cache_size;</highlight></codeline>
<codeline lineno="122"><highlight class="normal"><sp/><sp/>spiffs_cache_init(fs);</highlight></codeline>
<codeline lineno="123"><highlight class="normal"></highlight><highlight class="preprocessor">#endif</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="124"><highlight class="normal"></highlight></codeline>
<codeline lineno="125"><highlight class="normal"><sp/><sp/>s32_t<sp/>res;</highlight></codeline>
<codeline lineno="126"><highlight class="normal"></highlight></codeline>
<codeline lineno="127"><highlight class="normal"></highlight><highlight class="preprocessor">#if<sp/>SPIFFS_USE_MAGIC</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="128"><highlight class="normal"><sp/><sp/>res<sp/>=<sp/>SPIFFS_CHECK_MAGIC_POSSIBLE(fs)<sp/>?<sp/>SPIFFS_OK<sp/>:<sp/>SPIFFS_ERR_MAGIC_NOT_POSSIBLE;</highlight></codeline>
<codeline lineno="129"><highlight class="normal"><sp/><sp/>SPIFFS_API_CHECK_RES_UNLOCK(fs,<sp/>res);</highlight></codeline>
<codeline lineno="130"><highlight class="normal"></highlight><highlight class="preprocessor">#endif</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="131"><highlight class="normal"></highlight></codeline>
<codeline lineno="132"><highlight class="normal"><sp/><sp/>fs-&gt;config_magic<sp/>=<sp/>SPIFFS_CONFIG_MAGIC;</highlight></codeline>
<codeline lineno="133"><highlight class="normal"></highlight></codeline>
<codeline lineno="134"><highlight class="normal"><sp/><sp/>res<sp/>=<sp/>spiffs_obj_lu_scan(fs);</highlight></codeline>
<codeline lineno="135"><highlight class="normal"><sp/><sp/>SPIFFS_API_CHECK_RES_UNLOCK(fs,<sp/>res);</highlight></codeline>
<codeline lineno="136"><highlight class="normal"></highlight></codeline>
<codeline lineno="137"><highlight class="normal"><sp/><sp/>SPIFFS_DBG(</highlight><highlight class="stringliteral">&quot;page<sp/>index<sp/>byte<sp/>len:<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>&quot;</highlight><highlight class="normal">_SPIPRIi</highlight><highlight class="stringliteral">&quot;\n&quot;</highlight><highlight class="normal">,<sp/>(u32_t)SPIFFS_CFG_LOG_PAGE_SZ(fs));</highlight></codeline>
<codeline lineno="138"><highlight class="normal"><sp/><sp/>SPIFFS_DBG(</highlight><highlight class="stringliteral">&quot;object<sp/>lookup<sp/>pages:<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>&quot;</highlight><highlight class="normal">_SPIPRIi</highlight><highlight class="stringliteral">&quot;\n&quot;</highlight><highlight class="normal">,<sp/>(u32_t)SPIFFS_OBJ_LOOKUP_PAGES(fs));</highlight></codeline>
<codeline lineno="139"><highlight class="normal"><sp/><sp/>SPIFFS_DBG(</highlight><highlight class="stringliteral">&quot;page<sp/>pages<sp/>per<sp/>block:<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>&quot;</highlight><highlight class="normal">_SPIPRIi</highlight><highlight class="stringliteral">&quot;\n&quot;</highlight><highlight class="normal">,<sp/>(u32_t)SPIFFS_PAGES_PER_BLOCK(fs));</highlight></codeline>
<codeline lineno="140"><highlight class="normal"><sp/><sp/>SPIFFS_DBG(</highlight><highlight class="stringliteral">&quot;page<sp/>header<sp/>length:<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>&quot;</highlight><highlight class="normal">_SPIPRIi</highlight><highlight class="stringliteral">&quot;\n&quot;</highlight><highlight class="normal">,<sp/>(u32_t)</highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(<ref refid="struct_s_p_i_f_f_s___p_a_c_k_e_d" kindref="compound">spiffs_page_header</ref>));</highlight></codeline>
<codeline lineno="141"><highlight class="normal"><sp/><sp/>SPIFFS_DBG(</highlight><highlight class="stringliteral">&quot;object<sp/>header<sp/>index<sp/>entries:<sp/>&quot;</highlight><highlight class="normal">_SPIPRIi</highlight><highlight class="stringliteral">&quot;\n&quot;</highlight><highlight class="normal">,<sp/>(u32_t)SPIFFS_OBJ_HDR_IX_LEN(fs));</highlight></codeline>
<codeline lineno="142"><highlight class="normal"><sp/><sp/>SPIFFS_DBG(</highlight><highlight class="stringliteral">&quot;object<sp/>index<sp/>entries:<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>&quot;</highlight><highlight class="normal">_SPIPRIi</highlight><highlight class="stringliteral">&quot;\n&quot;</highlight><highlight class="normal">,<sp/>(u32_t)SPIFFS_OBJ_IX_LEN(fs));</highlight></codeline>
<codeline lineno="143"><highlight class="normal"><sp/><sp/>SPIFFS_DBG(</highlight><highlight class="stringliteral">&quot;available<sp/>file<sp/>descriptors:<sp/><sp/>&quot;</highlight><highlight class="normal">_SPIPRIi</highlight><highlight class="stringliteral">&quot;\n&quot;</highlight><highlight class="normal">,<sp/>(u32_t)fs-&gt;fd_count);</highlight></codeline>
<codeline lineno="144"><highlight class="normal"><sp/><sp/>SPIFFS_DBG(</highlight><highlight class="stringliteral">&quot;free<sp/>blocks:<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>&quot;</highlight><highlight class="normal">_SPIPRIi</highlight><highlight class="stringliteral">&quot;\n&quot;</highlight><highlight class="normal">,<sp/>(u32_t)fs-&gt;free_blocks);</highlight></codeline>
<codeline lineno="145"><highlight class="normal"></highlight></codeline>
<codeline lineno="146"><highlight class="normal"><sp/><sp/>fs-&gt;check_cb_f<sp/>=<sp/>check_cb_f;</highlight></codeline>
<codeline lineno="147"><highlight class="normal"></highlight></codeline>
<codeline lineno="148"><highlight class="normal"><sp/><sp/>fs-&gt;mounted<sp/>=<sp/>1;</highlight></codeline>
<codeline lineno="149"><highlight class="normal"></highlight></codeline>
<codeline lineno="150"><highlight class="normal"><sp/><sp/>SPIFFS_UNLOCK(fs);</highlight></codeline>
<codeline lineno="151"><highlight class="normal"></highlight></codeline>
<codeline lineno="152"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0;</highlight></codeline>
<codeline lineno="153"><highlight class="normal">}</highlight></codeline>
<codeline lineno="154"><highlight class="normal"></highlight></codeline>
<codeline lineno="155"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>SPIFFS_unmount(<ref refid="structspiffs__t" kindref="compound">spiffs</ref><sp/>*fs)<sp/>{</highlight></codeline>
<codeline lineno="156"><highlight class="normal"><sp/><sp/>SPIFFS_API_DBG(</highlight><highlight class="stringliteral">&quot;%s\n&quot;</highlight><highlight class="normal">,<sp/>__func__);</highlight></codeline>
<codeline lineno="157"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!SPIFFS_CHECK_CFG(fs)<sp/>||<sp/>!SPIFFS_CHECK_MOUNT(fs))<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="158"><highlight class="normal"><sp/><sp/>SPIFFS_LOCK(fs);</highlight></codeline>
<codeline lineno="159"><highlight class="normal"><sp/><sp/>u32_t<sp/>i;</highlight></codeline>
<codeline lineno="160"><highlight class="normal"><sp/><sp/><ref refid="structspiffs__fd" kindref="compound">spiffs_fd</ref><sp/>*fds<sp/>=<sp/>(<ref refid="structspiffs__fd" kindref="compound">spiffs_fd</ref><sp/>*)fs-&gt;fd_space;</highlight></codeline>
<codeline lineno="161"><highlight class="normal"><sp/><sp/>for<sp/>(i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>fs-&gt;fd_count;<sp/>i++)<sp/>{</highlight></codeline>
<codeline lineno="162"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="structspiffs__fd" kindref="compound">spiffs_fd</ref><sp/>*cur_fd<sp/>=<sp/>&amp;fds[i];</highlight></codeline>
<codeline lineno="163"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(cur_fd-&gt;file_nbr<sp/>!=<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="164"><highlight class="normal"></highlight><highlight class="preprocessor">#if<sp/>SPIFFS_CACHE</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="165"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>(void)spiffs_fflush_cache(fs,<sp/>cur_fd-&gt;file_nbr);</highlight></codeline>
<codeline lineno="166"><highlight class="normal"></highlight><highlight class="preprocessor">#endif</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="167"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>spiffs_fd_return(fs,<sp/>cur_fd-&gt;file_nbr);</highlight></codeline>
<codeline lineno="168"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="169"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="170"><highlight class="normal"><sp/><sp/>fs-&gt;mounted<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="171"><highlight class="normal"></highlight></codeline>
<codeline lineno="172"><highlight class="normal"><sp/><sp/>SPIFFS_UNLOCK(fs);</highlight></codeline>
<codeline lineno="173"><highlight class="normal">}</highlight></codeline>
<codeline lineno="174"><highlight class="normal"></highlight></codeline>
<codeline lineno="175"><highlight class="normal">s32_t<sp/>SPIFFS_errno(<ref refid="structspiffs__t" kindref="compound">spiffs</ref><sp/>*fs)<sp/>{</highlight></codeline>
<codeline lineno="176"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>fs-&gt;err_code;</highlight></codeline>
<codeline lineno="177"><highlight class="normal">}</highlight></codeline>
<codeline lineno="178"><highlight class="normal"></highlight></codeline>
<codeline lineno="179"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>SPIFFS_clearerr(<ref refid="structspiffs__t" kindref="compound">spiffs</ref><sp/>*fs)<sp/>{</highlight></codeline>
<codeline lineno="180"><highlight class="normal"><sp/><sp/>SPIFFS_API_DBG(</highlight><highlight class="stringliteral">&quot;%s\n&quot;</highlight><highlight class="normal">,<sp/>__func__);</highlight></codeline>
<codeline lineno="181"><highlight class="normal"><sp/><sp/>fs-&gt;err_code<sp/>=<sp/>SPIFFS_OK;</highlight></codeline>
<codeline lineno="182"><highlight class="normal">}</highlight></codeline>
<codeline lineno="183"><highlight class="normal"></highlight></codeline>
<codeline lineno="184"><highlight class="normal">s32_t<sp/>SPIFFS_creat(<ref refid="structspiffs__t" kindref="compound">spiffs</ref><sp/>*fs,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*path,<sp/>spiffs_mode<sp/>mode)<sp/>{</highlight></codeline>
<codeline lineno="185"><highlight class="normal"><sp/><sp/>SPIFFS_API_DBG(</highlight><highlight class="stringliteral">&quot;%s<sp/>&apos;%s&apos;\n&quot;</highlight><highlight class="normal">,<sp/>__func__,<sp/>path);</highlight></codeline>
<codeline lineno="186"><highlight class="normal"></highlight><highlight class="preprocessor">#if<sp/>SPIFFS_READ_ONLY</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="187"><highlight class="normal"><sp/><sp/>(void)fs;<sp/>(void)path;<sp/>(void)mode;</highlight></codeline>
<codeline lineno="188"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>SPIFFS_ERR_RO_NOT_IMPL;</highlight></codeline>
<codeline lineno="189"><highlight class="normal"></highlight><highlight class="preprocessor">#else</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="190"><highlight class="normal"><sp/><sp/>(void)mode;</highlight></codeline>
<codeline lineno="191"><highlight class="normal"><sp/><sp/>SPIFFS_API_CHECK_CFG(fs);</highlight></codeline>
<codeline lineno="192"><highlight class="normal"><sp/><sp/>SPIFFS_API_CHECK_MOUNT(fs);</highlight></codeline>
<codeline lineno="193"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(strlen(path)<sp/>&gt;<sp/>SPIFFS_OBJ_NAME_LEN<sp/>-<sp/>1)<sp/>{</highlight></codeline>
<codeline lineno="194"><highlight class="normal"><sp/><sp/><sp/><sp/>SPIFFS_API_CHECK_RES(fs,<sp/>SPIFFS_ERR_NAME_TOO_LONG);</highlight></codeline>
<codeline lineno="195"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="196"><highlight class="normal"><sp/><sp/>SPIFFS_LOCK(fs);</highlight></codeline>
<codeline lineno="197"><highlight class="normal"><sp/><sp/>spiffs_obj_id<sp/>obj_id;</highlight></codeline>
<codeline lineno="198"><highlight class="normal"><sp/><sp/>s32_t<sp/>res;</highlight></codeline>
<codeline lineno="199"><highlight class="normal"></highlight></codeline>
<codeline lineno="200"><highlight class="normal"><sp/><sp/>res<sp/>=<sp/>spiffs_obj_lu_find_free_obj_id(fs,<sp/>&amp;obj_id,<sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>u8_t*)path);</highlight></codeline>
<codeline lineno="201"><highlight class="normal"><sp/><sp/>SPIFFS_API_CHECK_RES_UNLOCK(fs,<sp/>res);</highlight></codeline>
<codeline lineno="202"><highlight class="normal"><sp/><sp/>res<sp/>=<sp/>spiffs_object_create(fs,<sp/>obj_id,<sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>u8_t*)path,<sp/>0,<sp/>SPIFFS_TYPE_FILE,<sp/>0);</highlight></codeline>
<codeline lineno="203"><highlight class="normal"><sp/><sp/>SPIFFS_API_CHECK_RES_UNLOCK(fs,<sp/>res);</highlight></codeline>
<codeline lineno="204"><highlight class="normal"><sp/><sp/>SPIFFS_UNLOCK(fs);</highlight></codeline>
<codeline lineno="205"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0;</highlight></codeline>
<codeline lineno="206"><highlight class="normal"></highlight><highlight class="preprocessor">#endif<sp/>//<sp/>SPIFFS_READ_ONLY</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="207"><highlight class="normal">}</highlight></codeline>
<codeline lineno="208"><highlight class="normal"></highlight></codeline>
<codeline lineno="209"><highlight class="normal">spiffs_file<sp/>SPIFFS_open(<ref refid="structspiffs__t" kindref="compound">spiffs</ref><sp/>*fs,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*path,<sp/>spiffs_flags<sp/>flags,<sp/>spiffs_mode<sp/>mode)<sp/>{</highlight></codeline>
<codeline lineno="210"><highlight class="normal"><sp/><sp/>SPIFFS_API_DBG(</highlight><highlight class="stringliteral">&quot;%s<sp/>&apos;%s&apos;<sp/>&quot;</highlight><highlight class="normal">_SPIPRIfl<sp/></highlight><highlight class="stringliteral">&quot;\n&quot;</highlight><highlight class="normal">,<sp/>__func__,<sp/>path,<sp/>flags);</highlight></codeline>
<codeline lineno="211"><highlight class="normal"><sp/><sp/>(void)mode;</highlight></codeline>
<codeline lineno="212"><highlight class="normal"><sp/><sp/>SPIFFS_API_CHECK_CFG(fs);</highlight></codeline>
<codeline lineno="213"><highlight class="normal"><sp/><sp/>SPIFFS_API_CHECK_MOUNT(fs);</highlight></codeline>
<codeline lineno="214"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(strlen(path)<sp/>&gt;<sp/>SPIFFS_OBJ_NAME_LEN<sp/>-<sp/>1)<sp/>{</highlight></codeline>
<codeline lineno="215"><highlight class="normal"><sp/><sp/><sp/><sp/>SPIFFS_API_CHECK_RES(fs,<sp/>SPIFFS_ERR_NAME_TOO_LONG);</highlight></codeline>
<codeline lineno="216"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="217"><highlight class="normal"><sp/><sp/>SPIFFS_LOCK(fs);</highlight></codeline>
<codeline lineno="218"><highlight class="normal"></highlight></codeline>
<codeline lineno="219"><highlight class="normal"><sp/><sp/><ref refid="structspiffs__fd" kindref="compound">spiffs_fd</ref><sp/>*fd;</highlight></codeline>
<codeline lineno="220"><highlight class="normal"><sp/><sp/>spiffs_page_ix<sp/>pix;</highlight></codeline>
<codeline lineno="221"><highlight class="normal"></highlight></codeline>
<codeline lineno="222"><highlight class="normal"></highlight><highlight class="preprocessor">#if<sp/>SPIFFS_READ_ONLY</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="223"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>not<sp/>valid<sp/>flags<sp/>in<sp/>read<sp/>only<sp/>mode</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="224"><highlight class="normal"><sp/><sp/>flags<sp/>&amp;=<sp/>~(SPIFFS_WRONLY<sp/>|<sp/>SPIFFS_CREAT<sp/>|<sp/>SPIFFS_TRUNC);</highlight></codeline>
<codeline lineno="225"><highlight class="normal"></highlight><highlight class="preprocessor">#endif<sp/>//<sp/>SPIFFS_READ_ONLY</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="226"><highlight class="normal"></highlight></codeline>
<codeline lineno="227"><highlight class="normal"><sp/><sp/>s32_t<sp/>res<sp/>=<sp/>spiffs_fd_find_new(fs,<sp/>&amp;fd,<sp/>path);</highlight></codeline>
<codeline lineno="228"><highlight class="normal"><sp/><sp/>SPIFFS_API_CHECK_RES_UNLOCK(fs,<sp/>res);</highlight></codeline>
<codeline lineno="229"><highlight class="normal"></highlight></codeline>
<codeline lineno="230"><highlight class="normal"><sp/><sp/>res<sp/>=<sp/>spiffs_object_find_object_index_header_by_name(fs,<sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>u8_t*)path,<sp/>&amp;pix);</highlight></codeline>
<codeline lineno="231"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>((flags<sp/>&amp;<sp/>SPIFFS_O_CREAT)<sp/>==<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="232"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(res<sp/>&lt;<sp/>SPIFFS_OK)<sp/>{</highlight></codeline>
<codeline lineno="233"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>spiffs_fd_return(fs,<sp/>fd-&gt;file_nbr);</highlight></codeline>
<codeline lineno="234"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="235"><highlight class="normal"><sp/><sp/><sp/><sp/>SPIFFS_API_CHECK_RES_UNLOCK(fs,<sp/>res);</highlight></codeline>
<codeline lineno="236"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="237"><highlight class="normal"></highlight></codeline>
<codeline lineno="238"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(res<sp/>==<sp/>SPIFFS_OK<sp/>&amp;&amp;</highlight></codeline>
<codeline lineno="239"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>(flags<sp/>&amp;<sp/>(SPIFFS_O_CREAT<sp/>|<sp/>SPIFFS_O_EXCL))<sp/>==<sp/>(SPIFFS_O_CREAT<sp/>|<sp/>SPIFFS_O_EXCL))<sp/>{</highlight></codeline>
<codeline lineno="240"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>creat<sp/>and<sp/>excl<sp/>and<sp/>file<sp/>exists<sp/>-<sp/>fail</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="241"><highlight class="normal"><sp/><sp/><sp/><sp/>res<sp/>=<sp/>SPIFFS_ERR_FILE_EXISTS;</highlight></codeline>
<codeline lineno="242"><highlight class="normal"><sp/><sp/><sp/><sp/>spiffs_fd_return(fs,<sp/>fd-&gt;file_nbr);</highlight></codeline>
<codeline lineno="243"><highlight class="normal"><sp/><sp/><sp/><sp/>SPIFFS_API_CHECK_RES_UNLOCK(fs,<sp/>res);</highlight></codeline>
<codeline lineno="244"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="245"><highlight class="normal"></highlight></codeline>
<codeline lineno="246"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>((flags<sp/>&amp;<sp/>SPIFFS_O_CREAT)<sp/>&amp;&amp;<sp/>res<sp/>==<sp/>SPIFFS_ERR_NOT_FOUND)<sp/>{</highlight></codeline>
<codeline lineno="247"><highlight class="normal"></highlight><highlight class="preprocessor">#if<sp/>!SPIFFS_READ_ONLY</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="248"><highlight class="normal"><sp/><sp/><sp/><sp/>spiffs_obj_id<sp/>obj_id;</highlight></codeline>
<codeline lineno="249"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>no<sp/>need<sp/>to<sp/>enter<sp/>conflicting<sp/>name<sp/>here,<sp/>already<sp/>looked<sp/>for<sp/>it<sp/>above</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="250"><highlight class="normal"><sp/><sp/><sp/><sp/>res<sp/>=<sp/>spiffs_obj_lu_find_free_obj_id(fs,<sp/>&amp;obj_id,<sp/>0);</highlight></codeline>
<codeline lineno="251"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(res<sp/>&lt;<sp/>SPIFFS_OK)<sp/>{</highlight></codeline>
<codeline lineno="252"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>spiffs_fd_return(fs,<sp/>fd-&gt;file_nbr);</highlight></codeline>
<codeline lineno="253"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="254"><highlight class="normal"><sp/><sp/><sp/><sp/>SPIFFS_API_CHECK_RES_UNLOCK(fs,<sp/>res);</highlight></codeline>
<codeline lineno="255"><highlight class="normal"><sp/><sp/><sp/><sp/>res<sp/>=<sp/>spiffs_object_create(fs,<sp/>obj_id,<sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>u8_t*)path,<sp/>0,<sp/>SPIFFS_TYPE_FILE,<sp/>&amp;pix);</highlight></codeline>
<codeline lineno="256"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(res<sp/>&lt;<sp/>SPIFFS_OK)<sp/>{</highlight></codeline>
<codeline lineno="257"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>spiffs_fd_return(fs,<sp/>fd-&gt;file_nbr);</highlight></codeline>
<codeline lineno="258"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="259"><highlight class="normal"><sp/><sp/><sp/><sp/>SPIFFS_API_CHECK_RES_UNLOCK(fs,<sp/>res);</highlight></codeline>
<codeline lineno="260"><highlight class="normal"><sp/><sp/><sp/><sp/>flags<sp/>&amp;=<sp/>~SPIFFS_O_TRUNC;</highlight></codeline>
<codeline lineno="261"><highlight class="normal"></highlight><highlight class="preprocessor">#endif<sp/>//<sp/>!SPIFFS_READ_ONLY</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="262"><highlight class="normal"><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="263"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(res<sp/>&lt;<sp/>SPIFFS_OK)<sp/>{</highlight></codeline>
<codeline lineno="264"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>spiffs_fd_return(fs,<sp/>fd-&gt;file_nbr);</highlight></codeline>
<codeline lineno="265"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="266"><highlight class="normal"><sp/><sp/><sp/><sp/>SPIFFS_API_CHECK_RES_UNLOCK(fs,<sp/>res);</highlight></codeline>
<codeline lineno="267"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="268"><highlight class="normal"><sp/><sp/>res<sp/>=<sp/>spiffs_object_open_by_page(fs,<sp/>pix,<sp/>fd,<sp/>flags,<sp/>mode);</highlight></codeline>
<codeline lineno="269"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(res<sp/>&lt;<sp/>SPIFFS_OK)<sp/>{</highlight></codeline>
<codeline lineno="270"><highlight class="normal"><sp/><sp/><sp/><sp/>spiffs_fd_return(fs,<sp/>fd-&gt;file_nbr);</highlight></codeline>
<codeline lineno="271"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="272"><highlight class="normal"><sp/><sp/>SPIFFS_API_CHECK_RES_UNLOCK(fs,<sp/>res);</highlight></codeline>
<codeline lineno="273"><highlight class="normal"></highlight><highlight class="preprocessor">#if<sp/>!SPIFFS_READ_ONLY</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="274"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(flags<sp/>&amp;<sp/>SPIFFS_O_TRUNC)<sp/>{</highlight></codeline>
<codeline lineno="275"><highlight class="normal"><sp/><sp/><sp/><sp/>res<sp/>=<sp/>spiffs_object_truncate(fd,<sp/>0,<sp/>0);</highlight></codeline>
<codeline lineno="276"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(res<sp/>&lt;<sp/>SPIFFS_OK)<sp/>{</highlight></codeline>
<codeline lineno="277"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>spiffs_fd_return(fs,<sp/>fd-&gt;file_nbr);</highlight></codeline>
<codeline lineno="278"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="279"><highlight class="normal"><sp/><sp/><sp/><sp/>SPIFFS_API_CHECK_RES_UNLOCK(fs,<sp/>res);</highlight></codeline>
<codeline lineno="280"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="281"><highlight class="normal"></highlight><highlight class="preprocessor">#endif<sp/>//<sp/>!SPIFFS_READ_ONLY</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="282"><highlight class="normal"></highlight></codeline>
<codeline lineno="283"><highlight class="normal"><sp/><sp/>fd-&gt;fdoffset<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="284"><highlight class="normal"></highlight></codeline>
<codeline lineno="285"><highlight class="normal"><sp/><sp/>SPIFFS_UNLOCK(fs);</highlight></codeline>
<codeline lineno="286"><highlight class="normal"></highlight></codeline>
<codeline lineno="287"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>SPIFFS_FH_OFFS(fs,<sp/>fd-&gt;file_nbr);</highlight></codeline>
<codeline lineno="288"><highlight class="normal">}</highlight></codeline>
<codeline lineno="289"><highlight class="normal"></highlight></codeline>
<codeline lineno="290"><highlight class="normal">spiffs_file<sp/>SPIFFS_open_by_dirent(<ref refid="structspiffs__t" kindref="compound">spiffs</ref><sp/>*fs,<sp/></highlight><highlight class="keyword">struct</highlight><highlight class="normal"><sp/><ref refid="structspiffs__dirent" kindref="compound">spiffs_dirent</ref><sp/>*e,<sp/>spiffs_flags<sp/>flags,<sp/>spiffs_mode<sp/>mode)<sp/>{</highlight></codeline>
<codeline lineno="291"><highlight class="normal"><sp/><sp/>SPIFFS_API_DBG(</highlight><highlight class="stringliteral">&quot;%s<sp/>&apos;%s&apos;:&quot;</highlight><highlight class="normal">_SPIPRIid<sp/></highlight><highlight class="stringliteral">&quot;<sp/>&quot;</highlight><highlight class="normal">_SPIPRIfl<sp/></highlight><highlight class="stringliteral">&quot;\n&quot;</highlight><highlight class="normal">,<sp/>__func__,<sp/>e-&gt;name,<sp/>e-&gt;obj_id,<sp/>flags);</highlight></codeline>
<codeline lineno="292"><highlight class="normal"><sp/><sp/>SPIFFS_API_CHECK_CFG(fs);</highlight></codeline>
<codeline lineno="293"><highlight class="normal"><sp/><sp/>SPIFFS_API_CHECK_MOUNT(fs);</highlight></codeline>
<codeline lineno="294"><highlight class="normal"><sp/><sp/>SPIFFS_LOCK(fs);</highlight></codeline>
<codeline lineno="295"><highlight class="normal"></highlight></codeline>
<codeline lineno="296"><highlight class="normal"><sp/><sp/><ref refid="structspiffs__fd" kindref="compound">spiffs_fd</ref><sp/>*fd;</highlight></codeline>
<codeline lineno="297"><highlight class="normal"></highlight></codeline>
<codeline lineno="298"><highlight class="normal"><sp/><sp/>s32_t<sp/>res<sp/>=<sp/>spiffs_fd_find_new(fs,<sp/>&amp;fd,<sp/>0);</highlight></codeline>
<codeline lineno="299"><highlight class="normal"><sp/><sp/>SPIFFS_API_CHECK_RES_UNLOCK(fs,<sp/>res);</highlight></codeline>
<codeline lineno="300"><highlight class="normal"></highlight></codeline>
<codeline lineno="301"><highlight class="normal"><sp/><sp/>res<sp/>=<sp/>spiffs_object_open_by_page(fs,<sp/>e-&gt;pix,<sp/>fd,<sp/>flags,<sp/>mode);</highlight></codeline>
<codeline lineno="302"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(res<sp/>&lt;<sp/>SPIFFS_OK)<sp/>{</highlight></codeline>
<codeline lineno="303"><highlight class="normal"><sp/><sp/><sp/><sp/>spiffs_fd_return(fs,<sp/>fd-&gt;file_nbr);</highlight></codeline>
<codeline lineno="304"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="305"><highlight class="normal"><sp/><sp/>SPIFFS_API_CHECK_RES_UNLOCK(fs,<sp/>res);</highlight></codeline>
<codeline lineno="306"><highlight class="normal"></highlight><highlight class="preprocessor">#if<sp/>!SPIFFS_READ_ONLY</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="307"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(flags<sp/>&amp;<sp/>SPIFFS_O_TRUNC)<sp/>{</highlight></codeline>
<codeline lineno="308"><highlight class="normal"><sp/><sp/><sp/><sp/>res<sp/>=<sp/>spiffs_object_truncate(fd,<sp/>0,<sp/>0);</highlight></codeline>
<codeline lineno="309"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(res<sp/>&lt;<sp/>SPIFFS_OK)<sp/>{</highlight></codeline>
<codeline lineno="310"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>spiffs_fd_return(fs,<sp/>fd-&gt;file_nbr);</highlight></codeline>
<codeline lineno="311"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="312"><highlight class="normal"><sp/><sp/><sp/><sp/>SPIFFS_API_CHECK_RES_UNLOCK(fs,<sp/>res);</highlight></codeline>
<codeline lineno="313"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="314"><highlight class="normal"></highlight><highlight class="preprocessor">#endif<sp/>//<sp/>!SPIFFS_READ_ONLY</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="315"><highlight class="normal"></highlight></codeline>
<codeline lineno="316"><highlight class="normal"><sp/><sp/>fd-&gt;fdoffset<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="317"><highlight class="normal"></highlight></codeline>
<codeline lineno="318"><highlight class="normal"><sp/><sp/>SPIFFS_UNLOCK(fs);</highlight></codeline>
<codeline lineno="319"><highlight class="normal"></highlight></codeline>
<codeline lineno="320"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>SPIFFS_FH_OFFS(fs,<sp/>fd-&gt;file_nbr);</highlight></codeline>
<codeline lineno="321"><highlight class="normal">}</highlight></codeline>
<codeline lineno="322"><highlight class="normal"></highlight></codeline>
<codeline lineno="323"><highlight class="normal">spiffs_file<sp/>SPIFFS_open_by_page(<ref refid="structspiffs__t" kindref="compound">spiffs</ref><sp/>*fs,<sp/>spiffs_page_ix<sp/>page_ix,<sp/>spiffs_flags<sp/>flags,<sp/>spiffs_mode<sp/>mode)<sp/>{</highlight></codeline>
<codeline lineno="324"><highlight class="normal"><sp/><sp/>SPIFFS_API_DBG(</highlight><highlight class="stringliteral">&quot;%s<sp/>&quot;</highlight><highlight class="normal">_SPIPRIpg<sp/></highlight><highlight class="stringliteral">&quot;<sp/>&quot;</highlight><highlight class="normal">_SPIPRIfl<sp/></highlight><highlight class="stringliteral">&quot;\n&quot;</highlight><highlight class="normal">,<sp/>__func__,<sp/>page_ix,<sp/>flags);</highlight></codeline>
<codeline lineno="325"><highlight class="normal"><sp/><sp/>SPIFFS_API_CHECK_CFG(fs);</highlight></codeline>
<codeline lineno="326"><highlight class="normal"><sp/><sp/>SPIFFS_API_CHECK_MOUNT(fs);</highlight></codeline>
<codeline lineno="327"><highlight class="normal"><sp/><sp/>SPIFFS_LOCK(fs);</highlight></codeline>
<codeline lineno="328"><highlight class="normal"></highlight></codeline>
<codeline lineno="329"><highlight class="normal"><sp/><sp/><ref refid="structspiffs__fd" kindref="compound">spiffs_fd</ref><sp/>*fd;</highlight></codeline>
<codeline lineno="330"><highlight class="normal"></highlight></codeline>
<codeline lineno="331"><highlight class="normal"><sp/><sp/>s32_t<sp/>res<sp/>=<sp/>spiffs_fd_find_new(fs,<sp/>&amp;fd,<sp/>0);</highlight></codeline>
<codeline lineno="332"><highlight class="normal"><sp/><sp/>SPIFFS_API_CHECK_RES_UNLOCK(fs,<sp/>res);</highlight></codeline>
<codeline lineno="333"><highlight class="normal"></highlight></codeline>
<codeline lineno="334"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(SPIFFS_IS_LOOKUP_PAGE(fs,<sp/>page_ix))<sp/>{</highlight></codeline>
<codeline lineno="335"><highlight class="normal"><sp/><sp/><sp/><sp/>res<sp/>=<sp/>SPIFFS_ERR_NOT_A_FILE;</highlight></codeline>
<codeline lineno="336"><highlight class="normal"><sp/><sp/><sp/><sp/>spiffs_fd_return(fs,<sp/>fd-&gt;file_nbr);</highlight></codeline>
<codeline lineno="337"><highlight class="normal"><sp/><sp/><sp/><sp/>SPIFFS_API_CHECK_RES_UNLOCK(fs,<sp/>res);</highlight></codeline>
<codeline lineno="338"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="339"><highlight class="normal"></highlight></codeline>
<codeline lineno="340"><highlight class="normal"><sp/><sp/>res<sp/>=<sp/>spiffs_object_open_by_page(fs,<sp/>page_ix,<sp/>fd,<sp/>flags,<sp/>mode);</highlight></codeline>
<codeline lineno="341"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(res<sp/>==<sp/>SPIFFS_ERR_IS_FREE<sp/>||</highlight></codeline>
<codeline lineno="342"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>res<sp/>==<sp/>SPIFFS_ERR_DELETED<sp/>||</highlight></codeline>
<codeline lineno="343"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>res<sp/>==<sp/>SPIFFS_ERR_NOT_FINALIZED<sp/>||</highlight></codeline>
<codeline lineno="344"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>res<sp/>==<sp/>SPIFFS_ERR_NOT_INDEX<sp/>||</highlight></codeline>
<codeline lineno="345"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>res<sp/>==<sp/>SPIFFS_ERR_INDEX_SPAN_MISMATCH)<sp/>{</highlight></codeline>
<codeline lineno="346"><highlight class="normal"><sp/><sp/><sp/><sp/>res<sp/>=<sp/>SPIFFS_ERR_NOT_A_FILE;</highlight></codeline>
<codeline lineno="347"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="348"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(res<sp/>&lt;<sp/>SPIFFS_OK)<sp/>{</highlight></codeline>
<codeline lineno="349"><highlight class="normal"><sp/><sp/><sp/><sp/>spiffs_fd_return(fs,<sp/>fd-&gt;file_nbr);</highlight></codeline>
<codeline lineno="350"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="351"><highlight class="normal"><sp/><sp/>SPIFFS_API_CHECK_RES_UNLOCK(fs,<sp/>res);</highlight></codeline>
<codeline lineno="352"><highlight class="normal"></highlight></codeline>
<codeline lineno="353"><highlight class="normal"></highlight><highlight class="preprocessor">#if<sp/>!SPIFFS_READ_ONLY</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="354"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(flags<sp/>&amp;<sp/>SPIFFS_O_TRUNC)<sp/>{</highlight></codeline>
<codeline lineno="355"><highlight class="normal"><sp/><sp/><sp/><sp/>res<sp/>=<sp/>spiffs_object_truncate(fd,<sp/>0,<sp/>0);</highlight></codeline>
<codeline lineno="356"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(res<sp/>&lt;<sp/>SPIFFS_OK)<sp/>{</highlight></codeline>
<codeline lineno="357"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>spiffs_fd_return(fs,<sp/>fd-&gt;file_nbr);</highlight></codeline>
<codeline lineno="358"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="359"><highlight class="normal"><sp/><sp/><sp/><sp/>SPIFFS_API_CHECK_RES_UNLOCK(fs,<sp/>res);</highlight></codeline>
<codeline lineno="360"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="361"><highlight class="normal"></highlight><highlight class="preprocessor">#endif<sp/>//<sp/>!SPIFFS_READ_ONLY</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="362"><highlight class="normal"></highlight></codeline>
<codeline lineno="363"><highlight class="normal"><sp/><sp/>fd-&gt;fdoffset<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="364"><highlight class="normal"></highlight></codeline>
<codeline lineno="365"><highlight class="normal"><sp/><sp/>SPIFFS_UNLOCK(fs);</highlight></codeline>
<codeline lineno="366"><highlight class="normal"></highlight></codeline>
<codeline lineno="367"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>SPIFFS_FH_OFFS(fs,<sp/>fd-&gt;file_nbr);</highlight></codeline>
<codeline lineno="368"><highlight class="normal">}</highlight></codeline>
<codeline lineno="369"><highlight class="normal"></highlight></codeline>
<codeline lineno="370"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/>s32_t<sp/>spiffs_hydro_read(<ref refid="structspiffs__t" kindref="compound">spiffs</ref><sp/>*fs,<sp/>spiffs_file<sp/>fh,<sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>*buf,<sp/>s32_t<sp/>len)<sp/>{</highlight></codeline>
<codeline lineno="371"><highlight class="normal"><sp/><sp/>SPIFFS_API_CHECK_CFG(fs);</highlight></codeline>
<codeline lineno="372"><highlight class="normal"><sp/><sp/>SPIFFS_API_CHECK_MOUNT(fs);</highlight></codeline>
<codeline lineno="373"><highlight class="normal"><sp/><sp/>SPIFFS_LOCK(fs);</highlight></codeline>
<codeline lineno="374"><highlight class="normal"></highlight></codeline>
<codeline lineno="375"><highlight class="normal"><sp/><sp/><ref refid="structspiffs__fd" kindref="compound">spiffs_fd</ref><sp/>*fd;</highlight></codeline>
<codeline lineno="376"><highlight class="normal"><sp/><sp/>s32_t<sp/>res;</highlight></codeline>
<codeline lineno="377"><highlight class="normal"></highlight></codeline>
<codeline lineno="378"><highlight class="normal"><sp/><sp/>fh<sp/>=<sp/>SPIFFS_FH_UNOFFS(fs,<sp/>fh);</highlight></codeline>
<codeline lineno="379"><highlight class="normal"><sp/><sp/>res<sp/>=<sp/>spiffs_fd_get(fs,<sp/>fh,<sp/>&amp;fd);</highlight></codeline>
<codeline lineno="380"><highlight class="normal"><sp/><sp/>SPIFFS_API_CHECK_RES_UNLOCK(fs,<sp/>res);</highlight></codeline>
<codeline lineno="381"><highlight class="normal"></highlight></codeline>
<codeline lineno="382"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>((fd-&gt;flags<sp/>&amp;<sp/>SPIFFS_O_RDONLY)<sp/>==<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="383"><highlight class="normal"><sp/><sp/><sp/><sp/>res<sp/>=<sp/>SPIFFS_ERR_NOT_READABLE;</highlight></codeline>
<codeline lineno="384"><highlight class="normal"><sp/><sp/><sp/><sp/>SPIFFS_API_CHECK_RES_UNLOCK(fs,<sp/>res);</highlight></codeline>
<codeline lineno="385"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="386"><highlight class="normal"></highlight></codeline>
<codeline lineno="387"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(fd-&gt;size<sp/>==<sp/>SPIFFS_UNDEFINED_LEN<sp/>&amp;&amp;<sp/>len<sp/>&gt;<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="388"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>special<sp/>case<sp/>for<sp/>zero<sp/>sized<sp/>files</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="389"><highlight class="normal"><sp/><sp/><sp/><sp/>res<sp/>=<sp/>SPIFFS_ERR_END_OF_OBJECT;</highlight></codeline>
<codeline lineno="390"><highlight class="normal"><sp/><sp/><sp/><sp/>SPIFFS_API_CHECK_RES_UNLOCK(fs,<sp/>res);</highlight></codeline>
<codeline lineno="391"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="392"><highlight class="normal"></highlight></codeline>
<codeline lineno="393"><highlight class="normal"></highlight><highlight class="preprocessor">#if<sp/>SPIFFS_CACHE_WR</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="394"><highlight class="normal"><sp/><sp/>spiffs_fflush_cache(fs,<sp/>fh);</highlight></codeline>
<codeline lineno="395"><highlight class="normal"></highlight><highlight class="preprocessor">#endif</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="396"><highlight class="normal"></highlight></codeline>
<codeline lineno="397"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(fd-&gt;fdoffset<sp/>+<sp/>len<sp/>&gt;=<sp/>fd-&gt;size)<sp/>{</highlight></codeline>
<codeline lineno="398"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>reading<sp/>beyond<sp/>file<sp/>size</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="399"><highlight class="normal"><sp/><sp/><sp/><sp/>s32_t<sp/>avail<sp/>=<sp/>fd-&gt;size<sp/>-<sp/>fd-&gt;fdoffset;</highlight></codeline>
<codeline lineno="400"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(avail<sp/>&lt;=<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="401"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>SPIFFS_API_CHECK_RES_UNLOCK(fs,<sp/>SPIFFS_ERR_END_OF_OBJECT);</highlight></codeline>
<codeline lineno="402"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="403"><highlight class="normal"><sp/><sp/><sp/><sp/>res<sp/>=<sp/>spiffs_object_read(fd,<sp/>fd-&gt;fdoffset,<sp/>avail,<sp/>(u8_t*)buf);</highlight></codeline>
<codeline lineno="404"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(res<sp/>==<sp/>SPIFFS_ERR_END_OF_OBJECT)<sp/>{</highlight></codeline>
<codeline lineno="405"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>fd-&gt;fdoffset<sp/>+=<sp/>avail;</highlight></codeline>
<codeline lineno="406"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>SPIFFS_UNLOCK(fs);</highlight></codeline>
<codeline lineno="407"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>avail;</highlight></codeline>
<codeline lineno="408"><highlight class="normal"><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="409"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>SPIFFS_API_CHECK_RES_UNLOCK(fs,<sp/>res);</highlight></codeline>
<codeline lineno="410"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>len<sp/>=<sp/>avail;</highlight></codeline>
<codeline lineno="411"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="412"><highlight class="normal"><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="413"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>reading<sp/>within<sp/>file<sp/>size</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="414"><highlight class="normal"><sp/><sp/><sp/><sp/>res<sp/>=<sp/>spiffs_object_read(fd,<sp/>fd-&gt;fdoffset,<sp/>len,<sp/>(u8_t*)buf);</highlight></codeline>
<codeline lineno="415"><highlight class="normal"><sp/><sp/><sp/><sp/>SPIFFS_API_CHECK_RES_UNLOCK(fs,<sp/>res);</highlight></codeline>
<codeline lineno="416"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="417"><highlight class="normal"><sp/><sp/>fd-&gt;fdoffset<sp/>+=<sp/>len;</highlight></codeline>
<codeline lineno="418"><highlight class="normal"></highlight></codeline>
<codeline lineno="419"><highlight class="normal"><sp/><sp/>SPIFFS_UNLOCK(fs);</highlight></codeline>
<codeline lineno="420"><highlight class="normal"></highlight></codeline>
<codeline lineno="421"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>len;</highlight></codeline>
<codeline lineno="422"><highlight class="normal">}</highlight></codeline>
<codeline lineno="423"><highlight class="normal"></highlight></codeline>
<codeline lineno="424"><highlight class="normal">s32_t<sp/>SPIFFS_read(<ref refid="structspiffs__t" kindref="compound">spiffs</ref><sp/>*fs,<sp/>spiffs_file<sp/>fh,<sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>*buf,<sp/>s32_t<sp/>len)<sp/>{</highlight></codeline>
<codeline lineno="425"><highlight class="normal"><sp/><sp/>SPIFFS_API_DBG(</highlight><highlight class="stringliteral">&quot;%s<sp/>&quot;</highlight><highlight class="normal">_SPIPRIfd<sp/></highlight><highlight class="stringliteral">&quot;<sp/>&quot;</highlight><highlight class="normal">_SPIPRIi<sp/></highlight><highlight class="stringliteral">&quot;\n&quot;</highlight><highlight class="normal">,<sp/>__func__,<sp/>fh,<sp/>len);</highlight></codeline>
<codeline lineno="426"><highlight class="normal"><sp/><sp/>s32_t<sp/>res<sp/>=<sp/>spiffs_hydro_read(fs,<sp/>fh,<sp/>buf,<sp/>len);</highlight></codeline>
<codeline lineno="427"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(res<sp/>==<sp/>SPIFFS_ERR_END_OF_OBJECT)<sp/>{</highlight></codeline>
<codeline lineno="428"><highlight class="normal"><sp/><sp/><sp/><sp/>res<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="429"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="430"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>res;</highlight></codeline>
<codeline lineno="431"><highlight class="normal">}</highlight></codeline>
<codeline lineno="432"><highlight class="normal"></highlight></codeline>
<codeline lineno="433"><highlight class="normal"></highlight></codeline>
<codeline lineno="434"><highlight class="normal"></highlight><highlight class="preprocessor">#if<sp/>!SPIFFS_READ_ONLY</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="435"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/>s32_t<sp/>spiffs_hydro_write(<ref refid="structspiffs__t" kindref="compound">spiffs</ref><sp/>*fs,<sp/><ref refid="structspiffs__fd" kindref="compound">spiffs_fd</ref><sp/>*fd,<sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>*buf,<sp/>u32_t<sp/>offset,<sp/>s32_t<sp/>len)<sp/>{</highlight></codeline>
<codeline lineno="436"><highlight class="normal"><sp/><sp/>(void)fs;</highlight></codeline>
<codeline lineno="437"><highlight class="normal"><sp/><sp/>s32_t<sp/>res<sp/>=<sp/>SPIFFS_OK;</highlight></codeline>
<codeline lineno="438"><highlight class="normal"><sp/><sp/>s32_t<sp/>remaining<sp/>=<sp/>len;</highlight></codeline>
<codeline lineno="439"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(fd-&gt;size<sp/>!=<sp/>SPIFFS_UNDEFINED_LEN<sp/>&amp;&amp;<sp/>offset<sp/>&lt;<sp/>fd-&gt;size)<sp/>{</highlight></codeline>
<codeline lineno="440"><highlight class="normal"><sp/><sp/><sp/><sp/>s32_t<sp/>m_len<sp/>=<sp/>MIN((s32_t)(fd-&gt;size<sp/>-<sp/>offset),<sp/>len);</highlight></codeline>
<codeline lineno="441"><highlight class="normal"><sp/><sp/><sp/><sp/>res<sp/>=<sp/>spiffs_object_modify(fd,<sp/>offset,<sp/>(u8_t<sp/>*)buf,<sp/>m_len);</highlight></codeline>
<codeline lineno="442"><highlight class="normal"><sp/><sp/><sp/><sp/>SPIFFS_CHECK_RES(res);</highlight></codeline>
<codeline lineno="443"><highlight class="normal"><sp/><sp/><sp/><sp/>remaining<sp/>-=<sp/>m_len;</highlight></codeline>
<codeline lineno="444"><highlight class="normal"><sp/><sp/><sp/><sp/>u8_t<sp/>*buf_8<sp/>=<sp/>(u8_t<sp/>*)buf;</highlight></codeline>
<codeline lineno="445"><highlight class="normal"><sp/><sp/><sp/><sp/>buf_8<sp/>+=<sp/>m_len;</highlight></codeline>
<codeline lineno="446"><highlight class="normal"><sp/><sp/><sp/><sp/>buf<sp/>=<sp/>buf_8;</highlight></codeline>
<codeline lineno="447"><highlight class="normal"><sp/><sp/><sp/><sp/>offset<sp/>+=<sp/>m_len;</highlight></codeline>
<codeline lineno="448"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="449"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(remaining<sp/>&gt;<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="450"><highlight class="normal"><sp/><sp/><sp/><sp/>res<sp/>=<sp/>spiffs_object_append(fd,<sp/>offset,<sp/>(u8_t<sp/>*)buf,<sp/>remaining);</highlight></codeline>
<codeline lineno="451"><highlight class="normal"><sp/><sp/><sp/><sp/>SPIFFS_CHECK_RES(res);</highlight></codeline>
<codeline lineno="452"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="453"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>len;</highlight></codeline>
<codeline lineno="454"><highlight class="normal"></highlight></codeline>
<codeline lineno="455"><highlight class="normal">}</highlight></codeline>
<codeline lineno="456"><highlight class="normal"></highlight><highlight class="preprocessor">#endif<sp/>//<sp/>!SPIFFS_READ_ONLY</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="457"><highlight class="normal"></highlight></codeline>
<codeline lineno="458"><highlight class="normal">s32_t<sp/>SPIFFS_write(<ref refid="structspiffs__t" kindref="compound">spiffs</ref><sp/>*fs,<sp/>spiffs_file<sp/>fh,<sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>*buf,<sp/>s32_t<sp/>len)<sp/>{</highlight></codeline>
<codeline lineno="459"><highlight class="normal"><sp/><sp/>SPIFFS_API_DBG(</highlight><highlight class="stringliteral">&quot;%s<sp/>&quot;</highlight><highlight class="normal">_SPIPRIfd<sp/></highlight><highlight class="stringliteral">&quot;<sp/>&quot;</highlight><highlight class="normal">_SPIPRIi<sp/></highlight><highlight class="stringliteral">&quot;\n&quot;</highlight><highlight class="normal">,<sp/>__func__,<sp/>fh,<sp/>len);</highlight></codeline>
<codeline lineno="460"><highlight class="normal"></highlight><highlight class="preprocessor">#if<sp/>SPIFFS_READ_ONLY</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="461"><highlight class="normal"><sp/><sp/>(void)fs;<sp/>(void)fh;<sp/>(void)buf;<sp/>(void)len;</highlight></codeline>
<codeline lineno="462"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>SPIFFS_ERR_RO_NOT_IMPL;</highlight></codeline>
<codeline lineno="463"><highlight class="normal"></highlight><highlight class="preprocessor">#else</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="464"><highlight class="normal"><sp/><sp/>SPIFFS_API_CHECK_CFG(fs);</highlight></codeline>
<codeline lineno="465"><highlight class="normal"><sp/><sp/>SPIFFS_API_CHECK_MOUNT(fs);</highlight></codeline>
<codeline lineno="466"><highlight class="normal"><sp/><sp/>SPIFFS_LOCK(fs);</highlight></codeline>
<codeline lineno="467"><highlight class="normal"></highlight></codeline>
<codeline lineno="468"><highlight class="normal"><sp/><sp/><ref refid="structspiffs__fd" kindref="compound">spiffs_fd</ref><sp/>*fd;</highlight></codeline>
<codeline lineno="469"><highlight class="normal"><sp/><sp/>s32_t<sp/>res;</highlight></codeline>
<codeline lineno="470"><highlight class="normal"><sp/><sp/>u32_t<sp/>offset;</highlight></codeline>
<codeline lineno="471"><highlight class="normal"></highlight></codeline>
<codeline lineno="472"><highlight class="normal"><sp/><sp/>fh<sp/>=<sp/>SPIFFS_FH_UNOFFS(fs,<sp/>fh);</highlight></codeline>
<codeline lineno="473"><highlight class="normal"><sp/><sp/>res<sp/>=<sp/>spiffs_fd_get(fs,<sp/>fh,<sp/>&amp;fd);</highlight></codeline>
<codeline lineno="474"><highlight class="normal"><sp/><sp/>SPIFFS_API_CHECK_RES_UNLOCK(fs,<sp/>res);</highlight></codeline>
<codeline lineno="475"><highlight class="normal"></highlight></codeline>
<codeline lineno="476"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>((fd-&gt;flags<sp/>&amp;<sp/>SPIFFS_O_WRONLY)<sp/>==<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="477"><highlight class="normal"><sp/><sp/><sp/><sp/>res<sp/>=<sp/>SPIFFS_ERR_NOT_WRITABLE;</highlight></codeline>
<codeline lineno="478"><highlight class="normal"><sp/><sp/><sp/><sp/>SPIFFS_API_CHECK_RES_UNLOCK(fs,<sp/>res);</highlight></codeline>
<codeline lineno="479"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="480"><highlight class="normal"></highlight></codeline>
<codeline lineno="481"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>((fd-&gt;flags<sp/>&amp;<sp/>SPIFFS_O_APPEND))<sp/>{</highlight></codeline>
<codeline lineno="482"><highlight class="normal"><sp/><sp/><sp/><sp/>fd-&gt;fdoffset<sp/>=<sp/>fd-&gt;size<sp/>==<sp/>SPIFFS_UNDEFINED_LEN<sp/>?<sp/>0<sp/>:<sp/>fd-&gt;size;</highlight></codeline>
<codeline lineno="483"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="484"><highlight class="normal"><sp/><sp/>offset<sp/>=<sp/>fd-&gt;fdoffset;</highlight></codeline>
<codeline lineno="485"><highlight class="normal"></highlight></codeline>
<codeline lineno="486"><highlight class="normal"></highlight><highlight class="preprocessor">#if<sp/>SPIFFS_CACHE_WR</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="487"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(fd-&gt;cache_page<sp/>==<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="488"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>see<sp/>if<sp/>object<sp/>id<sp/>is<sp/>associated<sp/>with<sp/>cache<sp/>already</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="489"><highlight class="normal"><sp/><sp/><sp/><sp/>fd-&gt;cache_page<sp/>=<sp/>spiffs_cache_page_get_by_fd(fs,<sp/>fd);</highlight></codeline>
<codeline lineno="490"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="491"><highlight class="normal"></highlight><highlight class="preprocessor">#endif</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="492"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(fd-&gt;flags<sp/>&amp;<sp/>SPIFFS_O_APPEND)<sp/>{</highlight></codeline>
<codeline lineno="493"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(fd-&gt;size<sp/>==<sp/>SPIFFS_UNDEFINED_LEN)<sp/>{</highlight></codeline>
<codeline lineno="494"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>offset<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="495"><highlight class="normal"><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="496"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>offset<sp/>=<sp/>fd-&gt;size;</highlight></codeline>
<codeline lineno="497"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="498"><highlight class="normal"></highlight><highlight class="preprocessor">#if<sp/>SPIFFS_CACHE_WR</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="499"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(fd-&gt;cache_page)<sp/>{</highlight></codeline>
<codeline lineno="500"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>offset<sp/>=<sp/>MAX(offset,<sp/>fd-&gt;cache_page-&gt;offset<sp/>+<sp/>fd-&gt;cache_page-&gt;size);</highlight></codeline>
<codeline lineno="501"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="502"><highlight class="normal"></highlight><highlight class="preprocessor">#endif</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="503"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="504"><highlight class="normal"></highlight></codeline>
<codeline lineno="505"><highlight class="normal"></highlight><highlight class="preprocessor">#if<sp/>SPIFFS_CACHE_WR</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="506"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>((fd-&gt;flags<sp/>&amp;<sp/>SPIFFS_O_DIRECT)<sp/>==<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="507"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(len<sp/>&lt;<sp/>(s32_t)SPIFFS_CFG_LOG_PAGE_SZ(fs))<sp/>{</highlight></codeline>
<codeline lineno="508"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>small<sp/>write,<sp/>try<sp/>to<sp/>cache<sp/>it</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="509"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>u8_t<sp/>alloc_cpage<sp/>=<sp/>1;</highlight></codeline>
<codeline lineno="510"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(fd-&gt;cache_page)<sp/>{</highlight></codeline>
<codeline lineno="511"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>have<sp/>a<sp/>cached<sp/>page<sp/>for<sp/>this<sp/>fd<sp/>already,<sp/>check<sp/>cache<sp/>page<sp/>boundaries</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="512"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(offset<sp/>&lt;<sp/>fd-&gt;cache_page-&gt;offset<sp/>||<sp/></highlight><highlight class="comment">//<sp/>writing<sp/>before<sp/>cache</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="513"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>offset<sp/>&gt;<sp/>fd-&gt;cache_page-&gt;offset<sp/>+<sp/>fd-&gt;cache_page-&gt;size<sp/>||<sp/></highlight><highlight class="comment">//<sp/>writing<sp/>after<sp/>cache</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="514"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>offset<sp/>+<sp/>len<sp/>&gt;<sp/>fd-&gt;cache_page-&gt;offset<sp/>+<sp/>SPIFFS_CFG_LOG_PAGE_SZ(fs))<sp/></highlight><highlight class="comment">//<sp/>writing<sp/>beyond<sp/>cache<sp/>page</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="515"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="516"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>boundary<sp/>violation,<sp/>write<sp/>back<sp/>cache<sp/>first<sp/>and<sp/>allocate<sp/>new</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="517"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>SPIFFS_CACHE_DBG(</highlight><highlight class="stringliteral">&quot;CACHE_WR_DUMP:<sp/>dumping<sp/>cache<sp/>page<sp/>&quot;</highlight><highlight class="normal">_SPIPRIi</highlight><highlight class="stringliteral">&quot;<sp/>for<sp/>fd<sp/>&quot;</highlight><highlight class="normal">_SPIPRIfd</highlight><highlight class="stringliteral">&quot;:&quot;</highlight><highlight class="normal">_SPIPRIid</highlight><highlight class="stringliteral">&quot;,<sp/>boundary<sp/>viol,<sp/>offs:&quot;</highlight><highlight class="normal">_SPIPRIi</highlight><highlight class="stringliteral">&quot;<sp/>size:&quot;</highlight><highlight class="normal">_SPIPRIi</highlight><highlight class="stringliteral">&quot;\n&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="518"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>fd-&gt;cache_page-&gt;ix,<sp/>fd-&gt;file_nbr,<sp/>fd-&gt;obj_id,<sp/>fd-&gt;cache_page-&gt;offset,<sp/>fd-&gt;cache_page-&gt;size);</highlight></codeline>
<codeline lineno="519"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>res<sp/>=<sp/>spiffs_hydro_write(fs,<sp/>fd,</highlight></codeline>
<codeline lineno="520"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>spiffs_get_cache_page(fs,<sp/>spiffs_get_cache(fs),<sp/>fd-&gt;cache_page-&gt;ix),</highlight></codeline>
<codeline lineno="521"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>fd-&gt;cache_page-&gt;offset,<sp/>fd-&gt;cache_page-&gt;size);</highlight></codeline>
<codeline lineno="522"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>spiffs_cache_fd_release(fs,<sp/>fd-&gt;cache_page);</highlight></codeline>
<codeline lineno="523"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>SPIFFS_API_CHECK_RES_UNLOCK(fs,<sp/>res);</highlight></codeline>
<codeline lineno="524"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="525"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>writing<sp/>within<sp/>cache</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="526"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>alloc_cpage<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="527"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="528"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="529"><highlight class="normal"></highlight></codeline>
<codeline lineno="530"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(alloc_cpage)<sp/>{</highlight></codeline>
<codeline lineno="531"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>fd-&gt;cache_page<sp/>=<sp/>spiffs_cache_page_allocate_by_fd(fs,<sp/>fd);</highlight></codeline>
<codeline lineno="532"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(fd-&gt;cache_page)<sp/>{</highlight></codeline>
<codeline lineno="533"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>fd-&gt;cache_page-&gt;offset<sp/>=<sp/>offset;</highlight></codeline>
<codeline lineno="534"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>fd-&gt;cache_page-&gt;size<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="535"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>SPIFFS_CACHE_DBG(</highlight><highlight class="stringliteral">&quot;CACHE_WR_ALLO:<sp/>allocating<sp/>cache<sp/>page<sp/>&quot;</highlight><highlight class="normal">_SPIPRIi</highlight><highlight class="stringliteral">&quot;<sp/>for<sp/>fd<sp/>&quot;</highlight><highlight class="normal">_SPIPRIfd</highlight><highlight class="stringliteral">&quot;:&quot;</highlight><highlight class="normal">_SPIPRIid</highlight><highlight class="stringliteral">&quot;\n&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="536"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>fd-&gt;cache_page-&gt;ix,<sp/>fd-&gt;file_nbr,<sp/>fd-&gt;obj_id);</highlight></codeline>
<codeline lineno="537"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="538"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="539"><highlight class="normal"></highlight></codeline>
<codeline lineno="540"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(fd-&gt;cache_page)<sp/>{</highlight></codeline>
<codeline lineno="541"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>u32_t<sp/>offset_in_cpage<sp/>=<sp/>offset<sp/>-<sp/>fd-&gt;cache_page-&gt;offset;</highlight></codeline>
<codeline lineno="542"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>SPIFFS_CACHE_DBG(</highlight><highlight class="stringliteral">&quot;CACHE_WR_WRITE:<sp/>storing<sp/>to<sp/>cache<sp/>page<sp/>&quot;</highlight><highlight class="normal">_SPIPRIi</highlight><highlight class="stringliteral">&quot;<sp/>for<sp/>fd<sp/>&quot;</highlight><highlight class="normal">_SPIPRIfd</highlight><highlight class="stringliteral">&quot;:&quot;</highlight><highlight class="normal">_SPIPRIid</highlight><highlight class="stringliteral">&quot;,<sp/>offs<sp/>&quot;</highlight><highlight class="normal">_SPIPRIi</highlight><highlight class="stringliteral">&quot;:&quot;</highlight><highlight class="normal">_SPIPRIi</highlight><highlight class="stringliteral">&quot;<sp/>len<sp/>&quot;</highlight><highlight class="normal">_SPIPRIi</highlight><highlight class="stringliteral">&quot;\n&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="543"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>fd-&gt;cache_page-&gt;ix,<sp/>fd-&gt;file_nbr,<sp/>fd-&gt;obj_id,</highlight></codeline>
<codeline lineno="544"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>offset,<sp/>offset_in_cpage,<sp/>len);</highlight></codeline>
<codeline lineno="545"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>spiffs_cache<sp/>*cache<sp/>=<sp/>spiffs_get_cache(fs);</highlight></codeline>
<codeline lineno="546"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>u8_t<sp/>*cpage_data<sp/>=<sp/>spiffs_get_cache_page(fs,<sp/>cache,<sp/>fd-&gt;cache_page-&gt;ix);</highlight></codeline>
<codeline lineno="547"><highlight class="normal"></highlight><highlight class="preprocessor">#ifdef<sp/>_SPIFFS_TEST</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="548"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="549"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>intptr_t<sp/>__a1<sp/>=<sp/>(u8_t*)&amp;cpage_data[offset_in_cpage]-(u8_t*)cache;</highlight></codeline>
<codeline lineno="550"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>intptr_t<sp/>__a2<sp/>=<sp/>(u8_t*)&amp;cpage_data[offset_in_cpage]+len-(u8_t*)cache;</highlight></codeline>
<codeline lineno="551"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>intptr_t<sp/>__b<sp/>=<sp/></highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(spiffs_cache)<sp/>+<sp/>cache-&gt;cpage_count<sp/>*<sp/>(</highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(spiffs_cache_page)<sp/>+<sp/>SPIFFS_CFG_LOG_PAGE_SZ(fs));</highlight></codeline>
<codeline lineno="552"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(__a1<sp/>&gt;<sp/>__b<sp/>||<sp/>__a2<sp/>&gt;<sp/>__b)<sp/>{</highlight></codeline>
<codeline lineno="553"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>printf(</highlight><highlight class="stringliteral">&quot;FATAL<sp/>OOB:<sp/>CACHE_WR:<sp/>memcpy<sp/>to<sp/>cache<sp/>buffer<sp/>ixs:%4ld..%4ld<sp/>of<sp/>%4ld\n&quot;</highlight><highlight class="normal">,<sp/>__a1,<sp/>__a2,<sp/>__b);</highlight></codeline>
<codeline lineno="554"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ERREXIT();</highlight></codeline>
<codeline lineno="555"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="556"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="557"><highlight class="normal"></highlight><highlight class="preprocessor">#endif</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="558"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>_SPIFFS_MEMCPY(&amp;cpage_data[offset_in_cpage],<sp/>buf,<sp/>len);</highlight></codeline>
<codeline lineno="559"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>fd-&gt;cache_page-&gt;size<sp/>=<sp/>MAX(fd-&gt;cache_page-&gt;size,<sp/>offset_in_cpage<sp/>+<sp/>len);</highlight></codeline>
<codeline lineno="560"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>fd-&gt;fdoffset<sp/>+=<sp/>len;</highlight></codeline>
<codeline lineno="561"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>SPIFFS_UNLOCK(fs);</highlight></codeline>
<codeline lineno="562"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>len;</highlight></codeline>
<codeline lineno="563"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="564"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>res<sp/>=<sp/>spiffs_hydro_write(fs,<sp/>fd,<sp/>buf,<sp/>offset,<sp/>len);</highlight></codeline>
<codeline lineno="565"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>SPIFFS_API_CHECK_RES_UNLOCK(fs,<sp/>res);</highlight></codeline>
<codeline lineno="566"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>fd-&gt;fdoffset<sp/>+=<sp/>len;</highlight></codeline>
<codeline lineno="567"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>SPIFFS_UNLOCK(fs);</highlight></codeline>
<codeline lineno="568"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>res;</highlight></codeline>
<codeline lineno="569"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="570"><highlight class="normal"><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="571"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>big<sp/>write,<sp/>no<sp/>need<sp/>to<sp/>cache<sp/>it<sp/>-<sp/>but<sp/>first<sp/>check<sp/>if<sp/>there<sp/>is<sp/>a<sp/>cached<sp/>write<sp/>already</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="572"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(fd-&gt;cache_page)<sp/>{</highlight></codeline>
<codeline lineno="573"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>write<sp/>back<sp/>cache<sp/>first</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="574"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>SPIFFS_CACHE_DBG(</highlight><highlight class="stringliteral">&quot;CACHE_WR_DUMP:<sp/>dumping<sp/>cache<sp/>page<sp/>&quot;</highlight><highlight class="normal">_SPIPRIi</highlight><highlight class="stringliteral">&quot;<sp/>for<sp/>fd<sp/>&quot;</highlight><highlight class="normal">_SPIPRIfd</highlight><highlight class="stringliteral">&quot;:&quot;</highlight><highlight class="normal">_SPIPRIid</highlight><highlight class="stringliteral">&quot;,<sp/>big<sp/>write,<sp/>offs:&quot;</highlight><highlight class="normal">_SPIPRIi</highlight><highlight class="stringliteral">&quot;<sp/>size:&quot;</highlight><highlight class="normal">_SPIPRIi</highlight><highlight class="stringliteral">&quot;\n&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="575"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>fd-&gt;cache_page-&gt;ix,<sp/>fd-&gt;file_nbr,<sp/>fd-&gt;obj_id,<sp/>fd-&gt;cache_page-&gt;offset,<sp/>fd-&gt;cache_page-&gt;size);</highlight></codeline>
<codeline lineno="576"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>res<sp/>=<sp/>spiffs_hydro_write(fs,<sp/>fd,</highlight></codeline>
<codeline lineno="577"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>spiffs_get_cache_page(fs,<sp/>spiffs_get_cache(fs),<sp/>fd-&gt;cache_page-&gt;ix),</highlight></codeline>
<codeline lineno="578"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>fd-&gt;cache_page-&gt;offset,<sp/>fd-&gt;cache_page-&gt;size);</highlight></codeline>
<codeline lineno="579"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>spiffs_cache_fd_release(fs,<sp/>fd-&gt;cache_page);</highlight></codeline>
<codeline lineno="580"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>SPIFFS_API_CHECK_RES_UNLOCK(fs,<sp/>res);</highlight></codeline>
<codeline lineno="581"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>data<sp/>written<sp/>below</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="582"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="583"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="584"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="585"><highlight class="normal"></highlight><highlight class="preprocessor">#endif</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="586"><highlight class="normal"></highlight></codeline>
<codeline lineno="587"><highlight class="normal"><sp/><sp/>res<sp/>=<sp/>spiffs_hydro_write(fs,<sp/>fd,<sp/>buf,<sp/>offset,<sp/>len);</highlight></codeline>
<codeline lineno="588"><highlight class="normal"><sp/><sp/>SPIFFS_API_CHECK_RES_UNLOCK(fs,<sp/>res);</highlight></codeline>
<codeline lineno="589"><highlight class="normal"><sp/><sp/>fd-&gt;fdoffset<sp/>+=<sp/>len;</highlight></codeline>
<codeline lineno="590"><highlight class="normal"></highlight></codeline>
<codeline lineno="591"><highlight class="normal"><sp/><sp/>SPIFFS_UNLOCK(fs);</highlight></codeline>
<codeline lineno="592"><highlight class="normal"></highlight></codeline>
<codeline lineno="593"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>res;</highlight></codeline>
<codeline lineno="594"><highlight class="normal"></highlight><highlight class="preprocessor">#endif<sp/>//<sp/>SPIFFS_READ_ONLY</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="595"><highlight class="normal">}</highlight></codeline>
<codeline lineno="596"><highlight class="normal"></highlight></codeline>
<codeline lineno="597"><highlight class="normal">s32_t<sp/>SPIFFS_lseek(<ref refid="structspiffs__t" kindref="compound">spiffs</ref><sp/>*fs,<sp/>spiffs_file<sp/>fh,<sp/>s32_t<sp/>offs,<sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>whence)<sp/>{</highlight></codeline>
<codeline lineno="598"><highlight class="normal"><sp/><sp/>SPIFFS_API_DBG(</highlight><highlight class="stringliteral">&quot;%s<sp/>&quot;</highlight><highlight class="normal">_SPIPRIfd<sp/></highlight><highlight class="stringliteral">&quot;<sp/>&quot;</highlight><highlight class="normal">_SPIPRIi<sp/></highlight><highlight class="stringliteral">&quot;<sp/>%s\n&quot;</highlight><highlight class="normal">,<sp/>__func__,<sp/>fh,<sp/>offs,<sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal">*<sp/>[]){</highlight><highlight class="stringliteral">&quot;SET&quot;</highlight><highlight class="normal">,</highlight><highlight class="stringliteral">&quot;CUR&quot;</highlight><highlight class="normal">,</highlight><highlight class="stringliteral">&quot;END&quot;</highlight><highlight class="normal">,</highlight><highlight class="stringliteral">&quot;???&quot;</highlight><highlight class="normal">}[MIN(whence,3)]);</highlight></codeline>
<codeline lineno="599"><highlight class="normal"><sp/><sp/>SPIFFS_API_CHECK_CFG(fs);</highlight></codeline>
<codeline lineno="600"><highlight class="normal"><sp/><sp/>SPIFFS_API_CHECK_MOUNT(fs);</highlight></codeline>
<codeline lineno="601"><highlight class="normal"><sp/><sp/>SPIFFS_LOCK(fs);</highlight></codeline>
<codeline lineno="602"><highlight class="normal"></highlight></codeline>
<codeline lineno="603"><highlight class="normal"><sp/><sp/><ref refid="structspiffs__fd" kindref="compound">spiffs_fd</ref><sp/>*fd;</highlight></codeline>
<codeline lineno="604"><highlight class="normal"><sp/><sp/>s32_t<sp/>res;</highlight></codeline>
<codeline lineno="605"><highlight class="normal"><sp/><sp/>fh<sp/>=<sp/>SPIFFS_FH_UNOFFS(fs,<sp/>fh);</highlight></codeline>
<codeline lineno="606"><highlight class="normal"><sp/><sp/>res<sp/>=<sp/>spiffs_fd_get(fs,<sp/>fh,<sp/>&amp;fd);</highlight></codeline>
<codeline lineno="607"><highlight class="normal"><sp/><sp/>SPIFFS_API_CHECK_RES_UNLOCK(fs,<sp/>res);</highlight></codeline>
<codeline lineno="608"><highlight class="normal"></highlight></codeline>
<codeline lineno="609"><highlight class="normal"></highlight><highlight class="preprocessor">#if<sp/>SPIFFS_CACHE_WR</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="610"><highlight class="normal"><sp/><sp/>spiffs_fflush_cache(fs,<sp/>fh);</highlight></codeline>
<codeline lineno="611"><highlight class="normal"></highlight><highlight class="preprocessor">#endif</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="612"><highlight class="normal"></highlight></codeline>
<codeline lineno="613"><highlight class="normal"><sp/><sp/>s32_t<sp/>file_size<sp/>=<sp/>fd-&gt;size<sp/>==<sp/>SPIFFS_UNDEFINED_LEN<sp/>?<sp/>0<sp/>:<sp/>fd-&gt;size;</highlight></codeline>
<codeline lineno="614"><highlight class="normal"></highlight></codeline>
<codeline lineno="615"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">switch</highlight><highlight class="normal"><sp/>(whence)<sp/>{</highlight></codeline>
<codeline lineno="616"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/>SPIFFS_SEEK_CUR:</highlight></codeline>
<codeline lineno="617"><highlight class="normal"><sp/><sp/><sp/><sp/>offs<sp/>=<sp/>fd-&gt;fdoffset+offs;</highlight></codeline>
<codeline lineno="618"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="619"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/>SPIFFS_SEEK_END:</highlight></codeline>
<codeline lineno="620"><highlight class="normal"><sp/><sp/><sp/><sp/>offs<sp/>=<sp/>file_size<sp/>+<sp/>offs;</highlight></codeline>
<codeline lineno="621"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="622"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="623"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(offs<sp/>&lt;<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="624"><highlight class="normal"><sp/><sp/><sp/><sp/>SPIFFS_API_CHECK_RES_UNLOCK(fs,<sp/>SPIFFS_ERR_SEEK_BOUNDS);</highlight></codeline>
<codeline lineno="625"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="626"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(offs<sp/>&gt;<sp/>file_size)<sp/>{</highlight></codeline>
<codeline lineno="627"><highlight class="normal"><sp/><sp/><sp/><sp/>fd-&gt;fdoffset<sp/>=<sp/>file_size;</highlight></codeline>
<codeline lineno="628"><highlight class="normal"><sp/><sp/><sp/><sp/>res<sp/>=<sp/>SPIFFS_ERR_END_OF_OBJECT;</highlight></codeline>
<codeline lineno="629"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="630"><highlight class="normal"><sp/><sp/>SPIFFS_API_CHECK_RES_UNLOCK(fs,<sp/>res);</highlight></codeline>
<codeline lineno="631"><highlight class="normal"></highlight></codeline>
<codeline lineno="632"><highlight class="normal"><sp/><sp/>spiffs_span_ix<sp/>data_spix<sp/>=<sp/>(offs<sp/>&gt;<sp/>0<sp/>?<sp/>(offs-1)<sp/>:<sp/>0)<sp/>/<sp/>SPIFFS_DATA_PAGE_SIZE(fs);</highlight></codeline>
<codeline lineno="633"><highlight class="normal"><sp/><sp/>spiffs_span_ix<sp/>objix_spix<sp/>=<sp/>SPIFFS_OBJ_IX_ENTRY_SPAN_IX(fs,<sp/>data_spix);</highlight></codeline>
<codeline lineno="634"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(fd-&gt;cursor_objix_spix<sp/>!=<sp/>objix_spix)<sp/>{</highlight></codeline>
<codeline lineno="635"><highlight class="normal"><sp/><sp/><sp/><sp/>spiffs_page_ix<sp/>pix;</highlight></codeline>
<codeline lineno="636"><highlight class="normal"><sp/><sp/><sp/><sp/>res<sp/>=<sp/>spiffs_obj_lu_find_id_and_span(</highlight></codeline>
<codeline lineno="637"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>fs,<sp/>fd-&gt;obj_id<sp/>|<sp/>SPIFFS_OBJ_ID_IX_FLAG,<sp/>objix_spix,<sp/>0,<sp/>&amp;pix);</highlight></codeline>
<codeline lineno="638"><highlight class="normal"><sp/><sp/><sp/><sp/>SPIFFS_API_CHECK_RES_UNLOCK(fs,<sp/>res);</highlight></codeline>
<codeline lineno="639"><highlight class="normal"><sp/><sp/><sp/><sp/>fd-&gt;cursor_objix_spix<sp/>=<sp/>objix_spix;</highlight></codeline>
<codeline lineno="640"><highlight class="normal"><sp/><sp/><sp/><sp/>fd-&gt;cursor_objix_pix<sp/>=<sp/>pix;</highlight></codeline>
<codeline lineno="641"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="642"><highlight class="normal"><sp/><sp/>fd-&gt;fdoffset<sp/>=<sp/>offs;</highlight></codeline>
<codeline lineno="643"><highlight class="normal"></highlight></codeline>
<codeline lineno="644"><highlight class="normal"><sp/><sp/>SPIFFS_UNLOCK(fs);</highlight></codeline>
<codeline lineno="645"><highlight class="normal"></highlight></codeline>
<codeline lineno="646"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>offs;</highlight></codeline>
<codeline lineno="647"><highlight class="normal">}</highlight></codeline>
<codeline lineno="648"><highlight class="normal"></highlight></codeline>
<codeline lineno="649"><highlight class="normal">s32_t<sp/>SPIFFS_remove(<ref refid="structspiffs__t" kindref="compound">spiffs</ref><sp/>*fs,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*path)<sp/>{</highlight></codeline>
<codeline lineno="650"><highlight class="normal"><sp/><sp/>SPIFFS_API_DBG(</highlight><highlight class="stringliteral">&quot;%s<sp/>&apos;%s&apos;\n&quot;</highlight><highlight class="normal">,<sp/>__func__,<sp/>path);</highlight></codeline>
<codeline lineno="651"><highlight class="normal"></highlight><highlight class="preprocessor">#if<sp/>SPIFFS_READ_ONLY</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="652"><highlight class="normal"><sp/><sp/>(void)fs;<sp/>(void)path;</highlight></codeline>
<codeline lineno="653"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>SPIFFS_ERR_RO_NOT_IMPL;</highlight></codeline>
<codeline lineno="654"><highlight class="normal"></highlight><highlight class="preprocessor">#else</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="655"><highlight class="normal"><sp/><sp/>SPIFFS_API_CHECK_CFG(fs);</highlight></codeline>
<codeline lineno="656"><highlight class="normal"><sp/><sp/>SPIFFS_API_CHECK_MOUNT(fs);</highlight></codeline>
<codeline lineno="657"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(strlen(path)<sp/>&gt;<sp/>SPIFFS_OBJ_NAME_LEN<sp/>-<sp/>1)<sp/>{</highlight></codeline>
<codeline lineno="658"><highlight class="normal"><sp/><sp/><sp/><sp/>SPIFFS_API_CHECK_RES(fs,<sp/>SPIFFS_ERR_NAME_TOO_LONG);</highlight></codeline>
<codeline lineno="659"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="660"><highlight class="normal"><sp/><sp/>SPIFFS_LOCK(fs);</highlight></codeline>
<codeline lineno="661"><highlight class="normal"></highlight></codeline>
<codeline lineno="662"><highlight class="normal"><sp/><sp/><ref refid="structspiffs__fd" kindref="compound">spiffs_fd</ref><sp/>*fd;</highlight></codeline>
<codeline lineno="663"><highlight class="normal"><sp/><sp/>spiffs_page_ix<sp/>pix;</highlight></codeline>
<codeline lineno="664"><highlight class="normal"><sp/><sp/>s32_t<sp/>res;</highlight></codeline>
<codeline lineno="665"><highlight class="normal"></highlight></codeline>
<codeline lineno="666"><highlight class="normal"><sp/><sp/>res<sp/>=<sp/>spiffs_fd_find_new(fs,<sp/>&amp;fd,<sp/>0);</highlight></codeline>
<codeline lineno="667"><highlight class="normal"><sp/><sp/>SPIFFS_API_CHECK_RES_UNLOCK(fs,<sp/>res);</highlight></codeline>
<codeline lineno="668"><highlight class="normal"></highlight></codeline>
<codeline lineno="669"><highlight class="normal"><sp/><sp/>res<sp/>=<sp/>spiffs_object_find_object_index_header_by_name(fs,<sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>u8_t*)path,<sp/>&amp;pix);</highlight></codeline>
<codeline lineno="670"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(res<sp/>!=<sp/>SPIFFS_OK)<sp/>{</highlight></codeline>
<codeline lineno="671"><highlight class="normal"><sp/><sp/><sp/><sp/>spiffs_fd_return(fs,<sp/>fd-&gt;file_nbr);</highlight></codeline>
<codeline lineno="672"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="673"><highlight class="normal"><sp/><sp/>SPIFFS_API_CHECK_RES_UNLOCK(fs,<sp/>res);</highlight></codeline>
<codeline lineno="674"><highlight class="normal"></highlight></codeline>
<codeline lineno="675"><highlight class="normal"><sp/><sp/>res<sp/>=<sp/>spiffs_object_open_by_page(fs,<sp/>pix,<sp/>fd,<sp/>0,0);</highlight></codeline>
<codeline lineno="676"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(res<sp/>!=<sp/>SPIFFS_OK)<sp/>{</highlight></codeline>
<codeline lineno="677"><highlight class="normal"><sp/><sp/><sp/><sp/>spiffs_fd_return(fs,<sp/>fd-&gt;file_nbr);</highlight></codeline>
<codeline lineno="678"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="679"><highlight class="normal"><sp/><sp/>SPIFFS_API_CHECK_RES_UNLOCK(fs,<sp/>res);</highlight></codeline>
<codeline lineno="680"><highlight class="normal"></highlight></codeline>
<codeline lineno="681"><highlight class="normal"><sp/><sp/>res<sp/>=<sp/>spiffs_object_truncate(fd,<sp/>0,<sp/>1);</highlight></codeline>
<codeline lineno="682"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(res<sp/>!=<sp/>SPIFFS_OK)<sp/>{</highlight></codeline>
<codeline lineno="683"><highlight class="normal"><sp/><sp/><sp/><sp/>spiffs_fd_return(fs,<sp/>fd-&gt;file_nbr);</highlight></codeline>
<codeline lineno="684"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="685"><highlight class="normal"><sp/><sp/>SPIFFS_API_CHECK_RES_UNLOCK(fs,<sp/>res);</highlight></codeline>
<codeline lineno="686"><highlight class="normal"></highlight></codeline>
<codeline lineno="687"><highlight class="normal"><sp/><sp/>SPIFFS_UNLOCK(fs);</highlight></codeline>
<codeline lineno="688"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0;</highlight></codeline>
<codeline lineno="689"><highlight class="normal"></highlight><highlight class="preprocessor">#endif<sp/>//<sp/>SPIFFS_READ_ONLY</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="690"><highlight class="normal">}</highlight></codeline>
<codeline lineno="691"><highlight class="normal"></highlight></codeline>
<codeline lineno="692"><highlight class="normal">s32_t<sp/>SPIFFS_fremove(<ref refid="structspiffs__t" kindref="compound">spiffs</ref><sp/>*fs,<sp/>spiffs_file<sp/>fh)<sp/>{</highlight></codeline>
<codeline lineno="693"><highlight class="normal"><sp/><sp/>SPIFFS_API_DBG(</highlight><highlight class="stringliteral">&quot;%s<sp/>&quot;</highlight><highlight class="normal">_SPIPRIfd<sp/></highlight><highlight class="stringliteral">&quot;\n&quot;</highlight><highlight class="normal">,<sp/>__func__,<sp/>fh);</highlight></codeline>
<codeline lineno="694"><highlight class="normal"></highlight><highlight class="preprocessor">#if<sp/>SPIFFS_READ_ONLY</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="695"><highlight class="normal"><sp/><sp/>(void)fs;<sp/>(void)fh;</highlight></codeline>
<codeline lineno="696"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>SPIFFS_ERR_RO_NOT_IMPL;</highlight></codeline>
<codeline lineno="697"><highlight class="normal"></highlight><highlight class="preprocessor">#else</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="698"><highlight class="normal"><sp/><sp/>SPIFFS_API_CHECK_CFG(fs);</highlight></codeline>
<codeline lineno="699"><highlight class="normal"><sp/><sp/>SPIFFS_API_CHECK_MOUNT(fs);</highlight></codeline>
<codeline lineno="700"><highlight class="normal"><sp/><sp/>SPIFFS_LOCK(fs);</highlight></codeline>
<codeline lineno="701"><highlight class="normal"></highlight></codeline>
<codeline lineno="702"><highlight class="normal"><sp/><sp/><ref refid="structspiffs__fd" kindref="compound">spiffs_fd</ref><sp/>*fd;</highlight></codeline>
<codeline lineno="703"><highlight class="normal"><sp/><sp/>s32_t<sp/>res;</highlight></codeline>
<codeline lineno="704"><highlight class="normal"><sp/><sp/>fh<sp/>=<sp/>SPIFFS_FH_UNOFFS(fs,<sp/>fh);</highlight></codeline>
<codeline lineno="705"><highlight class="normal"><sp/><sp/>res<sp/>=<sp/>spiffs_fd_get(fs,<sp/>fh,<sp/>&amp;fd);</highlight></codeline>
<codeline lineno="706"><highlight class="normal"><sp/><sp/>SPIFFS_API_CHECK_RES_UNLOCK(fs,<sp/>res);</highlight></codeline>
<codeline lineno="707"><highlight class="normal"></highlight></codeline>
<codeline lineno="708"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>((fd-&gt;flags<sp/>&amp;<sp/>SPIFFS_O_WRONLY)<sp/>==<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="709"><highlight class="normal"><sp/><sp/><sp/><sp/>res<sp/>=<sp/>SPIFFS_ERR_NOT_WRITABLE;</highlight></codeline>
<codeline lineno="710"><highlight class="normal"><sp/><sp/><sp/><sp/>SPIFFS_API_CHECK_RES_UNLOCK(fs,<sp/>res);</highlight></codeline>
<codeline lineno="711"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="712"><highlight class="normal"></highlight></codeline>
<codeline lineno="713"><highlight class="normal"></highlight><highlight class="preprocessor">#if<sp/>SPIFFS_CACHE_WR</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="714"><highlight class="normal"><sp/><sp/>spiffs_cache_fd_release(fs,<sp/>fd-&gt;cache_page);</highlight></codeline>
<codeline lineno="715"><highlight class="normal"></highlight><highlight class="preprocessor">#endif</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="716"><highlight class="normal"></highlight></codeline>
<codeline lineno="717"><highlight class="normal"><sp/><sp/>res<sp/>=<sp/>spiffs_object_truncate(fd,<sp/>0,<sp/>1);</highlight></codeline>
<codeline lineno="718"><highlight class="normal"></highlight></codeline>
<codeline lineno="719"><highlight class="normal"><sp/><sp/>SPIFFS_API_CHECK_RES_UNLOCK(fs,<sp/>res);</highlight></codeline>
<codeline lineno="720"><highlight class="normal"></highlight></codeline>
<codeline lineno="721"><highlight class="normal"><sp/><sp/>SPIFFS_UNLOCK(fs);</highlight></codeline>
<codeline lineno="722"><highlight class="normal"></highlight></codeline>
<codeline lineno="723"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0;</highlight></codeline>
<codeline lineno="724"><highlight class="normal"></highlight><highlight class="preprocessor">#endif<sp/>//<sp/>SPIFFS_READ_ONLY</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="725"><highlight class="normal">}</highlight></codeline>
<codeline lineno="726"><highlight class="normal"></highlight></codeline>
<codeline lineno="727"><highlight class="normal"></highlight></codeline>
<codeline lineno="728"><highlight class="normal">s32_t<sp/>SPIFFS_truncate(<ref refid="structspiffs__t" kindref="compound">spiffs</ref><sp/>*fs,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*path,<sp/>s32_t<sp/>len)<sp/>{</highlight></codeline>
<codeline lineno="729"><highlight class="normal"><sp/><sp/>SPIFFS_API_DBG(</highlight><highlight class="stringliteral">&quot;%s<sp/>&apos;%s&apos;\n&quot;</highlight><highlight class="normal">,<sp/>__func__,<sp/>path);</highlight></codeline>
<codeline lineno="730"><highlight class="normal"></highlight><highlight class="preprocessor">#if<sp/>SPIFFS_READ_ONLY</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="731"><highlight class="normal"><sp/><sp/>(void)fs;<sp/>(void)path;</highlight></codeline>
<codeline lineno="732"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>SPIFFS_ERR_RO_NOT_IMPL;</highlight></codeline>
<codeline lineno="733"><highlight class="normal"></highlight><highlight class="preprocessor">#else</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="734"><highlight class="normal"><sp/><sp/>SPIFFS_API_CHECK_CFG(fs);</highlight></codeline>
<codeline lineno="735"><highlight class="normal"><sp/><sp/>SPIFFS_API_CHECK_MOUNT(fs);</highlight></codeline>
<codeline lineno="736"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(strlen(path)<sp/>&gt;<sp/>SPIFFS_OBJ_NAME_LEN<sp/>-<sp/>1)<sp/>{</highlight></codeline>
<codeline lineno="737"><highlight class="normal"><sp/><sp/><sp/><sp/>SPIFFS_API_CHECK_RES(fs,<sp/>SPIFFS_ERR_NAME_TOO_LONG);</highlight></codeline>
<codeline lineno="738"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="739"><highlight class="normal"><sp/><sp/>SPIFFS_LOCK(fs);</highlight></codeline>
<codeline lineno="740"><highlight class="normal"></highlight></codeline>
<codeline lineno="741"><highlight class="normal"><sp/><sp/><ref refid="structspiffs__fd" kindref="compound">spiffs_fd</ref><sp/>*fd;</highlight></codeline>
<codeline lineno="742"><highlight class="normal"><sp/><sp/>spiffs_page_ix<sp/>pix;</highlight></codeline>
<codeline lineno="743"><highlight class="normal"><sp/><sp/>s32_t<sp/>res;</highlight></codeline>
<codeline lineno="744"><highlight class="normal"></highlight></codeline>
<codeline lineno="745"><highlight class="normal"><sp/><sp/>res<sp/>=<sp/>spiffs_fd_find_new(fs,<sp/>&amp;fd,<sp/>0);</highlight></codeline>
<codeline lineno="746"><highlight class="normal"><sp/><sp/>SPIFFS_API_CHECK_RES_UNLOCK(fs,<sp/>res);</highlight></codeline>
<codeline lineno="747"><highlight class="normal"></highlight></codeline>
<codeline lineno="748"><highlight class="normal"><sp/><sp/>res<sp/>=<sp/>spiffs_object_find_object_index_header_by_name(fs,<sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>u8_t*)path,<sp/>&amp;pix);</highlight></codeline>
<codeline lineno="749"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(res<sp/>!=<sp/>SPIFFS_OK)<sp/>{</highlight></codeline>
<codeline lineno="750"><highlight class="normal"><sp/><sp/><sp/><sp/>spiffs_fd_return(fs,<sp/>fd-&gt;file_nbr);</highlight></codeline>
<codeline lineno="751"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="752"><highlight class="normal"><sp/><sp/>SPIFFS_API_CHECK_RES_UNLOCK(fs,<sp/>res);</highlight></codeline>
<codeline lineno="753"><highlight class="normal"></highlight></codeline>
<codeline lineno="754"><highlight class="normal"><sp/><sp/>res<sp/>=<sp/>spiffs_object_open_by_page(fs,<sp/>pix,<sp/>fd,<sp/>0,0);</highlight></codeline>
<codeline lineno="755"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(res<sp/>!=<sp/>SPIFFS_OK)<sp/>{</highlight></codeline>
<codeline lineno="756"><highlight class="normal"><sp/><sp/><sp/><sp/>spiffs_fd_return(fs,<sp/>fd-&gt;file_nbr);</highlight></codeline>
<codeline lineno="757"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="758"><highlight class="normal"><sp/><sp/>SPIFFS_API_CHECK_RES_UNLOCK(fs,<sp/>res);</highlight></codeline>
<codeline lineno="759"><highlight class="normal"></highlight></codeline>
<codeline lineno="760"><highlight class="normal"><sp/><sp/>res<sp/>=<sp/>spiffs_object_truncate(fd,<sp/>len,<sp/>0);</highlight></codeline>
<codeline lineno="761"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(res<sp/>!=<sp/>SPIFFS_OK)<sp/>{</highlight></codeline>
<codeline lineno="762"><highlight class="normal"><sp/><sp/><sp/><sp/>spiffs_fd_return(fs,<sp/>fd-&gt;file_nbr);</highlight></codeline>
<codeline lineno="763"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="764"><highlight class="normal"><sp/><sp/>SPIFFS_API_CHECK_RES_UNLOCK(fs,<sp/>res);</highlight></codeline>
<codeline lineno="765"><highlight class="normal"></highlight></codeline>
<codeline lineno="766"><highlight class="normal"><sp/><sp/>SPIFFS_UNLOCK(fs);</highlight></codeline>
<codeline lineno="767"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0;</highlight></codeline>
<codeline lineno="768"><highlight class="normal"></highlight><highlight class="preprocessor">#endif<sp/>//<sp/>SPIFFS_READ_ONLY</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="769"><highlight class="normal">}</highlight></codeline>
<codeline lineno="770"><highlight class="normal"></highlight></codeline>
<codeline lineno="771"><highlight class="normal">s32_t<sp/>SPIFFS_ftruncate(<ref refid="structspiffs__t" kindref="compound">spiffs</ref><sp/>*fs,<sp/>spiffs_file<sp/>fh,<sp/>s32_t<sp/>len)<sp/>{</highlight></codeline>
<codeline lineno="772"><highlight class="normal"><sp/><sp/>SPIFFS_API_DBG(</highlight><highlight class="stringliteral">&quot;%s<sp/>&quot;</highlight><highlight class="normal">_SPIPRIfd<sp/></highlight><highlight class="stringliteral">&quot;\n&quot;</highlight><highlight class="normal">,<sp/>__func__,<sp/>fh);</highlight></codeline>
<codeline lineno="773"><highlight class="normal"></highlight><highlight class="preprocessor">#if<sp/>SPIFFS_READ_ONLY</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="774"><highlight class="normal"><sp/><sp/>(void)fs;<sp/>(void)fh;</highlight></codeline>
<codeline lineno="775"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>SPIFFS_ERR_RO_NOT_IMPL;</highlight></codeline>
<codeline lineno="776"><highlight class="normal"></highlight><highlight class="preprocessor">#else</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="777"><highlight class="normal"><sp/><sp/>SPIFFS_API_CHECK_CFG(fs);</highlight></codeline>
<codeline lineno="778"><highlight class="normal"><sp/><sp/>SPIFFS_API_CHECK_MOUNT(fs);</highlight></codeline>
<codeline lineno="779"><highlight class="normal"><sp/><sp/>SPIFFS_LOCK(fs);</highlight></codeline>
<codeline lineno="780"><highlight class="normal"></highlight></codeline>
<codeline lineno="781"><highlight class="normal"><sp/><sp/><ref refid="structspiffs__fd" kindref="compound">spiffs_fd</ref><sp/>*fd;</highlight></codeline>
<codeline lineno="782"><highlight class="normal"><sp/><sp/>s32_t<sp/>res;</highlight></codeline>
<codeline lineno="783"><highlight class="normal"><sp/><sp/>fh<sp/>=<sp/>SPIFFS_FH_UNOFFS(fs,<sp/>fh);</highlight></codeline>
<codeline lineno="784"><highlight class="normal"><sp/><sp/>res<sp/>=<sp/>spiffs_fd_get(fs,<sp/>fh,<sp/>&amp;fd);</highlight></codeline>
<codeline lineno="785"><highlight class="normal"><sp/><sp/>SPIFFS_API_CHECK_RES_UNLOCK(fs,<sp/>res);</highlight></codeline>
<codeline lineno="786"><highlight class="normal"></highlight></codeline>
<codeline lineno="787"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>((fd-&gt;flags<sp/>&amp;<sp/>SPIFFS_O_WRONLY)<sp/>==<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="788"><highlight class="normal"><sp/><sp/><sp/><sp/>res<sp/>=<sp/>SPIFFS_ERR_NOT_WRITABLE;</highlight></codeline>
<codeline lineno="789"><highlight class="normal"><sp/><sp/><sp/><sp/>SPIFFS_API_CHECK_RES_UNLOCK(fs,<sp/>res);</highlight></codeline>
<codeline lineno="790"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="791"><highlight class="normal"></highlight></codeline>
<codeline lineno="792"><highlight class="normal"></highlight><highlight class="preprocessor">#if<sp/>SPIFFS_CACHE_WR</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="793"><highlight class="normal"><sp/><sp/>spiffs_cache_fd_release(fs,<sp/>fd-&gt;cache_page);</highlight></codeline>
<codeline lineno="794"><highlight class="normal"></highlight><highlight class="preprocessor">#endif</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="795"><highlight class="normal"></highlight></codeline>
<codeline lineno="796"><highlight class="normal"><sp/><sp/>res<sp/>=<sp/>spiffs_object_truncate(fd,<sp/>len,<sp/>0);</highlight></codeline>
<codeline lineno="797"><highlight class="normal"></highlight></codeline>
<codeline lineno="798"><highlight class="normal"><sp/><sp/>SPIFFS_API_CHECK_RES_UNLOCK(fs,<sp/>res);</highlight></codeline>
<codeline lineno="799"><highlight class="normal"></highlight></codeline>
<codeline lineno="800"><highlight class="normal"><sp/><sp/>SPIFFS_UNLOCK(fs);</highlight></codeline>
<codeline lineno="801"><highlight class="normal"></highlight></codeline>
<codeline lineno="802"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0;</highlight></codeline>
<codeline lineno="803"><highlight class="normal"></highlight><highlight class="preprocessor">#endif<sp/>//<sp/>SPIFFS_READ_ONLY</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="804"><highlight class="normal">}</highlight></codeline>
<codeline lineno="805"><highlight class="normal"></highlight></codeline>
<codeline lineno="806"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/>s32_t<sp/>spiffs_stat_pix(<ref refid="structspiffs__t" kindref="compound">spiffs</ref><sp/>*fs,<sp/>spiffs_page_ix<sp/>pix,<sp/>spiffs_file<sp/>fh,<sp/><ref refid="structspiffs__stat" kindref="compound">spiffs_stat</ref><sp/>*s)<sp/>{</highlight></codeline>
<codeline lineno="807"><highlight class="normal"><sp/><sp/>(void)fh;</highlight></codeline>
<codeline lineno="808"><highlight class="normal"><sp/><sp/><ref refid="struct_s_p_i_f_f_s___p_a_c_k_e_d" kindref="compound">spiffs_page_object_ix_header</ref><sp/>objix_hdr;</highlight></codeline>
<codeline lineno="809"><highlight class="normal"><sp/><sp/>spiffs_obj_id<sp/>obj_id;</highlight></codeline>
<codeline lineno="810"><highlight class="normal"><sp/><sp/>s32_t<sp/>res<sp/>=_spiffs_rd(fs,<sp/><sp/>SPIFFS_OP_T_OBJ_IX<sp/>|<sp/>SPIFFS_OP_C_READ,<sp/>fh,</highlight></codeline>
<codeline lineno="811"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>SPIFFS_PAGE_TO_PADDR(fs,<sp/>pix),<sp/></highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(<ref refid="struct_s_p_i_f_f_s___p_a_c_k_e_d" kindref="compound">spiffs_page_object_ix_header</ref>),<sp/>(u8_t<sp/>*)&amp;objix_hdr);</highlight></codeline>
<codeline lineno="812"><highlight class="normal"><sp/><sp/>SPIFFS_API_CHECK_RES(fs,<sp/>res);</highlight></codeline>
<codeline lineno="813"><highlight class="normal"></highlight></codeline>
<codeline lineno="814"><highlight class="normal"><sp/><sp/>u32_t<sp/>obj_id_addr<sp/>=<sp/>SPIFFS_BLOCK_TO_PADDR(fs,<sp/>SPIFFS_BLOCK_FOR_PAGE(fs<sp/>,<sp/>pix))<sp/>+</highlight></codeline>
<codeline lineno="815"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>SPIFFS_OBJ_LOOKUP_ENTRY_FOR_PAGE(fs,<sp/>pix)<sp/>*<sp/></highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(spiffs_obj_id);</highlight></codeline>
<codeline lineno="816"><highlight class="normal"><sp/><sp/>res<sp/>=_spiffs_rd(fs,<sp/><sp/>SPIFFS_OP_T_OBJ_LU<sp/>|<sp/>SPIFFS_OP_C_READ,<sp/>fh,</highlight></codeline>
<codeline lineno="817"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>obj_id_addr,<sp/></highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(spiffs_obj_id),<sp/>(u8_t<sp/>*)&amp;obj_id);</highlight></codeline>
<codeline lineno="818"><highlight class="normal"><sp/><sp/>SPIFFS_API_CHECK_RES(fs,<sp/>res);</highlight></codeline>
<codeline lineno="819"><highlight class="normal"></highlight></codeline>
<codeline lineno="820"><highlight class="normal"><sp/><sp/>s-&gt;obj_id<sp/>=<sp/>obj_id<sp/>&amp;<sp/>~SPIFFS_OBJ_ID_IX_FLAG;</highlight></codeline>
<codeline lineno="821"><highlight class="normal"><sp/><sp/>s-&gt;type<sp/>=<sp/>objix_hdr.type;</highlight></codeline>
<codeline lineno="822"><highlight class="normal"><sp/><sp/>s-&gt;size<sp/>=<sp/>objix_hdr.size<sp/>==<sp/>SPIFFS_UNDEFINED_LEN<sp/>?<sp/>0<sp/>:<sp/>objix_hdr.size;</highlight></codeline>
<codeline lineno="823"><highlight class="normal"><sp/><sp/>s-&gt;pix<sp/>=<sp/>pix;</highlight></codeline>
<codeline lineno="824"><highlight class="normal"><sp/><sp/>strncpy((</highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*)s-&gt;name,<sp/>(</highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*)objix_hdr.name,<sp/>SPIFFS_OBJ_NAME_LEN);</highlight></codeline>
<codeline lineno="825"><highlight class="normal"></highlight><highlight class="preprocessor">#if<sp/>SPIFFS_OBJ_META_LEN</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="826"><highlight class="normal"><sp/><sp/>_SPIFFS_MEMCPY(s-&gt;meta,<sp/>objix_hdr.meta,<sp/>SPIFFS_OBJ_META_LEN);</highlight></codeline>
<codeline lineno="827"><highlight class="normal"></highlight><highlight class="preprocessor">#endif</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="828"><highlight class="normal"></highlight></codeline>
<codeline lineno="829"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>res;</highlight></codeline>
<codeline lineno="830"><highlight class="normal">}</highlight></codeline>
<codeline lineno="831"><highlight class="normal"></highlight></codeline>
<codeline lineno="832"><highlight class="normal">s32_t<sp/>SPIFFS_stat(<ref refid="structspiffs__t" kindref="compound">spiffs</ref><sp/>*fs,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*path,<sp/><ref refid="structspiffs__stat" kindref="compound">spiffs_stat</ref><sp/>*s)<sp/>{</highlight></codeline>
<codeline lineno="833"><highlight class="normal"><sp/><sp/>SPIFFS_API_DBG(</highlight><highlight class="stringliteral">&quot;%s<sp/>&apos;%s&apos;\n&quot;</highlight><highlight class="normal">,<sp/>__func__,<sp/>path);</highlight></codeline>
<codeline lineno="834"><highlight class="normal"><sp/><sp/>SPIFFS_API_CHECK_CFG(fs);</highlight></codeline>
<codeline lineno="835"><highlight class="normal"><sp/><sp/>SPIFFS_API_CHECK_MOUNT(fs);</highlight></codeline>
<codeline lineno="836"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(strlen(path)<sp/>&gt;<sp/>SPIFFS_OBJ_NAME_LEN<sp/>-<sp/>1)<sp/>{</highlight></codeline>
<codeline lineno="837"><highlight class="normal"><sp/><sp/><sp/><sp/>SPIFFS_API_CHECK_RES(fs,<sp/>SPIFFS_ERR_NAME_TOO_LONG);</highlight></codeline>
<codeline lineno="838"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="839"><highlight class="normal"><sp/><sp/>SPIFFS_LOCK(fs);</highlight></codeline>
<codeline lineno="840"><highlight class="normal"></highlight></codeline>
<codeline lineno="841"><highlight class="normal"><sp/><sp/>s32_t<sp/>res;</highlight></codeline>
<codeline lineno="842"><highlight class="normal"><sp/><sp/>spiffs_page_ix<sp/>pix;</highlight></codeline>
<codeline lineno="843"><highlight class="normal"></highlight></codeline>
<codeline lineno="844"><highlight class="normal"><sp/><sp/>res<sp/>=<sp/>spiffs_object_find_object_index_header_by_name(fs,<sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>u8_t*)path,<sp/>&amp;pix);</highlight></codeline>
<codeline lineno="845"><highlight class="normal"><sp/><sp/>SPIFFS_API_CHECK_RES_UNLOCK(fs,<sp/>res);</highlight></codeline>
<codeline lineno="846"><highlight class="normal"></highlight></codeline>
<codeline lineno="847"><highlight class="normal"><sp/><sp/>res<sp/>=<sp/>spiffs_stat_pix(fs,<sp/>pix,<sp/>0,<sp/>s);</highlight></codeline>
<codeline lineno="848"><highlight class="normal"></highlight></codeline>
<codeline lineno="849"><highlight class="normal"><sp/><sp/>SPIFFS_UNLOCK(fs);</highlight></codeline>
<codeline lineno="850"><highlight class="normal"></highlight></codeline>
<codeline lineno="851"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>res;</highlight></codeline>
<codeline lineno="852"><highlight class="normal">}</highlight></codeline>
<codeline lineno="853"><highlight class="normal"></highlight></codeline>
<codeline lineno="854"><highlight class="normal">s32_t<sp/>SPIFFS_fstat(<ref refid="structspiffs__t" kindref="compound">spiffs</ref><sp/>*fs,<sp/>spiffs_file<sp/>fh,<sp/><ref refid="structspiffs__stat" kindref="compound">spiffs_stat</ref><sp/>*s)<sp/>{</highlight></codeline>
<codeline lineno="855"><highlight class="normal"><sp/><sp/>SPIFFS_API_DBG(</highlight><highlight class="stringliteral">&quot;%s<sp/>&quot;</highlight><highlight class="normal">_SPIPRIfd<sp/></highlight><highlight class="stringliteral">&quot;\n&quot;</highlight><highlight class="normal">,<sp/>__func__,<sp/>fh);</highlight></codeline>
<codeline lineno="856"><highlight class="normal"><sp/><sp/>SPIFFS_API_CHECK_CFG(fs);</highlight></codeline>
<codeline lineno="857"><highlight class="normal"><sp/><sp/>SPIFFS_API_CHECK_MOUNT(fs);</highlight></codeline>
<codeline lineno="858"><highlight class="normal"><sp/><sp/>SPIFFS_LOCK(fs);</highlight></codeline>
<codeline lineno="859"><highlight class="normal"></highlight></codeline>
<codeline lineno="860"><highlight class="normal"><sp/><sp/><ref refid="structspiffs__fd" kindref="compound">spiffs_fd</ref><sp/>*fd;</highlight></codeline>
<codeline lineno="861"><highlight class="normal"><sp/><sp/>s32_t<sp/>res;</highlight></codeline>
<codeline lineno="862"><highlight class="normal"></highlight></codeline>
<codeline lineno="863"><highlight class="normal"><sp/><sp/>fh<sp/>=<sp/>SPIFFS_FH_UNOFFS(fs,<sp/>fh);</highlight></codeline>
<codeline lineno="864"><highlight class="normal"><sp/><sp/>res<sp/>=<sp/>spiffs_fd_get(fs,<sp/>fh,<sp/>&amp;fd);</highlight></codeline>
<codeline lineno="865"><highlight class="normal"><sp/><sp/>SPIFFS_API_CHECK_RES_UNLOCK(fs,<sp/>res);</highlight></codeline>
<codeline lineno="866"><highlight class="normal"></highlight></codeline>
<codeline lineno="867"><highlight class="normal"></highlight><highlight class="preprocessor">#if<sp/>SPIFFS_CACHE_WR</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="868"><highlight class="normal"><sp/><sp/>spiffs_fflush_cache(fs,<sp/>fh);</highlight></codeline>
<codeline lineno="869"><highlight class="normal"></highlight><highlight class="preprocessor">#endif</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="870"><highlight class="normal"></highlight></codeline>
<codeline lineno="871"><highlight class="normal"><sp/><sp/>res<sp/>=<sp/>spiffs_stat_pix(fs,<sp/>fd-&gt;objix_hdr_pix,<sp/>fh,<sp/>s);</highlight></codeline>
<codeline lineno="872"><highlight class="normal"></highlight></codeline>
<codeline lineno="873"><highlight class="normal"><sp/><sp/>SPIFFS_UNLOCK(fs);</highlight></codeline>
<codeline lineno="874"><highlight class="normal"></highlight></codeline>
<codeline lineno="875"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>res;</highlight></codeline>
<codeline lineno="876"><highlight class="normal">}</highlight></codeline>
<codeline lineno="877"><highlight class="normal"></highlight></codeline>
<codeline lineno="878"><highlight class="normal"></highlight><highlight class="comment">//<sp/>Checks<sp/>if<sp/>there<sp/>are<sp/>any<sp/>cached<sp/>writes<sp/>for<sp/>the<sp/>object<sp/>id<sp/>associated<sp/>with</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="879"><highlight class="normal"></highlight><highlight class="comment">//<sp/>given<sp/>filehandle.<sp/>If<sp/>so,<sp/>these<sp/>writes<sp/>are<sp/>flushed.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="880"><highlight class="normal"></highlight><highlight class="preprocessor">#if<sp/>SPIFFS_CACHE<sp/>==<sp/>1</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="881"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/>s32_t<sp/>spiffs_fflush_cache(<ref refid="structspiffs__t" kindref="compound">spiffs</ref><sp/>*fs,<sp/>spiffs_file<sp/>fh)<sp/>{</highlight></codeline>
<codeline lineno="882"><highlight class="normal"><sp/><sp/>(void)fs;</highlight></codeline>
<codeline lineno="883"><highlight class="normal"><sp/><sp/>(void)fh;</highlight></codeline>
<codeline lineno="884"><highlight class="normal"><sp/><sp/>s32_t<sp/>res<sp/>=<sp/>SPIFFS_OK;</highlight></codeline>
<codeline lineno="885"><highlight class="normal"></highlight><highlight class="preprocessor">#if<sp/>!SPIFFS_READ_ONLY<sp/>&amp;&amp;<sp/>SPIFFS_CACHE_WR</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="886"><highlight class="normal"></highlight></codeline>
<codeline lineno="887"><highlight class="normal"><sp/><sp/><ref refid="structspiffs__fd" kindref="compound">spiffs_fd</ref><sp/>*fd;</highlight></codeline>
<codeline lineno="888"><highlight class="normal"><sp/><sp/>res<sp/>=<sp/>spiffs_fd_get(fs,<sp/>fh,<sp/>&amp;fd);</highlight></codeline>
<codeline lineno="889"><highlight class="normal"><sp/><sp/>SPIFFS_API_CHECK_RES(fs,<sp/>res);</highlight></codeline>
<codeline lineno="890"><highlight class="normal"></highlight></codeline>
<codeline lineno="891"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>((fd-&gt;flags<sp/>&amp;<sp/>SPIFFS_O_DIRECT)<sp/>==<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="892"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(fd-&gt;cache_page<sp/>==<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="893"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>see<sp/>if<sp/>object<sp/>id<sp/>is<sp/>associated<sp/>with<sp/>cache<sp/>already</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="894"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>fd-&gt;cache_page<sp/>=<sp/>spiffs_cache_page_get_by_fd(fs,<sp/>fd);</highlight></codeline>
<codeline lineno="895"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="896"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(fd-&gt;cache_page)<sp/>{</highlight></codeline>
<codeline lineno="897"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>SPIFFS_CACHE_DBG(</highlight><highlight class="stringliteral">&quot;CACHE_WR_DUMP:<sp/>dumping<sp/>cache<sp/>page<sp/>&quot;</highlight><highlight class="normal">_SPIPRIi</highlight><highlight class="stringliteral">&quot;<sp/>for<sp/>fd<sp/>&quot;</highlight><highlight class="normal">_SPIPRIfd</highlight><highlight class="stringliteral">&quot;:&quot;</highlight><highlight class="normal">_SPIPRIid</highlight><highlight class="stringliteral">&quot;,<sp/>flush,<sp/>offs:&quot;</highlight><highlight class="normal">_SPIPRIi</highlight><highlight class="stringliteral">&quot;<sp/>size:&quot;</highlight><highlight class="normal">_SPIPRIi</highlight><highlight class="stringliteral">&quot;\n&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="898"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>fd-&gt;cache_page-&gt;ix,<sp/>fd-&gt;file_nbr,<sp/><sp/>fd-&gt;obj_id,<sp/>fd-&gt;cache_page-&gt;offset,<sp/>fd-&gt;cache_page-&gt;size);</highlight></codeline>
<codeline lineno="899"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>res<sp/>=<sp/>spiffs_hydro_write(fs,<sp/>fd,</highlight></codeline>
<codeline lineno="900"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>spiffs_get_cache_page(fs,<sp/>spiffs_get_cache(fs),<sp/>fd-&gt;cache_page-&gt;ix),</highlight></codeline>
<codeline lineno="901"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>fd-&gt;cache_page-&gt;offset,<sp/>fd-&gt;cache_page-&gt;size);</highlight></codeline>
<codeline lineno="902"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(res<sp/>&lt;<sp/>SPIFFS_OK)<sp/>{</highlight></codeline>
<codeline lineno="903"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>fs-&gt;err_code<sp/>=<sp/>res;</highlight></codeline>
<codeline lineno="904"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="905"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>spiffs_cache_fd_release(fs,<sp/>fd-&gt;cache_page);</highlight></codeline>
<codeline lineno="906"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="907"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="908"><highlight class="normal"></highlight><highlight class="preprocessor">#endif</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="909"><highlight class="normal"></highlight></codeline>
<codeline lineno="910"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>res;</highlight></codeline>
<codeline lineno="911"><highlight class="normal">}</highlight></codeline>
<codeline lineno="912"><highlight class="normal"></highlight><highlight class="preprocessor">#endif</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="913"><highlight class="normal"></highlight></codeline>
<codeline lineno="914"><highlight class="normal">s32_t<sp/>SPIFFS_fflush(<ref refid="structspiffs__t" kindref="compound">spiffs</ref><sp/>*fs,<sp/>spiffs_file<sp/>fh)<sp/>{</highlight></codeline>
<codeline lineno="915"><highlight class="normal"><sp/><sp/>SPIFFS_API_DBG(</highlight><highlight class="stringliteral">&quot;%s<sp/>&quot;</highlight><highlight class="normal">_SPIPRIfd<sp/></highlight><highlight class="stringliteral">&quot;\n&quot;</highlight><highlight class="normal">,<sp/>__func__,<sp/>fh);</highlight></codeline>
<codeline lineno="916"><highlight class="normal"><sp/><sp/>(void)fh;</highlight></codeline>
<codeline lineno="917"><highlight class="normal"><sp/><sp/>SPIFFS_API_CHECK_CFG(fs);</highlight></codeline>
<codeline lineno="918"><highlight class="normal"><sp/><sp/>SPIFFS_API_CHECK_MOUNT(fs);</highlight></codeline>
<codeline lineno="919"><highlight class="normal"><sp/><sp/>s32_t<sp/>res<sp/>=<sp/>SPIFFS_OK;</highlight></codeline>
<codeline lineno="920"><highlight class="normal"></highlight><highlight class="preprocessor">#if<sp/>!SPIFFS_READ_ONLY<sp/>&amp;&amp;<sp/>SPIFFS_CACHE_WR</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="921"><highlight class="normal"><sp/><sp/>SPIFFS_LOCK(fs);</highlight></codeline>
<codeline lineno="922"><highlight class="normal"><sp/><sp/>fh<sp/>=<sp/>SPIFFS_FH_UNOFFS(fs,<sp/>fh);</highlight></codeline>
<codeline lineno="923"><highlight class="normal"><sp/><sp/>res<sp/>=<sp/>spiffs_fflush_cache(fs,<sp/>fh);</highlight></codeline>
<codeline lineno="924"><highlight class="normal"><sp/><sp/>SPIFFS_API_CHECK_RES_UNLOCK(fs,res);</highlight></codeline>
<codeline lineno="925"><highlight class="normal"><sp/><sp/>SPIFFS_UNLOCK(fs);</highlight></codeline>
<codeline lineno="926"><highlight class="normal"></highlight><highlight class="preprocessor">#endif</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="927"><highlight class="normal"></highlight></codeline>
<codeline lineno="928"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>res;</highlight></codeline>
<codeline lineno="929"><highlight class="normal">}</highlight></codeline>
<codeline lineno="930"><highlight class="normal"></highlight></codeline>
<codeline lineno="931"><highlight class="normal">s32_t<sp/>SPIFFS_close(<ref refid="structspiffs__t" kindref="compound">spiffs</ref><sp/>*fs,<sp/>spiffs_file<sp/>fh)<sp/>{</highlight></codeline>
<codeline lineno="932"><highlight class="normal"><sp/><sp/>SPIFFS_API_DBG(</highlight><highlight class="stringliteral">&quot;%s<sp/>&quot;</highlight><highlight class="normal">_SPIPRIfd<sp/></highlight><highlight class="stringliteral">&quot;\n&quot;</highlight><highlight class="normal">,<sp/>__func__,<sp/>fh);</highlight></codeline>
<codeline lineno="933"><highlight class="normal"><sp/><sp/>SPIFFS_API_CHECK_CFG(fs);</highlight></codeline>
<codeline lineno="934"><highlight class="normal"><sp/><sp/>SPIFFS_API_CHECK_MOUNT(fs);</highlight></codeline>
<codeline lineno="935"><highlight class="normal"></highlight></codeline>
<codeline lineno="936"><highlight class="normal"><sp/><sp/>s32_t<sp/>res<sp/>=<sp/>SPIFFS_OK;</highlight></codeline>
<codeline lineno="937"><highlight class="normal"><sp/><sp/>SPIFFS_LOCK(fs);</highlight></codeline>
<codeline lineno="938"><highlight class="normal"></highlight></codeline>
<codeline lineno="939"><highlight class="normal"><sp/><sp/>fh<sp/>=<sp/>SPIFFS_FH_UNOFFS(fs,<sp/>fh);</highlight></codeline>
<codeline lineno="940"><highlight class="normal"></highlight><highlight class="preprocessor">#if<sp/>SPIFFS_CACHE</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="941"><highlight class="normal"><sp/><sp/>res<sp/>=<sp/>spiffs_fflush_cache(fs,<sp/>fh);</highlight></codeline>
<codeline lineno="942"><highlight class="normal"><sp/><sp/>SPIFFS_API_CHECK_RES_UNLOCK(fs,<sp/>res);</highlight></codeline>
<codeline lineno="943"><highlight class="normal"></highlight><highlight class="preprocessor">#endif</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="944"><highlight class="normal"><sp/><sp/>res<sp/>=<sp/>spiffs_fd_return(fs,<sp/>fh);</highlight></codeline>
<codeline lineno="945"><highlight class="normal"><sp/><sp/>SPIFFS_API_CHECK_RES_UNLOCK(fs,<sp/>res);</highlight></codeline>
<codeline lineno="946"><highlight class="normal"></highlight></codeline>
<codeline lineno="947"><highlight class="normal"><sp/><sp/>SPIFFS_UNLOCK(fs);</highlight></codeline>
<codeline lineno="948"><highlight class="normal"></highlight></codeline>
<codeline lineno="949"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>res;</highlight></codeline>
<codeline lineno="950"><highlight class="normal">}</highlight></codeline>
<codeline lineno="951"><highlight class="normal"></highlight></codeline>
<codeline lineno="952"><highlight class="normal">s32_t<sp/>SPIFFS_rename(<ref refid="structspiffs__t" kindref="compound">spiffs</ref><sp/>*fs,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*old_path,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*new_path)<sp/>{</highlight></codeline>
<codeline lineno="953"><highlight class="normal"><sp/><sp/>SPIFFS_API_DBG(</highlight><highlight class="stringliteral">&quot;%s<sp/>%s<sp/>%s\n&quot;</highlight><highlight class="normal">,<sp/>__func__,<sp/>old_path,<sp/>new_path);</highlight></codeline>
<codeline lineno="954"><highlight class="normal"></highlight><highlight class="preprocessor">#if<sp/>SPIFFS_READ_ONLY</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="955"><highlight class="normal"><sp/><sp/>(void)fs;<sp/>(void)old_path;<sp/>(void)new_path;</highlight></codeline>
<codeline lineno="956"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>SPIFFS_ERR_RO_NOT_IMPL;</highlight></codeline>
<codeline lineno="957"><highlight class="normal"></highlight><highlight class="preprocessor">#else</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="958"><highlight class="normal"><sp/><sp/>SPIFFS_API_CHECK_CFG(fs);</highlight></codeline>
<codeline lineno="959"><highlight class="normal"><sp/><sp/>SPIFFS_API_CHECK_MOUNT(fs);</highlight></codeline>
<codeline lineno="960"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(strlen(new_path)<sp/>&gt;<sp/>SPIFFS_OBJ_NAME_LEN<sp/>-<sp/>1<sp/>||</highlight></codeline>
<codeline lineno="961"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>strlen(old_path)<sp/>&gt;<sp/>SPIFFS_OBJ_NAME_LEN<sp/>-<sp/>1)<sp/>{</highlight></codeline>
<codeline lineno="962"><highlight class="normal"><sp/><sp/><sp/><sp/>SPIFFS_API_CHECK_RES(fs,<sp/>SPIFFS_ERR_NAME_TOO_LONG);</highlight></codeline>
<codeline lineno="963"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="964"><highlight class="normal"><sp/><sp/>SPIFFS_LOCK(fs);</highlight></codeline>
<codeline lineno="965"><highlight class="normal"></highlight></codeline>
<codeline lineno="966"><highlight class="normal"><sp/><sp/>spiffs_page_ix<sp/>pix_old,<sp/>pix_dummy;</highlight></codeline>
<codeline lineno="967"><highlight class="normal"><sp/><sp/><ref refid="structspiffs__fd" kindref="compound">spiffs_fd</ref><sp/>*fd;</highlight></codeline>
<codeline lineno="968"><highlight class="normal"></highlight></codeline>
<codeline lineno="969"><highlight class="normal"><sp/><sp/>s32_t<sp/>res<sp/>=<sp/>spiffs_object_find_object_index_header_by_name(fs,<sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>u8_t*)old_path,<sp/>&amp;pix_old);</highlight></codeline>
<codeline lineno="970"><highlight class="normal"><sp/><sp/>SPIFFS_API_CHECK_RES_UNLOCK(fs,<sp/>res);</highlight></codeline>
<codeline lineno="971"><highlight class="normal"></highlight></codeline>
<codeline lineno="972"><highlight class="normal"><sp/><sp/>res<sp/>=<sp/>spiffs_object_find_object_index_header_by_name(fs,<sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>u8_t*)new_path,<sp/>&amp;pix_dummy);</highlight></codeline>
<codeline lineno="973"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(res<sp/>==<sp/>SPIFFS_ERR_NOT_FOUND)<sp/>{</highlight></codeline>
<codeline lineno="974"><highlight class="normal"><sp/><sp/><sp/><sp/>res<sp/>=<sp/>SPIFFS_OK;</highlight></codeline>
<codeline lineno="975"><highlight class="normal"><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(res<sp/>==<sp/>SPIFFS_OK)<sp/>{</highlight></codeline>
<codeline lineno="976"><highlight class="normal"><sp/><sp/><sp/><sp/>res<sp/>=<sp/>SPIFFS_ERR_CONFLICTING_NAME;</highlight></codeline>
<codeline lineno="977"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="978"><highlight class="normal"><sp/><sp/>SPIFFS_API_CHECK_RES_UNLOCK(fs,<sp/>res);</highlight></codeline>
<codeline lineno="979"><highlight class="normal"></highlight></codeline>
<codeline lineno="980"><highlight class="normal"><sp/><sp/>res<sp/>=<sp/>spiffs_fd_find_new(fs,<sp/>&amp;fd,<sp/>0);</highlight></codeline>
<codeline lineno="981"><highlight class="normal"><sp/><sp/>SPIFFS_API_CHECK_RES_UNLOCK(fs,<sp/>res);</highlight></codeline>
<codeline lineno="982"><highlight class="normal"></highlight></codeline>
<codeline lineno="983"><highlight class="normal"><sp/><sp/>res<sp/>=<sp/>spiffs_object_open_by_page(fs,<sp/>pix_old,<sp/>fd,<sp/>0,<sp/>0);</highlight></codeline>
<codeline lineno="984"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(res<sp/>!=<sp/>SPIFFS_OK)<sp/>{</highlight></codeline>
<codeline lineno="985"><highlight class="normal"><sp/><sp/><sp/><sp/>spiffs_fd_return(fs,<sp/>fd-&gt;file_nbr);</highlight></codeline>
<codeline lineno="986"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="987"><highlight class="normal"><sp/><sp/>SPIFFS_API_CHECK_RES_UNLOCK(fs,<sp/>res);</highlight></codeline>
<codeline lineno="988"><highlight class="normal"></highlight></codeline>
<codeline lineno="989"><highlight class="normal"><sp/><sp/>res<sp/>=<sp/>spiffs_object_update_index_hdr(fs,<sp/>fd,<sp/>fd-&gt;obj_id,<sp/>fd-&gt;objix_hdr_pix,<sp/>0,<sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>u8_t*)new_path,</highlight></codeline>
<codeline lineno="990"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>0,<sp/>0,<sp/>&amp;pix_dummy);</highlight></codeline>
<codeline lineno="991"><highlight class="normal"></highlight><highlight class="preprocessor">#if<sp/>SPIFFS_TEMPORAL_FD_CACHE</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="992"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(res<sp/>==<sp/>SPIFFS_OK)<sp/>{</highlight></codeline>
<codeline lineno="993"><highlight class="normal"><sp/><sp/><sp/><sp/>spiffs_fd_temporal_cache_rehash(fs,<sp/>old_path,<sp/>new_path);</highlight></codeline>
<codeline lineno="994"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="995"><highlight class="normal"></highlight><highlight class="preprocessor">#endif</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="996"><highlight class="normal"></highlight></codeline>
<codeline lineno="997"><highlight class="normal"><sp/><sp/>spiffs_fd_return(fs,<sp/>fd-&gt;file_nbr);</highlight></codeline>
<codeline lineno="998"><highlight class="normal"></highlight></codeline>
<codeline lineno="999"><highlight class="normal"><sp/><sp/>SPIFFS_API_CHECK_RES_UNLOCK(fs,<sp/>res);</highlight></codeline>
<codeline lineno="1000"><highlight class="normal"></highlight></codeline>
<codeline lineno="1001"><highlight class="normal"><sp/><sp/>SPIFFS_UNLOCK(fs);</highlight></codeline>
<codeline lineno="1002"><highlight class="normal"></highlight></codeline>
<codeline lineno="1003"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>res;</highlight></codeline>
<codeline lineno="1004"><highlight class="normal"></highlight><highlight class="preprocessor">#endif<sp/>//<sp/>SPIFFS_READ_ONLY</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1005"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1006"><highlight class="normal"></highlight></codeline>
<codeline lineno="1007"><highlight class="normal"></highlight><highlight class="preprocessor">#if<sp/>SPIFFS_OBJ_META_LEN</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1008"><highlight class="normal">s32_t<sp/>SPIFFS_update_meta(<ref refid="structspiffs__t" kindref="compound">spiffs</ref><sp/>*fs,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*name,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>*meta)<sp/>{</highlight></codeline>
<codeline lineno="1009"><highlight class="normal"></highlight><highlight class="preprocessor">#if<sp/>SPIFFS_READ_ONLY</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1010"><highlight class="normal"><sp/><sp/>(void)fs;<sp/>(void)name;<sp/>(void)meta;</highlight></codeline>
<codeline lineno="1011"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>SPIFFS_ERR_RO_NOT_IMPL;</highlight></codeline>
<codeline lineno="1012"><highlight class="normal"></highlight><highlight class="preprocessor">#else</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1013"><highlight class="normal"><sp/><sp/>SPIFFS_API_CHECK_CFG(fs);</highlight></codeline>
<codeline lineno="1014"><highlight class="normal"><sp/><sp/>SPIFFS_API_CHECK_MOUNT(fs);</highlight></codeline>
<codeline lineno="1015"><highlight class="normal"><sp/><sp/>SPIFFS_LOCK(fs);</highlight></codeline>
<codeline lineno="1016"><highlight class="normal"></highlight></codeline>
<codeline lineno="1017"><highlight class="normal"><sp/><sp/>spiffs_page_ix<sp/>pix,<sp/>pix_dummy;</highlight></codeline>
<codeline lineno="1018"><highlight class="normal"><sp/><sp/><ref refid="structspiffs__fd" kindref="compound">spiffs_fd</ref><sp/>*fd;</highlight></codeline>
<codeline lineno="1019"><highlight class="normal"></highlight></codeline>
<codeline lineno="1020"><highlight class="normal"><sp/><sp/>s32_t<sp/>res<sp/>=<sp/>spiffs_object_find_object_index_header_by_name(fs,<sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>u8_t*)name,<sp/>&amp;pix);</highlight></codeline>
<codeline lineno="1021"><highlight class="normal"><sp/><sp/>SPIFFS_API_CHECK_RES_UNLOCK(fs,<sp/>res);</highlight></codeline>
<codeline lineno="1022"><highlight class="normal"></highlight></codeline>
<codeline lineno="1023"><highlight class="normal"><sp/><sp/>res<sp/>=<sp/>spiffs_fd_find_new(fs,<sp/>&amp;fd,<sp/>0);</highlight></codeline>
<codeline lineno="1024"><highlight class="normal"><sp/><sp/>SPIFFS_API_CHECK_RES_UNLOCK(fs,<sp/>res);</highlight></codeline>
<codeline lineno="1025"><highlight class="normal"></highlight></codeline>
<codeline lineno="1026"><highlight class="normal"><sp/><sp/>res<sp/>=<sp/>spiffs_object_open_by_page(fs,<sp/>pix,<sp/>fd,<sp/>0,<sp/>0);</highlight></codeline>
<codeline lineno="1027"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(res<sp/>!=<sp/>SPIFFS_OK)<sp/>{</highlight></codeline>
<codeline lineno="1028"><highlight class="normal"><sp/><sp/><sp/><sp/>spiffs_fd_return(fs,<sp/>fd-&gt;file_nbr);</highlight></codeline>
<codeline lineno="1029"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="1030"><highlight class="normal"><sp/><sp/>SPIFFS_API_CHECK_RES_UNLOCK(fs,<sp/>res);</highlight></codeline>
<codeline lineno="1031"><highlight class="normal"></highlight></codeline>
<codeline lineno="1032"><highlight class="normal"><sp/><sp/>res<sp/>=<sp/>spiffs_object_update_index_hdr(fs,<sp/>fd,<sp/>fd-&gt;obj_id,<sp/>fd-&gt;objix_hdr_pix,<sp/>0,<sp/>0,<sp/>meta,</highlight></codeline>
<codeline lineno="1033"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>0,<sp/>&amp;pix_dummy);</highlight></codeline>
<codeline lineno="1034"><highlight class="normal"></highlight></codeline>
<codeline lineno="1035"><highlight class="normal"><sp/><sp/>spiffs_fd_return(fs,<sp/>fd-&gt;file_nbr);</highlight></codeline>
<codeline lineno="1036"><highlight class="normal"></highlight></codeline>
<codeline lineno="1037"><highlight class="normal"><sp/><sp/>SPIFFS_API_CHECK_RES_UNLOCK(fs,<sp/>res);</highlight></codeline>
<codeline lineno="1038"><highlight class="normal"></highlight></codeline>
<codeline lineno="1039"><highlight class="normal"><sp/><sp/>SPIFFS_UNLOCK(fs);</highlight></codeline>
<codeline lineno="1040"><highlight class="normal"></highlight></codeline>
<codeline lineno="1041"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>res;</highlight></codeline>
<codeline lineno="1042"><highlight class="normal"></highlight><highlight class="preprocessor">#endif<sp/>//<sp/>SPIFFS_READ_ONLY</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1043"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1044"><highlight class="normal"></highlight></codeline>
<codeline lineno="1045"><highlight class="normal">s32_t<sp/>SPIFFS_fupdate_meta(<ref refid="structspiffs__t" kindref="compound">spiffs</ref><sp/>*fs,<sp/>spiffs_file<sp/>fh,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>*meta)<sp/>{</highlight></codeline>
<codeline lineno="1046"><highlight class="normal"></highlight><highlight class="preprocessor">#if<sp/>SPIFFS_READ_ONLY</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1047"><highlight class="normal"><sp/><sp/>(void)fs;<sp/>(void)fh;<sp/>(void)meta;</highlight></codeline>
<codeline lineno="1048"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>SPIFFS_ERR_RO_NOT_IMPL;</highlight></codeline>
<codeline lineno="1049"><highlight class="normal"></highlight><highlight class="preprocessor">#else</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1050"><highlight class="normal"><sp/><sp/>SPIFFS_API_CHECK_CFG(fs);</highlight></codeline>
<codeline lineno="1051"><highlight class="normal"><sp/><sp/>SPIFFS_API_CHECK_MOUNT(fs);</highlight></codeline>
<codeline lineno="1052"><highlight class="normal"><sp/><sp/>SPIFFS_LOCK(fs);</highlight></codeline>
<codeline lineno="1053"><highlight class="normal"></highlight></codeline>
<codeline lineno="1054"><highlight class="normal"><sp/><sp/>s32_t<sp/>res;</highlight></codeline>
<codeline lineno="1055"><highlight class="normal"><sp/><sp/><ref refid="structspiffs__fd" kindref="compound">spiffs_fd</ref><sp/>*fd;</highlight></codeline>
<codeline lineno="1056"><highlight class="normal"><sp/><sp/>spiffs_page_ix<sp/>pix_dummy;</highlight></codeline>
<codeline lineno="1057"><highlight class="normal"></highlight></codeline>
<codeline lineno="1058"><highlight class="normal"><sp/><sp/>fh<sp/>=<sp/>SPIFFS_FH_UNOFFS(fs,<sp/>fh);</highlight></codeline>
<codeline lineno="1059"><highlight class="normal"><sp/><sp/>res<sp/>=<sp/>spiffs_fd_get(fs,<sp/>fh,<sp/>&amp;fd);</highlight></codeline>
<codeline lineno="1060"><highlight class="normal"><sp/><sp/>SPIFFS_API_CHECK_RES_UNLOCK(fs,<sp/>res);</highlight></codeline>
<codeline lineno="1061"><highlight class="normal"></highlight></codeline>
<codeline lineno="1062"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>((fd-&gt;flags<sp/>&amp;<sp/>SPIFFS_O_WRONLY)<sp/>==<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="1063"><highlight class="normal"><sp/><sp/><sp/><sp/>res<sp/>=<sp/>SPIFFS_ERR_NOT_WRITABLE;</highlight></codeline>
<codeline lineno="1064"><highlight class="normal"><sp/><sp/><sp/><sp/>SPIFFS_API_CHECK_RES_UNLOCK(fs,<sp/>res);</highlight></codeline>
<codeline lineno="1065"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="1066"><highlight class="normal"></highlight></codeline>
<codeline lineno="1067"><highlight class="normal"><sp/><sp/>res<sp/>=<sp/>spiffs_object_update_index_hdr(fs,<sp/>fd,<sp/>fd-&gt;obj_id,<sp/>fd-&gt;objix_hdr_pix,<sp/>0,<sp/>0,<sp/>meta,</highlight></codeline>
<codeline lineno="1068"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>0,<sp/>&amp;pix_dummy);</highlight></codeline>
<codeline lineno="1069"><highlight class="normal"></highlight></codeline>
<codeline lineno="1070"><highlight class="normal"><sp/><sp/>SPIFFS_API_CHECK_RES_UNLOCK(fs,<sp/>res);</highlight></codeline>
<codeline lineno="1071"><highlight class="normal"></highlight></codeline>
<codeline lineno="1072"><highlight class="normal"><sp/><sp/>SPIFFS_UNLOCK(fs);</highlight></codeline>
<codeline lineno="1073"><highlight class="normal"></highlight></codeline>
<codeline lineno="1074"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>res;</highlight></codeline>
<codeline lineno="1075"><highlight class="normal"></highlight><highlight class="preprocessor">#endif<sp/>//<sp/>SPIFFS_READ_ONLY</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1076"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1077"><highlight class="normal"></highlight><highlight class="preprocessor">#endif<sp/>//<sp/>SPIFFS_OBJ_META_LEN</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1078"><highlight class="normal"></highlight></codeline>
<codeline lineno="1079"><highlight class="normal"><ref refid="structspiffs___d_i_r" kindref="compound">spiffs_DIR</ref><sp/>*SPIFFS_opendir(<ref refid="structspiffs__t" kindref="compound">spiffs</ref><sp/>*fs,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*name,<sp/><ref refid="structspiffs___d_i_r" kindref="compound">spiffs_DIR</ref><sp/>*d)<sp/>{</highlight></codeline>
<codeline lineno="1080"><highlight class="normal"><sp/><sp/>SPIFFS_API_DBG(</highlight><highlight class="stringliteral">&quot;%s\n&quot;</highlight><highlight class="normal">,<sp/>__func__);</highlight></codeline>
<codeline lineno="1081"><highlight class="normal"><sp/><sp/>(void)name;</highlight></codeline>
<codeline lineno="1082"><highlight class="normal"></highlight></codeline>
<codeline lineno="1083"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!SPIFFS_CHECK_CFG((fs)))<sp/>{</highlight></codeline>
<codeline lineno="1084"><highlight class="normal"><sp/><sp/><sp/><sp/>(fs)-&gt;err_code<sp/>=<sp/>SPIFFS_ERR_NOT_CONFIGURED;</highlight></codeline>
<codeline lineno="1085"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0;</highlight></codeline>
<codeline lineno="1086"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="1087"><highlight class="normal"></highlight></codeline>
<codeline lineno="1088"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!SPIFFS_CHECK_MOUNT(fs))<sp/>{</highlight></codeline>
<codeline lineno="1089"><highlight class="normal"><sp/><sp/><sp/><sp/>fs-&gt;err_code<sp/>=<sp/>SPIFFS_ERR_NOT_MOUNTED;</highlight></codeline>
<codeline lineno="1090"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0;</highlight></codeline>
<codeline lineno="1091"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="1092"><highlight class="normal"></highlight></codeline>
<codeline lineno="1093"><highlight class="normal"><sp/><sp/>d-&gt;fs<sp/>=<sp/>fs;</highlight></codeline>
<codeline lineno="1094"><highlight class="normal"><sp/><sp/>d-&gt;block<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="1095"><highlight class="normal"><sp/><sp/>d-&gt;entry<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="1096"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>d;</highlight></codeline>
<codeline lineno="1097"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1098"><highlight class="normal"></highlight></codeline>
<codeline lineno="1099"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/>s32_t<sp/>spiffs_read_dir_v(</highlight></codeline>
<codeline lineno="1100"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="structspiffs__t" kindref="compound">spiffs</ref><sp/>*fs,</highlight></codeline>
<codeline lineno="1101"><highlight class="normal"><sp/><sp/><sp/><sp/>spiffs_obj_id<sp/>obj_id,</highlight></codeline>
<codeline lineno="1102"><highlight class="normal"><sp/><sp/><sp/><sp/>spiffs_block_ix<sp/>bix,</highlight></codeline>
<codeline lineno="1103"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>ix_entry,</highlight></codeline>
<codeline lineno="1104"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>*user_const_p,</highlight></codeline>
<codeline lineno="1105"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>*user_var_p)<sp/>{</highlight></codeline>
<codeline lineno="1106"><highlight class="normal"><sp/><sp/>(void)user_const_p;</highlight></codeline>
<codeline lineno="1107"><highlight class="normal"><sp/><sp/>s32_t<sp/>res;</highlight></codeline>
<codeline lineno="1108"><highlight class="normal"><sp/><sp/><ref refid="struct_s_p_i_f_f_s___p_a_c_k_e_d" kindref="compound">spiffs_page_object_ix_header</ref><sp/>objix_hdr;</highlight></codeline>
<codeline lineno="1109"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(obj_id<sp/>==<sp/>SPIFFS_OBJ_ID_FREE<sp/>||<sp/>obj_id<sp/>==<sp/>SPIFFS_OBJ_ID_DELETED<sp/>||</highlight></codeline>
<codeline lineno="1110"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>(obj_id<sp/>&amp;<sp/>SPIFFS_OBJ_ID_IX_FLAG)<sp/>==<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="1111"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>SPIFFS_VIS_COUNTINUE;</highlight></codeline>
<codeline lineno="1112"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="1113"><highlight class="normal"></highlight></codeline>
<codeline lineno="1114"><highlight class="normal"><sp/><sp/>spiffs_page_ix<sp/>pix<sp/>=<sp/>SPIFFS_OBJ_LOOKUP_ENTRY_TO_PIX(fs,<sp/>bix,<sp/>ix_entry);</highlight></codeline>
<codeline lineno="1115"><highlight class="normal"><sp/><sp/>res<sp/>=<sp/>_spiffs_rd(fs,<sp/>SPIFFS_OP_T_OBJ_LU2<sp/>|<sp/>SPIFFS_OP_C_READ,</highlight></codeline>
<codeline lineno="1116"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>0,<sp/>SPIFFS_PAGE_TO_PADDR(fs,<sp/>pix),<sp/></highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(<ref refid="struct_s_p_i_f_f_s___p_a_c_k_e_d" kindref="compound">spiffs_page_object_ix_header</ref>),<sp/>(u8_t<sp/>*)&amp;objix_hdr);</highlight></codeline>
<codeline lineno="1117"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(res<sp/>!=<sp/>SPIFFS_OK)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>res;</highlight></codeline>
<codeline lineno="1118"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>((obj_id<sp/>&amp;<sp/>SPIFFS_OBJ_ID_IX_FLAG)<sp/>&amp;&amp;</highlight></codeline>
<codeline lineno="1119"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>objix_hdr.p_hdr.span_ix<sp/>==<sp/>0<sp/>&amp;&amp;</highlight></codeline>
<codeline lineno="1120"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>(objix_hdr.p_hdr.flags<sp/>&amp;<sp/>(SPIFFS_PH_FLAG_DELET<sp/>|<sp/>SPIFFS_PH_FLAG_FINAL<sp/>|<sp/>SPIFFS_PH_FLAG_IXDELE))<sp/>==</highlight></codeline>
<codeline lineno="1121"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>(SPIFFS_PH_FLAG_DELET<sp/>|<sp/>SPIFFS_PH_FLAG_IXDELE))<sp/>{</highlight></codeline>
<codeline lineno="1122"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">struct<sp/></highlight><highlight class="normal"><ref refid="structspiffs__dirent" kindref="compound">spiffs_dirent</ref><sp/>*e<sp/>=<sp/>(</highlight><highlight class="keyword">struct<sp/></highlight><highlight class="normal"><ref refid="structspiffs__dirent" kindref="compound">spiffs_dirent</ref>*)user_var_p;</highlight></codeline>
<codeline lineno="1123"><highlight class="normal"><sp/><sp/><sp/><sp/>e-&gt;obj_id<sp/>=<sp/>obj_id;</highlight></codeline>
<codeline lineno="1124"><highlight class="normal"><sp/><sp/><sp/><sp/>strcpy((</highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*)e-&gt;name,<sp/>(</highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*)objix_hdr.name);</highlight></codeline>
<codeline lineno="1125"><highlight class="normal"><sp/><sp/><sp/><sp/>e-&gt;type<sp/>=<sp/>objix_hdr.type;</highlight></codeline>
<codeline lineno="1126"><highlight class="normal"><sp/><sp/><sp/><sp/>e-&gt;size<sp/>=<sp/>objix_hdr.size<sp/>==<sp/>SPIFFS_UNDEFINED_LEN<sp/>?<sp/>0<sp/>:<sp/>objix_hdr.size;</highlight></codeline>
<codeline lineno="1127"><highlight class="normal"><sp/><sp/><sp/><sp/>e-&gt;pix<sp/>=<sp/>pix;</highlight></codeline>
<codeline lineno="1128"><highlight class="normal"></highlight><highlight class="preprocessor">#if<sp/>SPIFFS_OBJ_META_LEN</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1129"><highlight class="normal"><sp/><sp/><sp/><sp/>_SPIFFS_MEMCPY(e-&gt;meta,<sp/>objix_hdr.meta,<sp/>SPIFFS_OBJ_META_LEN);</highlight></codeline>
<codeline lineno="1130"><highlight class="normal"></highlight><highlight class="preprocessor">#endif</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1131"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>SPIFFS_OK;</highlight></codeline>
<codeline lineno="1132"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="1133"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>SPIFFS_VIS_COUNTINUE;</highlight></codeline>
<codeline lineno="1134"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1135"><highlight class="normal"></highlight></codeline>
<codeline lineno="1136"><highlight class="normal"></highlight><highlight class="keyword">struct<sp/></highlight><highlight class="normal"><ref refid="structspiffs__dirent" kindref="compound">spiffs_dirent</ref><sp/>*SPIFFS_readdir(<ref refid="structspiffs___d_i_r" kindref="compound">spiffs_DIR</ref><sp/>*d,<sp/></highlight><highlight class="keyword">struct</highlight><highlight class="normal"><sp/><ref refid="structspiffs__dirent" kindref="compound">spiffs_dirent</ref><sp/>*e)<sp/>{</highlight></codeline>
<codeline lineno="1137"><highlight class="normal"><sp/><sp/>SPIFFS_API_DBG(</highlight><highlight class="stringliteral">&quot;%s\n&quot;</highlight><highlight class="normal">,<sp/>__func__);</highlight></codeline>
<codeline lineno="1138"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!SPIFFS_CHECK_MOUNT(d-&gt;fs))<sp/>{</highlight></codeline>
<codeline lineno="1139"><highlight class="normal"><sp/><sp/><sp/><sp/>d-&gt;fs-&gt;err_code<sp/>=<sp/>SPIFFS_ERR_NOT_MOUNTED;</highlight></codeline>
<codeline lineno="1140"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0;</highlight></codeline>
<codeline lineno="1141"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="1142"><highlight class="normal"><sp/><sp/>SPIFFS_LOCK(d-&gt;fs);</highlight></codeline>
<codeline lineno="1143"><highlight class="normal"></highlight></codeline>
<codeline lineno="1144"><highlight class="normal"><sp/><sp/>spiffs_block_ix<sp/>bix;</highlight></codeline>
<codeline lineno="1145"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>entry;</highlight></codeline>
<codeline lineno="1146"><highlight class="normal"><sp/><sp/>s32_t<sp/>res;</highlight></codeline>
<codeline lineno="1147"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">struct<sp/></highlight><highlight class="normal"><ref refid="structspiffs__dirent" kindref="compound">spiffs_dirent</ref><sp/>*ret<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="1148"><highlight class="normal"></highlight></codeline>
<codeline lineno="1149"><highlight class="normal"><sp/><sp/>res<sp/>=<sp/>spiffs_obj_lu_find_entry_visitor(d-&gt;fs,</highlight></codeline>
<codeline lineno="1150"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>d-&gt;block,</highlight></codeline>
<codeline lineno="1151"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>d-&gt;entry,</highlight></codeline>
<codeline lineno="1152"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>SPIFFS_VIS_NO_WRAP,</highlight></codeline>
<codeline lineno="1153"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>0,</highlight></codeline>
<codeline lineno="1154"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>spiffs_read_dir_v,</highlight></codeline>
<codeline lineno="1155"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>0,</highlight></codeline>
<codeline lineno="1156"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>e,</highlight></codeline>
<codeline lineno="1157"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>&amp;bix,</highlight></codeline>
<codeline lineno="1158"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>&amp;entry);</highlight></codeline>
<codeline lineno="1159"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(res<sp/>==<sp/>SPIFFS_OK)<sp/>{</highlight></codeline>
<codeline lineno="1160"><highlight class="normal"><sp/><sp/><sp/><sp/>d-&gt;block<sp/>=<sp/>bix;</highlight></codeline>
<codeline lineno="1161"><highlight class="normal"><sp/><sp/><sp/><sp/>d-&gt;entry<sp/>=<sp/>entry<sp/>+<sp/>1;</highlight></codeline>
<codeline lineno="1162"><highlight class="normal"><sp/><sp/><sp/><sp/>e-&gt;obj_id<sp/>&amp;=<sp/>~SPIFFS_OBJ_ID_IX_FLAG;</highlight></codeline>
<codeline lineno="1163"><highlight class="normal"><sp/><sp/><sp/><sp/>ret<sp/>=<sp/>e;</highlight></codeline>
<codeline lineno="1164"><highlight class="normal"><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="1165"><highlight class="normal"><sp/><sp/><sp/><sp/>d-&gt;fs-&gt;err_code<sp/>=<sp/>res;</highlight></codeline>
<codeline lineno="1166"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="1167"><highlight class="normal"><sp/><sp/>SPIFFS_UNLOCK(d-&gt;fs);</highlight></codeline>
<codeline lineno="1168"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>ret;</highlight></codeline>
<codeline lineno="1169"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1170"><highlight class="normal"></highlight></codeline>
<codeline lineno="1171"><highlight class="normal">s32_t<sp/>SPIFFS_closedir(<ref refid="structspiffs___d_i_r" kindref="compound">spiffs_DIR</ref><sp/>*d)<sp/>{</highlight></codeline>
<codeline lineno="1172"><highlight class="normal"><sp/><sp/>SPIFFS_API_DBG(</highlight><highlight class="stringliteral">&quot;%s\n&quot;</highlight><highlight class="normal">,<sp/>__func__);</highlight></codeline>
<codeline lineno="1173"><highlight class="normal"><sp/><sp/>SPIFFS_API_CHECK_CFG(d-&gt;fs);</highlight></codeline>
<codeline lineno="1174"><highlight class="normal"><sp/><sp/>SPIFFS_API_CHECK_MOUNT(d-&gt;fs);</highlight></codeline>
<codeline lineno="1175"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0;</highlight></codeline>
<codeline lineno="1176"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1177"><highlight class="normal"></highlight></codeline>
<codeline lineno="1178"><highlight class="normal">s32_t<sp/>SPIFFS_check(<ref refid="structspiffs__t" kindref="compound">spiffs</ref><sp/>*fs)<sp/>{</highlight></codeline>
<codeline lineno="1179"><highlight class="normal"><sp/><sp/>SPIFFS_API_DBG(</highlight><highlight class="stringliteral">&quot;%s\n&quot;</highlight><highlight class="normal">,<sp/>__func__);</highlight></codeline>
<codeline lineno="1180"><highlight class="normal"></highlight><highlight class="preprocessor">#if<sp/>SPIFFS_READ_ONLY</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1181"><highlight class="normal"><sp/><sp/>(void)fs;</highlight></codeline>
<codeline lineno="1182"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>SPIFFS_ERR_RO_NOT_IMPL;</highlight></codeline>
<codeline lineno="1183"><highlight class="normal"></highlight><highlight class="preprocessor">#else</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1184"><highlight class="normal"><sp/><sp/>s32_t<sp/>res;</highlight></codeline>
<codeline lineno="1185"><highlight class="normal"><sp/><sp/>SPIFFS_API_CHECK_CFG(fs);</highlight></codeline>
<codeline lineno="1186"><highlight class="normal"><sp/><sp/>SPIFFS_API_CHECK_MOUNT(fs);</highlight></codeline>
<codeline lineno="1187"><highlight class="normal"><sp/><sp/>SPIFFS_LOCK(fs);</highlight></codeline>
<codeline lineno="1188"><highlight class="normal"></highlight></codeline>
<codeline lineno="1189"><highlight class="normal"><sp/><sp/>res<sp/>=<sp/>spiffs_lookup_consistency_check(fs,<sp/>0);</highlight></codeline>
<codeline lineno="1190"><highlight class="normal"></highlight></codeline>
<codeline lineno="1191"><highlight class="normal"><sp/><sp/>res<sp/>=<sp/>spiffs_object_index_consistency_check(fs);</highlight></codeline>
<codeline lineno="1192"><highlight class="normal"></highlight></codeline>
<codeline lineno="1193"><highlight class="normal"><sp/><sp/>res<sp/>=<sp/>spiffs_page_consistency_check(fs);</highlight></codeline>
<codeline lineno="1194"><highlight class="normal"></highlight></codeline>
<codeline lineno="1195"><highlight class="normal"><sp/><sp/>res<sp/>=<sp/>spiffs_obj_lu_scan(fs);</highlight></codeline>
<codeline lineno="1196"><highlight class="normal"></highlight></codeline>
<codeline lineno="1197"><highlight class="normal"><sp/><sp/>SPIFFS_UNLOCK(fs);</highlight></codeline>
<codeline lineno="1198"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>res;</highlight></codeline>
<codeline lineno="1199"><highlight class="normal"></highlight><highlight class="preprocessor">#endif<sp/>//<sp/>SPIFFS_READ_ONLY</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1200"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1201"><highlight class="normal"></highlight></codeline>
<codeline lineno="1202"><highlight class="normal">s32_t<sp/>SPIFFS_info(<ref refid="structspiffs__t" kindref="compound">spiffs</ref><sp/>*fs,<sp/>u32_t<sp/>*total,<sp/>u32_t<sp/>*used)<sp/>{</highlight></codeline>
<codeline lineno="1203"><highlight class="normal"><sp/><sp/>SPIFFS_API_DBG(</highlight><highlight class="stringliteral">&quot;%s\n&quot;</highlight><highlight class="normal">,<sp/>__func__);</highlight></codeline>
<codeline lineno="1204"><highlight class="normal"><sp/><sp/>s32_t<sp/>res<sp/>=<sp/>SPIFFS_OK;</highlight></codeline>
<codeline lineno="1205"><highlight class="normal"><sp/><sp/>SPIFFS_API_CHECK_CFG(fs);</highlight></codeline>
<codeline lineno="1206"><highlight class="normal"><sp/><sp/>SPIFFS_API_CHECK_MOUNT(fs);</highlight></codeline>
<codeline lineno="1207"><highlight class="normal"><sp/><sp/>SPIFFS_LOCK(fs);</highlight></codeline>
<codeline lineno="1208"><highlight class="normal"></highlight></codeline>
<codeline lineno="1209"><highlight class="normal"><sp/><sp/>u32_t<sp/>pages_per_block<sp/>=<sp/>SPIFFS_PAGES_PER_BLOCK(fs);</highlight></codeline>
<codeline lineno="1210"><highlight class="normal"><sp/><sp/>u32_t<sp/>blocks<sp/>=<sp/>fs-&gt;block_count;</highlight></codeline>
<codeline lineno="1211"><highlight class="normal"><sp/><sp/>u32_t<sp/>obj_lu_pages<sp/>=<sp/>SPIFFS_OBJ_LOOKUP_PAGES(fs);</highlight></codeline>
<codeline lineno="1212"><highlight class="normal"><sp/><sp/>u32_t<sp/>data_page_size<sp/>=<sp/>SPIFFS_DATA_PAGE_SIZE(fs);</highlight></codeline>
<codeline lineno="1213"><highlight class="normal"><sp/><sp/>u32_t<sp/>total_data_pages<sp/>=<sp/>(blocks<sp/>-<sp/>2)<sp/>*<sp/>(pages_per_block<sp/>-<sp/>obj_lu_pages)<sp/>+<sp/>1;<sp/></highlight><highlight class="comment">//<sp/>-2<sp/>for<sp/>spare<sp/>blocks,<sp/>+1<sp/>for<sp/>emergency<sp/>page</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1214"><highlight class="normal"></highlight></codeline>
<codeline lineno="1215"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(total)<sp/>{</highlight></codeline>
<codeline lineno="1216"><highlight class="normal"><sp/><sp/><sp/><sp/>*total<sp/>=<sp/>total_data_pages<sp/>*<sp/>data_page_size;</highlight></codeline>
<codeline lineno="1217"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="1218"><highlight class="normal"></highlight></codeline>
<codeline lineno="1219"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(used)<sp/>{</highlight></codeline>
<codeline lineno="1220"><highlight class="normal"><sp/><sp/><sp/><sp/>*used<sp/>=<sp/>fs-&gt;stats_p_allocated<sp/>*<sp/>data_page_size;</highlight></codeline>
<codeline lineno="1221"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="1222"><highlight class="normal"></highlight></codeline>
<codeline lineno="1223"><highlight class="normal"><sp/><sp/>SPIFFS_UNLOCK(fs);</highlight></codeline>
<codeline lineno="1224"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>res;</highlight></codeline>
<codeline lineno="1225"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1226"><highlight class="normal"></highlight></codeline>
<codeline lineno="1227"><highlight class="normal">s32_t<sp/>SPIFFS_gc_quick(<ref refid="structspiffs__t" kindref="compound">spiffs</ref><sp/>*fs,<sp/>u16_t<sp/>max_free_pages)<sp/>{</highlight></codeline>
<codeline lineno="1228"><highlight class="normal"><sp/><sp/>SPIFFS_API_DBG(</highlight><highlight class="stringliteral">&quot;%s<sp/>&quot;</highlight><highlight class="normal">_SPIPRIi<sp/></highlight><highlight class="stringliteral">&quot;\n&quot;</highlight><highlight class="normal">,<sp/>__func__,<sp/>max_free_pages);</highlight></codeline>
<codeline lineno="1229"><highlight class="normal"></highlight><highlight class="preprocessor">#if<sp/>SPIFFS_READ_ONLY</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1230"><highlight class="normal"><sp/><sp/>(void)fs;<sp/>(void)max_free_pages;</highlight></codeline>
<codeline lineno="1231"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>SPIFFS_ERR_RO_NOT_IMPL;</highlight></codeline>
<codeline lineno="1232"><highlight class="normal"></highlight><highlight class="preprocessor">#else</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1233"><highlight class="normal"><sp/><sp/>s32_t<sp/>res;</highlight></codeline>
<codeline lineno="1234"><highlight class="normal"><sp/><sp/>SPIFFS_API_CHECK_CFG(fs);</highlight></codeline>
<codeline lineno="1235"><highlight class="normal"><sp/><sp/>SPIFFS_API_CHECK_MOUNT(fs);</highlight></codeline>
<codeline lineno="1236"><highlight class="normal"><sp/><sp/>SPIFFS_LOCK(fs);</highlight></codeline>
<codeline lineno="1237"><highlight class="normal"></highlight></codeline>
<codeline lineno="1238"><highlight class="normal"><sp/><sp/>res<sp/>=<sp/>spiffs_gc_quick(fs,<sp/>max_free_pages);</highlight></codeline>
<codeline lineno="1239"><highlight class="normal"></highlight></codeline>
<codeline lineno="1240"><highlight class="normal"><sp/><sp/>SPIFFS_API_CHECK_RES_UNLOCK(fs,<sp/>res);</highlight></codeline>
<codeline lineno="1241"><highlight class="normal"><sp/><sp/>SPIFFS_UNLOCK(fs);</highlight></codeline>
<codeline lineno="1242"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0;</highlight></codeline>
<codeline lineno="1243"><highlight class="normal"></highlight><highlight class="preprocessor">#endif<sp/>//<sp/>SPIFFS_READ_ONLY</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1244"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1245"><highlight class="normal"></highlight></codeline>
<codeline lineno="1246"><highlight class="normal"></highlight></codeline>
<codeline lineno="1247"><highlight class="normal">s32_t<sp/>SPIFFS_gc(<ref refid="structspiffs__t" kindref="compound">spiffs</ref><sp/>*fs,<sp/>u32_t<sp/>size)<sp/>{</highlight></codeline>
<codeline lineno="1248"><highlight class="normal"><sp/><sp/>SPIFFS_API_DBG(</highlight><highlight class="stringliteral">&quot;%s<sp/>&quot;</highlight><highlight class="normal">_SPIPRIi<sp/></highlight><highlight class="stringliteral">&quot;\n&quot;</highlight><highlight class="normal">,<sp/>__func__,<sp/>size);</highlight></codeline>
<codeline lineno="1249"><highlight class="normal"></highlight><highlight class="preprocessor">#if<sp/>SPIFFS_READ_ONLY</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1250"><highlight class="normal"><sp/><sp/>(void)fs;<sp/>(void)size;</highlight></codeline>
<codeline lineno="1251"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>SPIFFS_ERR_RO_NOT_IMPL;</highlight></codeline>
<codeline lineno="1252"><highlight class="normal"></highlight><highlight class="preprocessor">#else</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1253"><highlight class="normal"><sp/><sp/>s32_t<sp/>res;</highlight></codeline>
<codeline lineno="1254"><highlight class="normal"><sp/><sp/>SPIFFS_API_CHECK_CFG(fs);</highlight></codeline>
<codeline lineno="1255"><highlight class="normal"><sp/><sp/>SPIFFS_API_CHECK_MOUNT(fs);</highlight></codeline>
<codeline lineno="1256"><highlight class="normal"><sp/><sp/>SPIFFS_LOCK(fs);</highlight></codeline>
<codeline lineno="1257"><highlight class="normal"></highlight></codeline>
<codeline lineno="1258"><highlight class="normal"><sp/><sp/>res<sp/>=<sp/>spiffs_gc_check(fs,<sp/>size);</highlight></codeline>
<codeline lineno="1259"><highlight class="normal"></highlight></codeline>
<codeline lineno="1260"><highlight class="normal"><sp/><sp/>SPIFFS_API_CHECK_RES_UNLOCK(fs,<sp/>res);</highlight></codeline>
<codeline lineno="1261"><highlight class="normal"><sp/><sp/>SPIFFS_UNLOCK(fs);</highlight></codeline>
<codeline lineno="1262"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0;</highlight></codeline>
<codeline lineno="1263"><highlight class="normal"></highlight><highlight class="preprocessor">#endif<sp/>//<sp/>SPIFFS_READ_ONLY</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1264"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1265"><highlight class="normal"></highlight></codeline>
<codeline lineno="1266"><highlight class="normal">s32_t<sp/>SPIFFS_eof(<ref refid="structspiffs__t" kindref="compound">spiffs</ref><sp/>*fs,<sp/>spiffs_file<sp/>fh)<sp/>{</highlight></codeline>
<codeline lineno="1267"><highlight class="normal"><sp/><sp/>SPIFFS_API_DBG(</highlight><highlight class="stringliteral">&quot;%s<sp/>&quot;</highlight><highlight class="normal">_SPIPRIfd<sp/></highlight><highlight class="stringliteral">&quot;\n&quot;</highlight><highlight class="normal">,<sp/>__func__,<sp/>fh);</highlight></codeline>
<codeline lineno="1268"><highlight class="normal"><sp/><sp/>s32_t<sp/>res;</highlight></codeline>
<codeline lineno="1269"><highlight class="normal"><sp/><sp/>SPIFFS_API_CHECK_CFG(fs);</highlight></codeline>
<codeline lineno="1270"><highlight class="normal"><sp/><sp/>SPIFFS_API_CHECK_MOUNT(fs);</highlight></codeline>
<codeline lineno="1271"><highlight class="normal"><sp/><sp/>SPIFFS_LOCK(fs);</highlight></codeline>
<codeline lineno="1272"><highlight class="normal"></highlight></codeline>
<codeline lineno="1273"><highlight class="normal"><sp/><sp/>fh<sp/>=<sp/>SPIFFS_FH_UNOFFS(fs,<sp/>fh);</highlight></codeline>
<codeline lineno="1274"><highlight class="normal"></highlight></codeline>
<codeline lineno="1275"><highlight class="normal"><sp/><sp/><ref refid="structspiffs__fd" kindref="compound">spiffs_fd</ref><sp/>*fd;</highlight></codeline>
<codeline lineno="1276"><highlight class="normal"><sp/><sp/>res<sp/>=<sp/>spiffs_fd_get(fs,<sp/>fh,<sp/>&amp;fd);</highlight></codeline>
<codeline lineno="1277"><highlight class="normal"><sp/><sp/>SPIFFS_API_CHECK_RES_UNLOCK(fs,<sp/>res);</highlight></codeline>
<codeline lineno="1278"><highlight class="normal"></highlight></codeline>
<codeline lineno="1279"><highlight class="normal"></highlight><highlight class="preprocessor">#if<sp/>SPIFFS_CACHE_WR</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1280"><highlight class="normal"><sp/><sp/>res<sp/>=<sp/>spiffs_fflush_cache(fs,<sp/>fh);</highlight></codeline>
<codeline lineno="1281"><highlight class="normal"><sp/><sp/>SPIFFS_API_CHECK_RES_UNLOCK(fs,<sp/>res);</highlight></codeline>
<codeline lineno="1282"><highlight class="normal"></highlight><highlight class="preprocessor">#endif</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1283"><highlight class="normal"></highlight></codeline>
<codeline lineno="1284"><highlight class="normal"><sp/><sp/>res<sp/>=<sp/>(fd-&gt;fdoffset<sp/>&gt;=<sp/>(fd-&gt;size<sp/>==<sp/>SPIFFS_UNDEFINED_LEN<sp/>?<sp/>0<sp/>:<sp/>fd-&gt;size));</highlight></codeline>
<codeline lineno="1285"><highlight class="normal"></highlight></codeline>
<codeline lineno="1286"><highlight class="normal"><sp/><sp/>SPIFFS_UNLOCK(fs);</highlight></codeline>
<codeline lineno="1287"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>res;</highlight></codeline>
<codeline lineno="1288"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1289"><highlight class="normal"></highlight></codeline>
<codeline lineno="1290"><highlight class="normal">s32_t<sp/>SPIFFS_tell(<ref refid="structspiffs__t" kindref="compound">spiffs</ref><sp/>*fs,<sp/>spiffs_file<sp/>fh)<sp/>{</highlight></codeline>
<codeline lineno="1291"><highlight class="normal"><sp/><sp/>SPIFFS_API_DBG(</highlight><highlight class="stringliteral">&quot;%s<sp/>&quot;</highlight><highlight class="normal">_SPIPRIfd<sp/></highlight><highlight class="stringliteral">&quot;\n&quot;</highlight><highlight class="normal">,<sp/>__func__,<sp/>fh);</highlight></codeline>
<codeline lineno="1292"><highlight class="normal"><sp/><sp/>s32_t<sp/>res;</highlight></codeline>
<codeline lineno="1293"><highlight class="normal"><sp/><sp/>SPIFFS_API_CHECK_CFG(fs);</highlight></codeline>
<codeline lineno="1294"><highlight class="normal"><sp/><sp/>SPIFFS_API_CHECK_MOUNT(fs);</highlight></codeline>
<codeline lineno="1295"><highlight class="normal"><sp/><sp/>SPIFFS_LOCK(fs);</highlight></codeline>
<codeline lineno="1296"><highlight class="normal"></highlight></codeline>
<codeline lineno="1297"><highlight class="normal"><sp/><sp/>fh<sp/>=<sp/>SPIFFS_FH_UNOFFS(fs,<sp/>fh);</highlight></codeline>
<codeline lineno="1298"><highlight class="normal"></highlight></codeline>
<codeline lineno="1299"><highlight class="normal"><sp/><sp/><ref refid="structspiffs__fd" kindref="compound">spiffs_fd</ref><sp/>*fd;</highlight></codeline>
<codeline lineno="1300"><highlight class="normal"><sp/><sp/>res<sp/>=<sp/>spiffs_fd_get(fs,<sp/>fh,<sp/>&amp;fd);</highlight></codeline>
<codeline lineno="1301"><highlight class="normal"><sp/><sp/>SPIFFS_API_CHECK_RES_UNLOCK(fs,<sp/>res);</highlight></codeline>
<codeline lineno="1302"><highlight class="normal"></highlight></codeline>
<codeline lineno="1303"><highlight class="normal"></highlight><highlight class="preprocessor">#if<sp/>SPIFFS_CACHE_WR</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1304"><highlight class="normal"><sp/><sp/>res<sp/>=<sp/>spiffs_fflush_cache(fs,<sp/>fh);</highlight></codeline>
<codeline lineno="1305"><highlight class="normal"><sp/><sp/>SPIFFS_API_CHECK_RES_UNLOCK(fs,<sp/>res);</highlight></codeline>
<codeline lineno="1306"><highlight class="normal"></highlight><highlight class="preprocessor">#endif</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1307"><highlight class="normal"></highlight></codeline>
<codeline lineno="1308"><highlight class="normal"><sp/><sp/>res<sp/>=<sp/>fd-&gt;fdoffset;</highlight></codeline>
<codeline lineno="1309"><highlight class="normal"></highlight></codeline>
<codeline lineno="1310"><highlight class="normal"><sp/><sp/>SPIFFS_UNLOCK(fs);</highlight></codeline>
<codeline lineno="1311"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>res;</highlight></codeline>
<codeline lineno="1312"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1313"><highlight class="normal"></highlight></codeline>
<codeline lineno="1314"><highlight class="normal">s32_t<sp/>SPIFFS_set_file_callback_func(<ref refid="structspiffs__t" kindref="compound">spiffs</ref><sp/>*fs,<sp/>spiffs_file_callback<sp/>cb_func)<sp/>{</highlight></codeline>
<codeline lineno="1315"><highlight class="normal"><sp/><sp/>SPIFFS_API_DBG(</highlight><highlight class="stringliteral">&quot;%s\n&quot;</highlight><highlight class="normal">,<sp/>__func__);</highlight></codeline>
<codeline lineno="1316"><highlight class="normal"><sp/><sp/>SPIFFS_LOCK(fs);</highlight></codeline>
<codeline lineno="1317"><highlight class="normal"><sp/><sp/>fs-&gt;file_cb_f<sp/>=<sp/>cb_func;</highlight></codeline>
<codeline lineno="1318"><highlight class="normal"><sp/><sp/>SPIFFS_UNLOCK(fs);</highlight></codeline>
<codeline lineno="1319"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0;</highlight></codeline>
<codeline lineno="1320"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1321"><highlight class="normal"></highlight></codeline>
<codeline lineno="1322"><highlight class="normal"></highlight><highlight class="preprocessor">#if<sp/>SPIFFS_IX_MAP</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1323"><highlight class="normal"></highlight></codeline>
<codeline lineno="1324"><highlight class="normal">s32_t<sp/>SPIFFS_ix_map(<ref refid="structspiffs__t" kindref="compound">spiffs</ref><sp/>*fs,<sp/><sp/>spiffs_file<sp/>fh,<sp/><ref refid="structspiffs__ix__map" kindref="compound">spiffs_ix_map</ref><sp/>*map,</highlight></codeline>
<codeline lineno="1325"><highlight class="normal"><sp/><sp/><sp/><sp/>u32_t<sp/>offset,<sp/>u32_t<sp/>len,<sp/>spiffs_page_ix<sp/>*map_buf)<sp/>{</highlight></codeline>
<codeline lineno="1326"><highlight class="normal"><sp/><sp/>SPIFFS_API_DBG(</highlight><highlight class="stringliteral">&quot;%s<sp/>&quot;</highlight><highlight class="normal">_SPIPRIfd<sp/></highlight><highlight class="stringliteral">&quot;<sp/>&quot;</highlight><highlight class="normal">_SPIPRIi<sp/></highlight><highlight class="stringliteral">&quot;<sp/>&quot;</highlight><highlight class="normal">_SPIPRIi<sp/></highlight><highlight class="stringliteral">&quot;\n&quot;</highlight><highlight class="normal">,<sp/>__func__,<sp/>fh,<sp/>offset,<sp/>len);</highlight></codeline>
<codeline lineno="1327"><highlight class="normal"><sp/><sp/>s32_t<sp/>res;</highlight></codeline>
<codeline lineno="1328"><highlight class="normal"><sp/><sp/>SPIFFS_API_CHECK_CFG(fs);</highlight></codeline>
<codeline lineno="1329"><highlight class="normal"><sp/><sp/>SPIFFS_API_CHECK_MOUNT(fs);</highlight></codeline>
<codeline lineno="1330"><highlight class="normal"><sp/><sp/>SPIFFS_LOCK(fs);</highlight></codeline>
<codeline lineno="1331"><highlight class="normal"></highlight></codeline>
<codeline lineno="1332"><highlight class="normal"><sp/><sp/>fh<sp/>=<sp/>SPIFFS_FH_UNOFFS(fs,<sp/>fh);</highlight></codeline>
<codeline lineno="1333"><highlight class="normal"></highlight></codeline>
<codeline lineno="1334"><highlight class="normal"><sp/><sp/><ref refid="structspiffs__fd" kindref="compound">spiffs_fd</ref><sp/>*fd;</highlight></codeline>
<codeline lineno="1335"><highlight class="normal"><sp/><sp/>res<sp/>=<sp/>spiffs_fd_get(fs,<sp/>fh,<sp/>&amp;fd);</highlight></codeline>
<codeline lineno="1336"><highlight class="normal"><sp/><sp/>SPIFFS_API_CHECK_RES_UNLOCK(fs,<sp/>res);</highlight></codeline>
<codeline lineno="1337"><highlight class="normal"></highlight></codeline>
<codeline lineno="1338"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(fd-&gt;ix_map)<sp/>{</highlight></codeline>
<codeline lineno="1339"><highlight class="normal"><sp/><sp/><sp/><sp/>SPIFFS_API_CHECK_RES_UNLOCK(fs,<sp/>SPIFFS_ERR_IX_MAP_MAPPED);</highlight></codeline>
<codeline lineno="1340"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="1341"><highlight class="normal"></highlight></codeline>
<codeline lineno="1342"><highlight class="normal"><sp/><sp/>map-&gt;map_buf<sp/>=<sp/>map_buf;</highlight></codeline>
<codeline lineno="1343"><highlight class="normal"><sp/><sp/>map-&gt;offset<sp/>=<sp/>offset;</highlight></codeline>
<codeline lineno="1344"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>nb:<sp/>spix<sp/>range<sp/>includes<sp/>last</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1345"><highlight class="normal"><sp/><sp/>map-&gt;start_spix<sp/>=<sp/>offset<sp/>/<sp/>SPIFFS_DATA_PAGE_SIZE(fs);</highlight></codeline>
<codeline lineno="1346"><highlight class="normal"><sp/><sp/>map-&gt;end_spix<sp/>=<sp/>(offset<sp/>+<sp/>len)<sp/>/<sp/>SPIFFS_DATA_PAGE_SIZE(fs);</highlight></codeline>
<codeline lineno="1347"><highlight class="normal"><sp/><sp/>memset(map_buf,<sp/>0,<sp/></highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(spiffs_page_ix)<sp/>*<sp/>(map-&gt;end_spix<sp/>-<sp/>map-&gt;start_spix<sp/>+<sp/>1));</highlight></codeline>
<codeline lineno="1348"><highlight class="normal"><sp/><sp/>fd-&gt;ix_map<sp/>=<sp/>map;</highlight></codeline>
<codeline lineno="1349"><highlight class="normal"></highlight></codeline>
<codeline lineno="1350"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>scan<sp/>for<sp/>pixes</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1351"><highlight class="normal"><sp/><sp/>res<sp/>=<sp/>spiffs_populate_ix_map(fs,<sp/>fd,<sp/>0,<sp/>map-&gt;end_spix<sp/>-<sp/>map-&gt;start_spix<sp/>+<sp/>1);</highlight></codeline>
<codeline lineno="1352"><highlight class="normal"><sp/><sp/>SPIFFS_API_CHECK_RES_UNLOCK(fs,<sp/>res);</highlight></codeline>
<codeline lineno="1353"><highlight class="normal"></highlight></codeline>
<codeline lineno="1354"><highlight class="normal"><sp/><sp/>SPIFFS_UNLOCK(fs);</highlight></codeline>
<codeline lineno="1355"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>res;</highlight></codeline>
<codeline lineno="1356"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1357"><highlight class="normal"></highlight></codeline>
<codeline lineno="1358"><highlight class="normal">s32_t<sp/>SPIFFS_ix_unmap(<ref refid="structspiffs__t" kindref="compound">spiffs</ref><sp/>*fs,<sp/><sp/>spiffs_file<sp/>fh)<sp/>{</highlight></codeline>
<codeline lineno="1359"><highlight class="normal"><sp/><sp/>SPIFFS_API_DBG(</highlight><highlight class="stringliteral">&quot;%s<sp/>&quot;</highlight><highlight class="normal">_SPIPRIfd<sp/></highlight><highlight class="stringliteral">&quot;\n&quot;</highlight><highlight class="normal">,<sp/>__func__,<sp/>fh);</highlight></codeline>
<codeline lineno="1360"><highlight class="normal"><sp/><sp/>s32_t<sp/>res;</highlight></codeline>
<codeline lineno="1361"><highlight class="normal"><sp/><sp/>SPIFFS_API_CHECK_CFG(fs);</highlight></codeline>
<codeline lineno="1362"><highlight class="normal"><sp/><sp/>SPIFFS_API_CHECK_MOUNT(fs);</highlight></codeline>
<codeline lineno="1363"><highlight class="normal"><sp/><sp/>SPIFFS_LOCK(fs);</highlight></codeline>
<codeline lineno="1364"><highlight class="normal"></highlight></codeline>
<codeline lineno="1365"><highlight class="normal"><sp/><sp/>fh<sp/>=<sp/>SPIFFS_FH_UNOFFS(fs,<sp/>fh);</highlight></codeline>
<codeline lineno="1366"><highlight class="normal"></highlight></codeline>
<codeline lineno="1367"><highlight class="normal"><sp/><sp/><ref refid="structspiffs__fd" kindref="compound">spiffs_fd</ref><sp/>*fd;</highlight></codeline>
<codeline lineno="1368"><highlight class="normal"><sp/><sp/>res<sp/>=<sp/>spiffs_fd_get(fs,<sp/>fh,<sp/>&amp;fd);</highlight></codeline>
<codeline lineno="1369"><highlight class="normal"><sp/><sp/>SPIFFS_API_CHECK_RES_UNLOCK(fs,<sp/>res);</highlight></codeline>
<codeline lineno="1370"><highlight class="normal"></highlight></codeline>
<codeline lineno="1371"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(fd-&gt;ix_map<sp/>==<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="1372"><highlight class="normal"><sp/><sp/><sp/><sp/>SPIFFS_API_CHECK_RES_UNLOCK(fs,<sp/>SPIFFS_ERR_IX_MAP_UNMAPPED);</highlight></codeline>
<codeline lineno="1373"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="1374"><highlight class="normal"></highlight></codeline>
<codeline lineno="1375"><highlight class="normal"><sp/><sp/>fd-&gt;ix_map<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="1376"><highlight class="normal"></highlight></codeline>
<codeline lineno="1377"><highlight class="normal"><sp/><sp/>SPIFFS_UNLOCK(fs);</highlight></codeline>
<codeline lineno="1378"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>res;</highlight></codeline>
<codeline lineno="1379"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1380"><highlight class="normal"></highlight></codeline>
<codeline lineno="1381"><highlight class="normal">s32_t<sp/>SPIFFS_ix_remap(<ref refid="structspiffs__t" kindref="compound">spiffs</ref><sp/>*fs,<sp/>spiffs_file<sp/>fh,<sp/>u32_t<sp/>offset)<sp/>{</highlight></codeline>
<codeline lineno="1382"><highlight class="normal"><sp/><sp/>SPIFFS_API_DBG(</highlight><highlight class="stringliteral">&quot;%s<sp/>&quot;</highlight><highlight class="normal">_SPIPRIfd<sp/></highlight><highlight class="stringliteral">&quot;<sp/>&quot;</highlight><highlight class="normal">_SPIPRIi<sp/></highlight><highlight class="stringliteral">&quot;\n&quot;</highlight><highlight class="normal">,<sp/>__func__,<sp/>fh,<sp/>offset);</highlight></codeline>
<codeline lineno="1383"><highlight class="normal"><sp/><sp/>s32_t<sp/>res<sp/>=<sp/>SPIFFS_OK;</highlight></codeline>
<codeline lineno="1384"><highlight class="normal"><sp/><sp/>SPIFFS_API_CHECK_CFG(fs);</highlight></codeline>
<codeline lineno="1385"><highlight class="normal"><sp/><sp/>SPIFFS_API_CHECK_MOUNT(fs);</highlight></codeline>
<codeline lineno="1386"><highlight class="normal"><sp/><sp/>SPIFFS_LOCK(fs);</highlight></codeline>
<codeline lineno="1387"><highlight class="normal"></highlight></codeline>
<codeline lineno="1388"><highlight class="normal"><sp/><sp/>fh<sp/>=<sp/>SPIFFS_FH_UNOFFS(fs,<sp/>fh);</highlight></codeline>
<codeline lineno="1389"><highlight class="normal"></highlight></codeline>
<codeline lineno="1390"><highlight class="normal"><sp/><sp/><ref refid="structspiffs__fd" kindref="compound">spiffs_fd</ref><sp/>*fd;</highlight></codeline>
<codeline lineno="1391"><highlight class="normal"><sp/><sp/>res<sp/>=<sp/>spiffs_fd_get(fs,<sp/>fh,<sp/>&amp;fd);</highlight></codeline>
<codeline lineno="1392"><highlight class="normal"><sp/><sp/>SPIFFS_API_CHECK_RES_UNLOCK(fs,<sp/>res);</highlight></codeline>
<codeline lineno="1393"><highlight class="normal"></highlight></codeline>
<codeline lineno="1394"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(fd-&gt;ix_map<sp/>==<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="1395"><highlight class="normal"><sp/><sp/><sp/><sp/>SPIFFS_API_CHECK_RES_UNLOCK(fs,<sp/>SPIFFS_ERR_IX_MAP_UNMAPPED);</highlight></codeline>
<codeline lineno="1396"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="1397"><highlight class="normal"></highlight></codeline>
<codeline lineno="1398"><highlight class="normal"><sp/><sp/><ref refid="structspiffs__ix__map" kindref="compound">spiffs_ix_map</ref><sp/>*map<sp/>=<sp/>fd-&gt;ix_map;</highlight></codeline>
<codeline lineno="1399"><highlight class="normal"></highlight></codeline>
<codeline lineno="1400"><highlight class="normal"><sp/><sp/>s32_t<sp/>spix_diff<sp/>=<sp/>offset<sp/>/<sp/>SPIFFS_DATA_PAGE_SIZE(fs)<sp/>-<sp/>map-&gt;start_spix;</highlight></codeline>
<codeline lineno="1401"><highlight class="normal"><sp/><sp/>map-&gt;offset<sp/>=<sp/>offset;</highlight></codeline>
<codeline lineno="1402"><highlight class="normal"></highlight></codeline>
<codeline lineno="1403"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>move<sp/>existing<sp/>pixes<sp/>if<sp/>within<sp/>map<sp/>offs</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1404"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(spix_diff<sp/>!=<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="1405"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>move<sp/>vector</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1406"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>i;</highlight></codeline>
<codeline lineno="1407"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>s32_t<sp/>vec_len<sp/>=<sp/>map-&gt;end_spix<sp/>-<sp/>map-&gt;start_spix<sp/>+<sp/>1;<sp/></highlight><highlight class="comment">//<sp/>spix<sp/>range<sp/>includes<sp/>last</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1408"><highlight class="normal"><sp/><sp/><sp/><sp/>map-&gt;start_spix<sp/>+=<sp/>spix_diff;</highlight></codeline>
<codeline lineno="1409"><highlight class="normal"><sp/><sp/><sp/><sp/>map-&gt;end_spix<sp/>+=<sp/>spix_diff;</highlight></codeline>
<codeline lineno="1410"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(spix_diff<sp/>&gt;=<sp/>vec_len)<sp/>{</highlight></codeline>
<codeline lineno="1411"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>moving<sp/>beyond<sp/>range</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1412"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>memset(&amp;map-&gt;map_buf,<sp/>0,<sp/>vec_len<sp/>*<sp/></highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(spiffs_page_ix));</highlight></codeline>
<codeline lineno="1413"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>populate_ix_map<sp/>is<sp/>inclusive</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1414"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>res<sp/>=<sp/>spiffs_populate_ix_map(fs,<sp/>fd,<sp/>0,<sp/>vec_len-1);</highlight></codeline>
<codeline lineno="1415"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>SPIFFS_API_CHECK_RES_UNLOCK(fs,<sp/>res);</highlight></codeline>
<codeline lineno="1416"><highlight class="normal"><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(spix_diff<sp/>&gt;<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="1417"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>diff<sp/>positive</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1418"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>vec_len<sp/>-<sp/>spix_diff;<sp/>i++)<sp/>{</highlight></codeline>
<codeline lineno="1419"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>map-&gt;map_buf[i]<sp/>=<sp/>map-&gt;map_buf[i<sp/>+<sp/>spix_diff];</highlight></codeline>
<codeline lineno="1420"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1421"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>memset<sp/>is<sp/>non-inclusive</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1422"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>memset(&amp;map-&gt;map_buf[vec_len<sp/>-<sp/>spix_diff],<sp/>0,<sp/>spix_diff<sp/>*<sp/></highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(spiffs_page_ix));</highlight></codeline>
<codeline lineno="1423"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>populate_ix_map<sp/>is<sp/>inclusive</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1424"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>res<sp/>=<sp/>spiffs_populate_ix_map(fs,<sp/>fd,<sp/>vec_len<sp/>-<sp/>spix_diff,<sp/>vec_len-1);</highlight></codeline>
<codeline lineno="1425"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>SPIFFS_API_CHECK_RES_UNLOCK(fs,<sp/>res);</highlight></codeline>
<codeline lineno="1426"><highlight class="normal"><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="1427"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>diff<sp/>negative</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1428"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(i<sp/>=<sp/>vec_len<sp/>-<sp/>1;<sp/>i<sp/>&gt;=<sp/>-spix_diff;<sp/>i--)<sp/>{</highlight></codeline>
<codeline lineno="1429"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>map-&gt;map_buf[i]<sp/>=<sp/>map-&gt;map_buf[i<sp/>+<sp/>spix_diff];</highlight></codeline>
<codeline lineno="1430"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1431"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>memset<sp/>is<sp/>non-inclusive</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1432"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>memset(&amp;map-&gt;map_buf[0],<sp/>0,<sp/>-spix_diff<sp/>*<sp/></highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(spiffs_page_ix));</highlight></codeline>
<codeline lineno="1433"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>populate_ix_map<sp/>is<sp/>inclusive</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1434"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>res<sp/>=<sp/>spiffs_populate_ix_map(fs,<sp/>fd,<sp/>0,<sp/>-spix_diff<sp/>-<sp/>1);</highlight></codeline>
<codeline lineno="1435"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>SPIFFS_API_CHECK_RES_UNLOCK(fs,<sp/>res);</highlight></codeline>
<codeline lineno="1436"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1437"><highlight class="normal"></highlight></codeline>
<codeline lineno="1438"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="1439"><highlight class="normal"></highlight></codeline>
<codeline lineno="1440"><highlight class="normal"><sp/><sp/>SPIFFS_UNLOCK(fs);</highlight></codeline>
<codeline lineno="1441"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>res;</highlight></codeline>
<codeline lineno="1442"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1443"><highlight class="normal"></highlight></codeline>
<codeline lineno="1444"><highlight class="normal">s32_t<sp/>SPIFFS_bytes_to_ix_map_entries(<ref refid="structspiffs__t" kindref="compound">spiffs</ref><sp/>*fs,<sp/>u32_t<sp/>bytes)<sp/>{</highlight></codeline>
<codeline lineno="1445"><highlight class="normal"><sp/><sp/>SPIFFS_API_CHECK_CFG(fs);</highlight></codeline>
<codeline lineno="1446"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>always<sp/>add<sp/>one<sp/>extra<sp/>page,<sp/>the<sp/>offset<sp/>might<sp/>change<sp/>to<sp/>the<sp/>middle<sp/>of<sp/>a<sp/>page</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1447"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>(bytes<sp/>+<sp/>SPIFFS_DATA_PAGE_SIZE(fs)<sp/>)<sp/>/<sp/>SPIFFS_DATA_PAGE_SIZE(fs);</highlight></codeline>
<codeline lineno="1448"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1449"><highlight class="normal"></highlight></codeline>
<codeline lineno="1450"><highlight class="normal">s32_t<sp/>SPIFFS_ix_map_entries_to_bytes(<ref refid="structspiffs__t" kindref="compound">spiffs</ref><sp/>*fs,<sp/>u32_t<sp/>map_page_ix_entries)<sp/>{</highlight></codeline>
<codeline lineno="1451"><highlight class="normal"><sp/><sp/>SPIFFS_API_CHECK_CFG(fs);</highlight></codeline>
<codeline lineno="1452"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>map_page_ix_entries<sp/>*<sp/>SPIFFS_DATA_PAGE_SIZE(fs);</highlight></codeline>
<codeline lineno="1453"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1454"><highlight class="normal"></highlight></codeline>
<codeline lineno="1455"><highlight class="normal"></highlight><highlight class="preprocessor">#endif<sp/>//<sp/>SPIFFS_IX_MAP</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1456"><highlight class="normal"></highlight></codeline>
<codeline lineno="1457"><highlight class="normal"></highlight><highlight class="preprocessor">#if<sp/>SPIFFS_TEST_VISUALISATION</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1458"><highlight class="normal">s32_t<sp/>SPIFFS_vis(<ref refid="structspiffs__t" kindref="compound">spiffs</ref><sp/>*fs)<sp/>{</highlight></codeline>
<codeline lineno="1459"><highlight class="normal"><sp/><sp/>s32_t<sp/>res<sp/>=<sp/>SPIFFS_OK;</highlight></codeline>
<codeline lineno="1460"><highlight class="normal"><sp/><sp/>SPIFFS_API_CHECK_CFG(fs);</highlight></codeline>
<codeline lineno="1461"><highlight class="normal"><sp/><sp/>SPIFFS_API_CHECK_MOUNT(fs);</highlight></codeline>
<codeline lineno="1462"><highlight class="normal"><sp/><sp/>SPIFFS_LOCK(fs);</highlight></codeline>
<codeline lineno="1463"><highlight class="normal"></highlight></codeline>
<codeline lineno="1464"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>entries_per_page<sp/>=<sp/>(SPIFFS_CFG_LOG_PAGE_SZ(fs)<sp/>/<sp/></highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(spiffs_obj_id));</highlight></codeline>
<codeline lineno="1465"><highlight class="normal"><sp/><sp/>spiffs_obj_id<sp/>*obj_lu_buf<sp/>=<sp/>(spiffs_obj_id<sp/>*)fs-&gt;lu_work;</highlight></codeline>
<codeline lineno="1466"><highlight class="normal"><sp/><sp/>spiffs_block_ix<sp/>bix<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="1467"><highlight class="normal"></highlight></codeline>
<codeline lineno="1468"><highlight class="normal"><sp/><sp/>while<sp/>(bix<sp/>&lt;<sp/>fs-&gt;block_count)<sp/>{</highlight></codeline>
<codeline lineno="1469"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>check<sp/>each<sp/>object<sp/>lookup<sp/>page</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1470"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>obj_lookup_page<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="1471"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>cur_entry<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="1472"><highlight class="normal"></highlight></codeline>
<codeline lineno="1473"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">while</highlight><highlight class="normal"><sp/>(res<sp/>==<sp/>SPIFFS_OK<sp/>&amp;&amp;<sp/>obj_lookup_page<sp/>&lt;<sp/>(</highlight><highlight class="keywordtype">int</highlight><highlight class="normal">)SPIFFS_OBJ_LOOKUP_PAGES(fs))<sp/>{</highlight></codeline>
<codeline lineno="1474"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>entry_offset<sp/>=<sp/>obj_lookup_page<sp/>*<sp/>entries_per_page;</highlight></codeline>
<codeline lineno="1475"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>res<sp/>=<sp/>_spiffs_rd(fs,<sp/>SPIFFS_OP_T_OBJ_LU<sp/>|<sp/>SPIFFS_OP_C_READ,</highlight></codeline>
<codeline lineno="1476"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>0,<sp/>bix<sp/>*<sp/>SPIFFS_CFG_LOG_BLOCK_SZ(fs)<sp/>+<sp/>SPIFFS_PAGE_TO_PADDR(fs,<sp/>obj_lookup_page),<sp/>SPIFFS_CFG_LOG_PAGE_SZ(fs),<sp/>fs-&gt;lu_work);</highlight></codeline>
<codeline lineno="1477"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>check<sp/>each<sp/>entry</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1478"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">while</highlight><highlight class="normal"><sp/>(res<sp/>==<sp/>SPIFFS_OK<sp/>&amp;&amp;</highlight></codeline>
<codeline lineno="1479"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>cur_entry<sp/>-<sp/>entry_offset<sp/>&lt;<sp/>entries_per_page<sp/>&amp;&amp;<sp/>cur_entry<sp/>&lt;<sp/>(</highlight><highlight class="keywordtype">int</highlight><highlight class="normal">)(SPIFFS_PAGES_PER_BLOCK(fs)-SPIFFS_OBJ_LOOKUP_PAGES(fs)))<sp/>{</highlight></codeline>
<codeline lineno="1480"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>spiffs_obj_id<sp/>obj_id<sp/>=<sp/>obj_lu_buf[cur_entry-entry_offset];</highlight></codeline>
<codeline lineno="1481"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(cur_entry<sp/>==<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="1482"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>spiffs_printf(_SPIPRIbl</highlight><highlight class="stringliteral">&quot;<sp/>&quot;</highlight><highlight class="normal">,<sp/>bix);</highlight></codeline>
<codeline lineno="1483"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>((cur_entry<sp/>&amp;<sp/>0x3f)<sp/>==<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="1484"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>spiffs_printf(</highlight><highlight class="stringliteral">&quot;<sp/><sp/><sp/><sp/><sp/>&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="1485"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1486"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(obj_id<sp/>==<sp/>SPIFFS_OBJ_ID_FREE)<sp/>{</highlight></codeline>
<codeline lineno="1487"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>spiffs_printf(SPIFFS_TEST_VIS_FREE_STR);</highlight></codeline>
<codeline lineno="1488"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(obj_id<sp/>==<sp/>SPIFFS_OBJ_ID_DELETED)<sp/>{</highlight></codeline>
<codeline lineno="1489"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>spiffs_printf(SPIFFS_TEST_VIS_DELE_STR);</highlight></codeline>
<codeline lineno="1490"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(obj_id<sp/>&amp;<sp/>SPIFFS_OBJ_ID_IX_FLAG){</highlight></codeline>
<codeline lineno="1491"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>spiffs_printf(SPIFFS_TEST_VIS_INDX_STR(obj_id));</highlight></codeline>
<codeline lineno="1492"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="1493"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>spiffs_printf(SPIFFS_TEST_VIS_DATA_STR(obj_id));</highlight></codeline>
<codeline lineno="1494"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1495"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>cur_entry++;</highlight></codeline>
<codeline lineno="1496"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>((cur_entry<sp/>&amp;<sp/>0x3f)<sp/>==<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="1497"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>spiffs_printf(</highlight><highlight class="stringliteral">&quot;\n&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="1498"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1499"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="comment">//<sp/>per<sp/>entry</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1500"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>obj_lookup_page++;</highlight></codeline>
<codeline lineno="1501"><highlight class="normal"><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="comment">//<sp/>per<sp/>object<sp/>lookup<sp/>page</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1502"><highlight class="normal"></highlight></codeline>
<codeline lineno="1503"><highlight class="normal"><sp/><sp/><sp/><sp/>spiffs_obj_id<sp/>erase_count;</highlight></codeline>
<codeline lineno="1504"><highlight class="normal"><sp/><sp/><sp/><sp/>res<sp/>=<sp/>_spiffs_rd(fs,<sp/>SPIFFS_OP_C_READ<sp/>|<sp/>SPIFFS_OP_T_OBJ_LU2,<sp/>0,</highlight></codeline>
<codeline lineno="1505"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>SPIFFS_ERASE_COUNT_PADDR(fs,<sp/>bix),</highlight></codeline>
<codeline lineno="1506"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(spiffs_obj_id),<sp/>(u8_t<sp/>*)&amp;erase_count);</highlight></codeline>
<codeline lineno="1507"><highlight class="normal"><sp/><sp/><sp/><sp/>SPIFFS_CHECK_RES(res);</highlight></codeline>
<codeline lineno="1508"><highlight class="normal"></highlight></codeline>
<codeline lineno="1509"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(erase_count<sp/>!=<sp/>(spiffs_obj_id)-1)<sp/>{</highlight></codeline>
<codeline lineno="1510"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>spiffs_printf(</highlight><highlight class="stringliteral">&quot;\tera_cnt:<sp/>&quot;</highlight><highlight class="normal">_SPIPRIi</highlight><highlight class="stringliteral">&quot;\n&quot;</highlight><highlight class="normal">,<sp/>erase_count);</highlight></codeline>
<codeline lineno="1511"><highlight class="normal"><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="1512"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>spiffs_printf(</highlight><highlight class="stringliteral">&quot;\tera_cnt:<sp/>N/A\n&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="1513"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1514"><highlight class="normal"></highlight></codeline>
<codeline lineno="1515"><highlight class="normal"><sp/><sp/><sp/><sp/>bix++;</highlight></codeline>
<codeline lineno="1516"><highlight class="normal"><sp/><sp/>}<sp/></highlight><highlight class="comment">//<sp/>per<sp/>block</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1517"><highlight class="normal"></highlight></codeline>
<codeline lineno="1518"><highlight class="normal"><sp/><sp/>spiffs_printf(</highlight><highlight class="stringliteral">&quot;era_cnt_max:<sp/>&quot;</highlight><highlight class="normal">_SPIPRIi</highlight><highlight class="stringliteral">&quot;\n&quot;</highlight><highlight class="normal">,<sp/>fs-&gt;max_erase_count);</highlight></codeline>
<codeline lineno="1519"><highlight class="normal"><sp/><sp/>spiffs_printf(</highlight><highlight class="stringliteral">&quot;last_errno:<sp/><sp/>&quot;</highlight><highlight class="normal">_SPIPRIi</highlight><highlight class="stringliteral">&quot;\n&quot;</highlight><highlight class="normal">,<sp/>fs-&gt;err_code);</highlight></codeline>
<codeline lineno="1520"><highlight class="normal"><sp/><sp/>spiffs_printf(</highlight><highlight class="stringliteral">&quot;blocks:<sp/><sp/><sp/><sp/><sp/><sp/>&quot;</highlight><highlight class="normal">_SPIPRIi</highlight><highlight class="stringliteral">&quot;\n&quot;</highlight><highlight class="normal">,<sp/>fs-&gt;block_count);</highlight></codeline>
<codeline lineno="1521"><highlight class="normal"><sp/><sp/>spiffs_printf(</highlight><highlight class="stringliteral">&quot;free_blocks:<sp/>&quot;</highlight><highlight class="normal">_SPIPRIi</highlight><highlight class="stringliteral">&quot;\n&quot;</highlight><highlight class="normal">,<sp/>fs-&gt;free_blocks);</highlight></codeline>
<codeline lineno="1522"><highlight class="normal"><sp/><sp/>spiffs_printf(</highlight><highlight class="stringliteral">&quot;page_alloc:<sp/><sp/>&quot;</highlight><highlight class="normal">_SPIPRIi</highlight><highlight class="stringliteral">&quot;\n&quot;</highlight><highlight class="normal">,<sp/>fs-&gt;stats_p_allocated);</highlight></codeline>
<codeline lineno="1523"><highlight class="normal"><sp/><sp/>spiffs_printf(</highlight><highlight class="stringliteral">&quot;page_delet:<sp/><sp/>&quot;</highlight><highlight class="normal">_SPIPRIi</highlight><highlight class="stringliteral">&quot;\n&quot;</highlight><highlight class="normal">,<sp/>fs-&gt;stats_p_deleted);</highlight></codeline>
<codeline lineno="1524"><highlight class="normal"><sp/><sp/>SPIFFS_UNLOCK(fs);</highlight></codeline>
<codeline lineno="1525"><highlight class="normal"><sp/><sp/>u32_t<sp/>total,<sp/>used;</highlight></codeline>
<codeline lineno="1526"><highlight class="normal"><sp/><sp/>SPIFFS_info(fs,<sp/>&amp;total,<sp/>&amp;used);</highlight></codeline>
<codeline lineno="1527"><highlight class="normal"><sp/><sp/>spiffs_printf(</highlight><highlight class="stringliteral">&quot;used:<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>&quot;</highlight><highlight class="normal">_SPIPRIi</highlight><highlight class="stringliteral">&quot;<sp/>of<sp/>&quot;</highlight><highlight class="normal">_SPIPRIi</highlight><highlight class="stringliteral">&quot;\n&quot;</highlight><highlight class="normal">,<sp/>used,<sp/>total);</highlight></codeline>
<codeline lineno="1528"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>res;</highlight></codeline>
<codeline lineno="1529"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1530"><highlight class="normal"></highlight><highlight class="preprocessor">#endif</highlight></codeline>
    </programlisting>
    <location file="src/spiffs_hydrogen.c"/>
  </compounddef>
</doxygen>
